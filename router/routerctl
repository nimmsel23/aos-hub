#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# routerctl — AlphaOS Router Manager (Arch/yay/gum)
# ============================================================
# Source of Truth: this file (repo-local). Optional: install a symlink into PATH.
#
# Changelog:
# - 0.3.0: Router v2 (Dumb Core + Extensions), config.yaml support
# - 0.3.1: Heartbeat delegated to aos-hub/scripts/heartbeat (routerctl keeps a thin wrapper)
#
ROUTERCTL_VERSION="0.3.1"

# =========================
# Repo paths
# =========================
SCRIPT_DIR="$(cd -- "$(dirname -- "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
ROOT_DIR="$(cd -- "$SCRIPT_DIR/.." && pwd -P)"
HEARTBEAT_BIN="${HEARTBEAT_BIN:-$ROOT_DIR/scripts/heartbeat}"
# shellcheck disable=SC1090
source "$ROOT_DIR/scripts/ctl-lib.sh"
: "${CTL_CHOOSE_PROMPT:=routerctl}"
: "${CTL_CHOOSE_PREFER:=gum}"
: "${CTL_UI_OK_PREFIX:=✔}"
: "${CTL_UI_ERR_PREFIX:=✘}"
: "${CTL_UI_WARN_PREFIX:=⚠}"

# =========================
# Router (aiogram bot)
# =========================
ROUTER_NAME="${ROUTER_NAME:-alphaos-router}"
ROUTER_DIR="${ROUTER_DIR:-$SCRIPT_DIR}"
PY_ENTRY="${PY_ENTRY:-router_bot.py}"

USE_VENV="${USE_VENV:-0}"           # 0 = system python, 1 = venv (optional)
VENV_DIR="${VENV_DIR:-$ROUTER_DIR/.venv}"

ENV_FILE="${ENV_FILE:-$ROUTER_DIR/.env}"
AOS_ENV_FILE="${AOS_ENV_FILE:-$HOME/.env/aos.env}"
TELE_ENV_FILE="${TELE_ENV_FILE:-$HOME/.env/tele.env}"
SYSTEMD_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
UNIT_FILE="$SYSTEMD_DIR/$ROUTER_NAME.service"

# =========================
# Heartbeat (fixed GAS WebApp URL)
# =========================
HB_NAME="${HB_NAME:-alphaos-heartbeat}"
HB_URL="${HB_URL:-https://script.google.com/macros/s/AKfycbysk1LEX9r05qiKKvNevayAc8OSESqItpWDbKhepBJjOdEcx8Cav4MGVqyCXsjcv9Chmw/exec}"
HB_HOST="${HB_HOST:-$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo unknown)}"
HB_BOOT_DELAY="${HB_BOOT_DELAY:-30s}"
HB_INTERVAL="${HB_INTERVAL:-2min}"
HB_SYSTEMD_DIR="$SYSTEMD_DIR"
HB_SERVICE_FILE="$HB_SYSTEMD_DIR/$HB_NAME.service"
HB_TIMER_FILE="$HB_SYSTEMD_DIR/$HB_NAME.timer"

trap 'ui_err "Failed at line $LINENO"; exit 1' ERR

abs_path() {
  local p="$1"
  if command -v realpath >/dev/null 2>&1; then
    realpath -m -- "$p"
    return 0
  fi
  if command -v readlink >/dev/null 2>&1; then
    readlink -f -- "$p" 2>/dev/null && return 0
  fi
  [[ "$p" = /* ]] && echo "$p" || echo "$PWD/$p"
}

install_path_hint() {
  local target="$1"
  local dir; dir="$(dirname -- "$target")"
  ui_info "Installed: $target"
  case ":$PATH:" in
    *":$dir:"*) ;;
    *)
      ui_info "Note: $dir is not in PATH. Add to shell rc, e.g.:"
      ui_info "  export PATH=\"$dir:\$PATH\""
      ;;
  esac
}

install_cli() {
  local bin_dir="${ROUTERCTL_BIN_DIR:-$HOME/.local/bin}"
  local dst="$bin_dir/routerctl"
  local src="$SCRIPT_DIR/routerctl"
  mkdir -p "$bin_dir" 2>/dev/null || {
    ui_err "Cannot create bin dir: $bin_dir"
    ui_info "Set ROUTERCTL_BIN_DIR to a writable directory, e.g.:"
    ui_info "  ROUTERCTL_BIN_DIR=$ROUTER_DIR/.bin ./routerctl install-cli"
    exit 1
  }
  if [[ -e "$dst" && ! -L "$dst" ]]; then
    ui_err "Refusing to overwrite non-symlink: $dst"
    ui_info "Move it away first, then re-run: routerctl install-cli"
    exit 1
  fi
  ln -sf "$src" "$dst"
  ui_ok "Symlinked routerctl into PATH."
  install_path_hint "$dst"
}

uninstall_cli() {
  local bin_dir="${ROUTERCTL_BIN_DIR:-$HOME/.local/bin}"
  local dst="$bin_dir/routerctl"
  if [[ -L "$dst" ]]; then
    rm -f "$dst"
    ui_ok "Removed: $dst"
    return 0
  fi
  ui_info "Nothing to remove at: $dst"
}

system_python() {
  local py=""
  py="$(command -v python 2>/dev/null || true)"
  [[ -n "$py" ]] || py="$(command -v python3 2>/dev/null || true)"
  [[ -n "$py" ]] || { ui_err "Missing: python/python3"; exit 1; }
  abs_path "$py"
}

# Normalize defaults so `routerctl` works from any CWD.
ROUTER_DIR="$(abs_path "$ROUTER_DIR")"
VENV_DIR="$(abs_path "${VENV_DIR:-$ROUTER_DIR/.venv}")"
ENV_FILE="$(abs_path "${ENV_FILE:-$ROUTER_DIR/.env}")"
[[ -n "${AOS_ENV_FILE:-}" ]] && AOS_ENV_FILE="$(abs_path "${AOS_ENV_FILE:-$HOME/.env/aos.env}")"
TELE_ENV_FILE="$(abs_path "${TELE_ENV_FILE:-$HOME/.env/tele.env}")"
if [[ -d "$ENV_FILE" ]]; then
  if [[ -f "$ENV_FILE/aos.env" ]]; then
    ENV_FILE="$ENV_FILE/aos.env"
  elif [[ -f "$ENV_FILE/router.env" ]]; then
    ENV_FILE="$ENV_FILE/router.env"
  else
    ENV_FILE="$ENV_FILE/router.env"
  fi
fi
if [[ -z "${ROUTER_CONFIG:-}" && -f "$ROUTER_DIR/config.yaml" ]]; then
  ROUTER_CONFIG="$ROUTER_DIR/config.yaml"
fi

# =========================
# Arch deps
# =========================
install_deps() {
  need_cmd sudo
  need_cmd pacman
  need_cmd yay

  ui_info "Installing deps (pacman + yay)…"
  sudo pacman -S --needed --noconfirm python python-aiohttp curl >/dev/null

  # AUR: aiogram
  yay -S --needed --noconfirm python-aiogram >/dev/null

  # dotenv optional
  if grep -q "dotenv" "$ROUTER_DIR/$PY_ENTRY" 2>/dev/null; then
    yay -S --needed --noconfirm python-python-dotenv >/dev/null || true
  fi

  # gum optional (UX); do not hard fail
  if ! command -v gum >/dev/null 2>&1; then
    ui_info "Note: gum not found. Optional UX. Install with: sudo pacman -S gum"
  fi

  ui_ok "Deps installed."
}

# =========================
# venv optional
# =========================
ensure_venv() {
  [[ "$USE_VENV" == "1" ]] || return 0
  if [[ ! -d "$VENV_DIR" ]]; then
    ui_info "Creating venv: $VENV_DIR (system-site-packages)"
    "$(system_python)" -m venv "$VENV_DIR" --system-site-packages
  fi
}

python_exec() {
  if [[ "$USE_VENV" == "1" ]]; then
    echo "$(abs_path "$VENV_DIR/bin/python")"
  else
    system_python
  fi
}

# =========================
# Router: env + unit
# =========================
write_env_file() {
  if [[ -f "$ENV_FILE" ]]; then return 0; fi
  mkdir -p "$(dirname -- "$ENV_FILE")"
  cat >"$ENV_FILE" <<'EOF'
# Telegram Bot Configuration
# TELEGRAM_BOT_TOKEN=   # optional if TELE_ENV_FILE already provides it (e.g. ~/.env/tele.env)
ALLOWED_USER_ID=

# Fruits daily overrides (optional)
# FRUITS_API_BASE=http://127.0.0.1:8799
# FRUITS_WEB_URL=http://127.0.0.1:8799/facts
# FRUITS_DEFAULT_CHAT_ID=
# FRUITS_DAILY_HOUR=7
# FRUITS_DAILY_MINUTE=0
# FRUITS_TIMEZONE=Europe/Vienna

# Bridge health overrides (optional)
# BRIDGE_HEALTH_URL=http://100.76.197.55:8080/health
# BRIDGE_HEALTH_TIMEOUT=3

# Router Configuration (optional - config.yaml is preferred)
# ROUTER_CONFIG=/path/to/custom/config.yaml
EOF
  chmod 600 "$ENV_FILE"
  ui_ok "Created .env at: $ENV_FILE"
}

write_unit() {
  local force=0
  local dry_run=0
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -f|--force) force=1 ;;
      -n|--dry-run|--print) dry_run=1 ;;
      -h|--help)
        ui_info "Usage: routerctl unit [--dry-run] [--force]"
        ui_info "  --dry-run/--print  Print unit to stdout (no writes)."
        ui_info "  --force            Overwrite existing unit without prompt (still backs up)."
        return 0
        ;;
      *)
        ui_err "Unknown option for unit: $1"
        return 2
        ;;
    esac
    shift
  done

  mkdir -p "$SYSTEMD_DIR"
  write_env_file
  ensure_venv

  local py; py="$(python_exec)"
  local tele_env_line=""
  local aos_env_line=""
  if [[ -n "${AOS_ENV_FILE:-}" && "$AOS_ENV_FILE" != "$ENV_FILE" ]]; then
    aos_env_line="EnvironmentFile=-$AOS_ENV_FILE"
  fi
  if [[ -n "${TELE_ENV_FILE:-}" && "$TELE_ENV_FILE" != "$ENV_FILE" ]]; then
    tele_env_line="EnvironmentFile=-$TELE_ENV_FILE"
  fi

  local tmp
  tmp="$(mktemp "${TMPDIR:-/tmp}/routerctl.unit.XXXXXX")"
  cat >"$tmp" <<EOF
# Generated by routerctl. For persistent overrides, use:
#   systemctl --user edit $ROUTER_NAME.service
[Unit]
Description=AlphaOS Router (aiogram)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
WorkingDirectory=$ROUTER_DIR
$aos_env_line
$tele_env_line
EnvironmentFile=$ENV_FILE
${ROUTER_CONFIG:+Environment=ROUTER_CONFIG=$ROUTER_CONFIG}
ExecStart=$py $PY_ENTRY
Restart=on-failure
RestartSec=2

# Hardening (user-safe)
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=full
ProtectHome=read-only
ReadWritePaths=$ROUTER_DIR

[Install]
WantedBy=default.target
EOF

  if [[ "$dry_run" == "1" ]]; then
    cat "$tmp"
    rm -f "$tmp"
    return 0
  fi

  if [[ -f "$UNIT_FILE" ]]; then
    if command -v cmp >/dev/null 2>&1 && cmp -s "$tmp" "$UNIT_FILE"; then
      rm -f "$tmp"
      ui_ok "Unit already up to date: $UNIT_FILE"
      if command -v systemctl >/dev/null 2>&1; then
        systemctl --user daemon-reload >/dev/null 2>&1 || true
      fi
      return 0
    fi

    ui_warn "Unit already exists: $UNIT_FILE"
    if command -v diff >/dev/null 2>&1; then
      ui_info "Diff (current -> new):"
      diff -u "$UNIT_FILE" "$tmp" || true
    fi

    if [[ "$force" != "1" ]]; then
      if ! ui_confirm "Overwrite existing unit? (backup will be created)"; then
        rm -f "$tmp"
        ui_info "Aborted."
        return 1
      fi
    fi

    local ts backup
    ts="$(date +%Y%m%d-%H%M%S)"
    backup="$UNIT_FILE.bak.$ts"
    cp -a "$UNIT_FILE" "$backup"
    ui_ok "Backup created: $backup"
  fi

  install -m 0644 "$tmp" "$UNIT_FILE"
  rm -f "$tmp"

  if command -v systemctl >/dev/null 2>&1; then
    systemctl --user daemon-reload >/dev/null 2>&1 || true
  fi
  ui_ok "Wrote unit: $UNIT_FILE"
}

unit_candidates() {
  printf '%s\n' "$UNIT_FILE"
}

unit_choose_path() {
  local paths=()
  mapfile -t paths < <(unit_candidates)
  if [[ ${#paths[@]} -eq 1 ]]; then
    echo "${paths[0]}"
    return
  fi
  ui_choose "Select unit file" "${paths[@]}"
}

unit_edit() {
  local path
  path="$(unit_choose_path)"
  if [[ ! -f "$path" ]]; then
    ui_info "Unit not found; creating: $UNIT_FILE"
    write_unit
    path="$UNIT_FILE"
  fi
  "${EDITOR:-nano}" "$path"
  if command -v systemctl >/dev/null 2>&1; then
    systemctl --user daemon-reload >/dev/null 2>&1 || true
    ui_ok "Reloaded systemd user daemon."
  else
    ui_warn "systemctl not found; skipped daemon-reload."
  fi
}

unit_path() {
  local path
  path="$(unit_choose_path)"
  ui_info "Unit path: $path"
}

start_svc()   { systemctl --user start    "$ROUTER_NAME.service"; ui_ok "Router started."; }
stop_svc()    { systemctl --user stop     "$ROUTER_NAME.service"; ui_ok "Router stopped."; }
restart_svc() { systemctl --user restart  "$ROUTER_NAME.service"; ui_ok "Router restarted."; }
status_svc()  { systemctl --user status   "$ROUTER_NAME.service" --no-pager; }
logs_svc()    { journalctl --user -u "$ROUTER_NAME.service" -n 200 -f; }
enable_svc()  { systemctl --user enable   "$ROUTER_NAME.service"; ui_ok "Router enabled."; }
disable_svc() { systemctl --user disable  "$ROUTER_NAME.service"; ui_ok "Router disabled."; }

edit_env() {
  write_env_file
  "${EDITOR:-nano}" "$ENV_FILE"
}

install_all() {
  ui_title "routerctl"
  install_deps
  write_unit
  enable_svc
  ui_ok "Router install complete."
  ui_info "Next: routerctl edit-env  (set TELEGRAM_BOT_TOKEN)"
  ui_info "Then: routerctl start"
  if ui_confirm "Install Heartbeat now?"; then
    heartbeat_install
  fi
}

# =========================
# Heartbeat wrapper (delegated)
# =========================
heartbeat_cmd() {
  if [[ -x "$HEARTBEAT_BIN" ]]; then
    echo "$HEARTBEAT_BIN"
    return 0
  fi
  if command -v heartbeat >/dev/null 2>&1; then
    command -v heartbeat
    return 0
  fi
  return 1
}

heartbeat_run() {
  local bin
  bin="$(heartbeat_cmd)" || { ui_err "Heartbeat not installed (missing: $HEARTBEAT_BIN)"; return 1; }
  "$bin" "$@"
}

heartbeat_install()   { heartbeat_run install; }
heartbeat_uninstall() { heartbeat_run uninstall; }
heartbeat_start()     { heartbeat_run start; }
heartbeat_stop()      { heartbeat_run stop; }
heartbeat_status()    { heartbeat_run status; }
heartbeat_logs()      { heartbeat_run logs; }
heartbeat_ping()      { heartbeat_run ping; }

# =========================
# doctor
# =========================
doctor() {
  ui_title "routerctl doctor"
  ui_info "routerctl version : $ROUTERCTL_VERSION"

  ui_info "ROUTER_NAME: $ROUTER_NAME"
  ui_info "ROUTER_DIR : $ROUTER_DIR"
  ui_info "PY_ENTRY   : $PY_ENTRY"
  ui_info "USE_VENV   : $USE_VENV"
  ui_info "ENV_FILE   : $ENV_FILE"
  ui_info "AOS_ENV    : ${AOS_ENV_FILE:-}"
  ui_info "TELE_ENV   : $TELE_ENV_FILE"
  ui_info "UNIT_FILE  : $UNIT_FILE"

  ui_info "HB_NAME    : $HB_NAME"
  ui_info "HB_URL     : $HB_URL"
  ui_info "HB_HOST    : $HB_HOST"
  ui_info "HB_SERVICE : $HB_SERVICE_FILE"
  ui_info "HB_TIMER   : $HB_TIMER_FILE"

  need_cmd systemctl
  need_cmd journalctl
  need_cmd curl
  system_python >/dev/null

  [[ -f "$ROUTER_DIR/$PY_ENTRY" ]] || { ui_err "Missing: $ROUTER_DIR/$PY_ENTRY"; exit 1; }

  if [[ "$USE_VENV" == "1" ]]; then
    ensure_venv
    [[ -x "$VENV_DIR/bin/python" ]] || { ui_err "venv python missing"; exit 1; }
  fi

  # =========================
  # Router-specific checks
  # =========================
  env_has_var() {
    local file="$1"
    local key="$2"
    [[ -f "$file" ]] || return 1
    grep -Eq "^[[:space:]]*(export[[:space:]]+)?${key}=[[:space:]]*[^[:space:]#]+" "$file"
  }

  if [[ -e "$ENV_FILE" && ! -f "$ENV_FILE" ]]; then
    ui_err "ENV_FILE exists but is not a file: $ENV_FILE"
  elif [[ -f "$ENV_FILE" ]]; then
    ui_ok ".env present."
  else
    ui_info ".env missing (run: routerctl edit-env)"
  fi

  local token_source=""
  if env_has_var "$ENV_FILE" "TELEGRAM_BOT_TOKEN"; then
    token_source="$ENV_FILE"
  elif [[ -n "${AOS_ENV_FILE:-}" ]] && env_has_var "$AOS_ENV_FILE" "TELEGRAM_BOT_TOKEN"; then
    token_source="$AOS_ENV_FILE"
  elif env_has_var "$TELE_ENV_FILE" "TELEGRAM_BOT_TOKEN"; then
    token_source="$TELE_ENV_FILE"
  fi
  if [[ -n "$token_source" ]]; then
    ui_ok "TELEGRAM_BOT_TOKEN set (from: $token_source)"
  else
    ui_info "TELEGRAM_BOT_TOKEN missing/empty (set in: $ENV_FILE or $TELE_ENV_FILE)"
  fi

  local cfg_path=""
  if [[ -n "${ROUTER_CONFIG:-}" ]]; then
    cfg_path="$(abs_path "$ROUTER_CONFIG")"
  else
    cfg_path="$ROUTER_DIR/config.yaml"
  fi

  if [[ -f "$cfg_path" ]]; then
    ui_ok "Config present: $cfg_path"
    # Best-effort parse without yaml deps.
    local index_base="" index_path=""
    index_base="$(grep -E '^[[:space:]]*base:[[:space:]]*' "$cfg_path" | head -n 1 | sed -E "s/^[[:space:]]*base:[[:space:]]*//; s/[[:space:]]*#.*$//; s/[[:space:]]+$//; s/^['\"]//; s/['\"]$//")"
    index_path="$(grep -E '^[[:space:]]*path:[[:space:]]*' "$cfg_path" | head -n 1 | sed -E "s/^[[:space:]]*path:[[:space:]]*//; s/[[:space:]]*#.*$//; s/[[:space:]]+$//; s/^['\"]//; s/['\"]$//")"
    index_path="${index_path:-/api/centres}"

    if [[ -n "$index_base" ]]; then
      local url="${index_base%/}${index_path}"
      if curl -fsS -o /dev/null "$url" >/dev/null 2>&1; then
        ui_ok "Index API reachable: $url"
      else
        ui_info "Index API not reachable: $url"
      fi
    else
      ui_info "Index API base not found in config (index_api.base)."
    fi
  else
    ui_info "Config missing: $cfg_path"
  fi

  local py; py="$(python_exec)"
  if "$py" - <<'PY' >/dev/null 2>&1
import importlib.util
assert importlib.util.find_spec("aiogram")
PY
  then
    ui_ok "Python dep OK: aiogram"
  else
    ui_info "Python dep missing: aiogram"
  fi

  # soft checks (no exit):
  if [[ -f "$UNIT_FILE" ]]; then ui_ok "Router unit present."
  else ui_info "Router unit not present (run: routerctl unit)"; fi

  if heartbeat_cmd >/dev/null 2>&1; then
    if [[ -f "$HB_TIMER_FILE" && -f "$HB_SERVICE_FILE" ]]; then
      ui_ok "Heartbeat units present."
    else
      ui_info "Heartbeat units not present (run: heartbeat install)"
    fi
    if heartbeat_run ping >/dev/null 2>&1; then
      ui_ok "Heartbeat endpoint reachable."
    else
      ui_info "Heartbeat endpoint not reachable (could be deploy/auth/redirect)."
    fi
  else
    ui_info "Heartbeat not installed (optional): $HEARTBEAT_BIN"
  fi

  ui_ok "Doctor OK."
}

# =========================
# menu
# =========================
menu() {
  ui_title "routerctl"
  local action
  action="$(choose \
    "install" "deps" "unit" \
    "unit edit" "unit path" \
    "edit-env" \
    "start" "stop" "restart" "status" "logs" \
    "enable" "disable" \
    "heartbeat install" "heartbeat status" "heartbeat logs" "heartbeat ping" "heartbeat uninstall" \
    "doctor" "version" "quit")"

  case "$action" in
    install)  install_all ;;
    deps)     install_deps ;;
    unit)     write_unit ;;
    "unit edit") unit_edit ;;
    "unit path") unit_path ;;
    edit-env) edit_env ;;
    start)    start_svc ;;
    stop)     stop_svc ;;
    restart)  restart_svc ;;
    status)   status_svc ;;
    logs)     logs_svc ;;
    enable)   enable_svc ;;
    disable)  disable_svc ;;
    "heartbeat install")   heartbeat_install ;;
    "heartbeat status")    heartbeat_status ;;
    "heartbeat logs")      heartbeat_logs ;;
    "heartbeat ping")      heartbeat_ping ;;
    "heartbeat uninstall") heartbeat_uninstall ;;
    doctor)   doctor ;;
    version)  echo "$ROUTERCTL_VERSION" ;;
    quit)     exit 0 ;;
  esac
}

# =========================
# main
# =========================
print_help() {
  cat <<EOF
routerctl (Arch/yay/gum) — version $ROUTERCTL_VERSION

AlphaOS Router v2: Dumb Core + Extension System
  - Core: URL routing from Index API
  - Extensions: Modular functionality (Core4, etc.)
  - Config: config.yaml (extensions, Index API)

Usage:
  routerctl                # interactive menu
  routerctl version
  routerctl install-cli    # symlink into ~/.local/bin/routerctl
  routerctl uninstall-cli  # remove symlink from ~/.local/bin/routerctl

Router:
  routerctl install        # full setup (deps + unit + enable)
  routerctl deps           # install system dependencies
  routerctl unit           # generate systemd user unit (prompts before overwrite)
  routerctl unit --dry-run # print unit to stdout
  routerctl unit --force   # overwrite existing unit (backs up)
  routerctl unit enable    # generate unit + enable service
  routerctl unit start     # generate unit + start service
  routerctl unit restart   # generate unit + restart service
  routerctl unit-edit      # open unit file (auto-pick)
  routerctl unit-path      # show unit file path
  routerctl edit-env       # edit .env (bot token)
  routerctl start|stop|restart|status|logs
  routerctl enable|disable
  routerctl doctor         # health check

Heartbeat:
  routerctl heartbeat <cmd>   # wrapper (delegates to aos-hub/scripts/heartbeat)
  heartbeat <cmd>             # preferred direct call (if in PATH)
  hubctl heartbeat <cmd>      # preferred hub wrapper

Configuration:
  .env          - Secrets (TELEGRAM_BOT_TOKEN)
  config.yaml   - Extensions, Index API, extension configs

Optional env:
  ROUTER_DIR=/path routerctl unit
  USE_VENV=1 routerctl unit
  HB_URL=https://... heartbeat ping
EOF
}

print_heartbeat_help() {
  cat <<'EOF'
Usage:
  # Preferred:
  heartbeat install|uninstall|start|stop|status|logs|ping

  # Wrapper:
  routerctl heartbeat install|uninstall|start|stop|status|logs|ping
EOF
}

main() {
  if [[ $# -eq 0 ]]; then
    menu
    exit 0
  fi

  case "${1:-}" in
    -h|--help|help) print_help; exit 0 ;;
    version) echo "$ROUTERCTL_VERSION" ;;
    install-cli) install_cli ;;
    uninstall-cli) uninstall_cli ;;
    install)  install_all ;;
    deps)     install_deps ;;
    unit)
      case "${2:-}" in
        ""|-* ) write_unit "${@:2}" ;;
        enable)
          for a in "${@:3}"; do [[ "$a" == "-n" || "$a" == "--dry-run" || "$a" == "--print" ]] && { ui_err "--dry-run is not valid with: unit enable"; exit 2; }; done
          write_unit "${@:3}"
          enable_svc
          ;;
        start)
          for a in "${@:3}"; do [[ "$a" == "-n" || "$a" == "--dry-run" || "$a" == "--print" ]] && { ui_err "--dry-run is not valid with: unit start"; exit 2; }; done
          write_unit "${@:3}"
          start_svc
          ;;
        restart)
          for a in "${@:3}"; do [[ "$a" == "-n" || "$a" == "--dry-run" || "$a" == "--print" ]] && { ui_err "--dry-run is not valid with: unit restart"; exit 2; }; done
          write_unit "${@:3}"
          restart_svc
          ;;
        *)
          ui_err "Unknown unit subcommand: ${2:-}"
          print_help
          exit 1
          ;;
      esac
      ;;
    unit-edit) unit_edit ;;
    unit-path) unit_path ;;
    edit-env) edit_env ;;
    start)    start_svc ;;
    stop)     stop_svc ;;
    restart)  restart_svc ;;
    status)   status_svc ;;
    logs)     logs_svc ;;
    enable)   enable_svc ;;
    disable)  disable_svc ;;
    doctor)   doctor ;;
    heartbeat)
      case "${2:-}" in
        install)   heartbeat_install ;;
        uninstall) heartbeat_uninstall ;;
        start)     heartbeat_start ;;
        stop)      heartbeat_stop ;;
        status)    heartbeat_status ;;
        logs)      heartbeat_logs ;;
        ping)      heartbeat_ping ;;
        *)
          print_heartbeat_help; exit 1
          ;;
      esac
      ;;
    *)
      print_help; exit 1
      ;;
  esac
}

main "$@"
