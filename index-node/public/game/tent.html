<!DOCTYPE html>
<html lang="de">
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GENERAL‚ÄôS TENT ‚Äì Alpha Odyssey</title>
  <link rel="stylesheet" href="/vendor/xterm/xterm.css" />

  <style>
    :root {
      --bg: #07000f;
      --panel: rgba(26, 0, 40, 0.92);
      --panel2: rgba(12, 0, 18, 0.88);
      --border: rgba(155, 89, 182, 0.75);
      --text: #eadcf5;
      --muted: rgba(234, 220, 245, 0.70);

      --accent: #bb86fc;      /* royal flame */
      --accent2: #8e44ad;     /* deep purple */
      --gold: #d7b46a;        /* counsel / divine */
      --glow: rgba(155, 89, 182, 0.55);
      --shadow: rgba(0,0,0,0.65);

      --danger: #ff5c8a;
      --ok: #63ffdb;
      --warn: #ffd166;

      --radius: 22px;
      --radius2: 28px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(187,134,252,0.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(142,68,173,0.22), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(155,89,182,0.18), transparent 60%),
        linear-gradient(180deg, #040008 0%, #07000f 45%, #05000a 100%);
      overflow-x: hidden;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.55);
      border-bottom: 1px solid rgba(187,134,252,0.25);
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .topbar {
      max-width: 1240px;
      margin: 0 auto;
      padding: 16px 18px;
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }
    .sigil {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(187,134,252,0.55);
      background:
        radial-gradient(circle at 30% 30%, rgba(187,134,252,0.45), rgba(142,68,173,0.25) 55%, rgba(0,0,0,0.3) 100%);
      box-shadow: 0 0 35px var(--glow), inset 0 0 25px rgba(0,0,0,0.55);
      position: relative;
      overflow: hidden;
    }
    .sigil:after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 180deg, rgba(187,134,252,0.0), rgba(187,134,252,0.35), rgba(187,134,252,0.0));
      animation: spin 6s linear infinite;
      opacity: 0.75;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .titlewrap { min-width: 0; }
    .title {
      font-weight: 950;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin: 0;
      font-size: 14px;
      color: rgba(234, 220, 245, 0.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill {
      border: 1px solid rgba(187,134,252,0.35);
      background: rgba(26,0,40,0.35);
      color: rgba(234, 220, 245, 0.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 24px rgba(155,89,182,0.18);
      user-select: none;
    }
    .btn {
      cursor: pointer;
      border: 1px solid rgba(187,134,252,0.35);
      background: linear-gradient(135deg, rgba(187,134,252,0.26), rgba(142,68,173,0.12));
      color: rgba(234,220,245,0.95);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      box-shadow: 0 0 35px rgba(155,89,182,0.24);
    }
    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(187,134,252,0.65);
      box-shadow: 0 0 55px rgba(155,89,182,0.38);
    }

    main {
      max-width: 1240px;
      margin: 0 auto;
      padding: 26px 18px 70px;
    }

    .hero {
      margin-top: 10px;
      border-radius: var(--radius2);
      padding: 26px;
      border: 1px solid rgba(187,134,252,0.30);
      background:
        radial-gradient(900px 300px at 20% 10%, rgba(187,134,252,0.16), transparent 60%),
        radial-gradient(700px 260px at 80% 20%, rgba(142,68,173,0.22), transparent 60%),
        linear-gradient(135deg, rgba(26,0,40,0.82), rgba(10,0,16,0.88));
      box-shadow: 0 30px 90px rgba(0,0,0,0.55), 0 0 70px rgba(155,89,182,0.18);
      overflow: hidden;
      position: relative;
    }
    .hero:before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 60% 0%, rgba(215,180,106,0.12), transparent 45%);
      pointer-events: none;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 54px);
      letter-spacing: 8px;
      text-transform: uppercase;
      font-weight: 950;
      color: rgba(187,134,252,0.96);
      text-shadow: 0 0 50px rgba(155,89,182,0.55);
    }
    .hero p {
      margin: 12px 0 0;
      color: rgba(234,220,245,0.82);
      line-height: 1.8;
      max-width: 76ch;
      font-size: 14px;
    }
    .hero .quote {
      margin-top: 18px;
      padding: 14px 16px;
      border-left: 4px solid rgba(215,180,106,0.85);
      background: rgba(0,0,0,0.25);
      border-radius: 14px;
      color: rgba(234,220,245,0.86);
      font-style: italic;
    }
    .hero .quote strong { color: rgba(215,180,106,0.95); font-style: normal; }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card {
      border-radius: var(--radius);
      border: 1px solid rgba(187,134,252,0.26);
      background: linear-gradient(135deg, rgba(26,0,40,0.82), rgba(10,0,16,0.90));
      box-shadow: 0 22px 70px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .card .hd {
      padding: 16px 18px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      border-bottom: 1px solid rgba(187,134,252,0.18);
      background: rgba(0,0,0,0.20);
    }
    .card .hd h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 950;
      color: rgba(234,220,245,0.92);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .card .hd .mini {
      margin: 0;
      font-size: 12px;
      color: rgba(234,220,245,0.65);
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .card .bd { padding: 16px 18px 18px; }

    .ritual {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px) { .ritual { grid-template-columns: 1fr; } }

    .rit {
      border: 1px solid rgba(187,134,252,0.18);
      border-radius: 18px;
      background: rgba(0,0,0,0.22);
      padding: 14px;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.55);
    }
    .rit h3 {
      margin: 0 0 8px;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: rgba(187,134,252,0.95);
      font-weight: 950;
    }
    .rit p {
      margin: 0;
      color: rgba(234,220,245,0.72);
      font-size: 13px;
      line-height: 1.65;
    }

    .maps {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px) { .maps { grid-template-columns: 1fr; } }

    .mapbox {
      border-radius: 18px;
      border: 1px solid rgba(187,134,252,0.16);
      background: linear-gradient(135deg, rgba(0,0,0,0.26), rgba(0,0,0,0.12));
      padding: 14px;
      box-shadow: inset 0 0 26px rgba(0,0,0,0.55);
      min-height: 150px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .maphead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .maphead .name {
      font-weight: 950;
      letter-spacing: 2px;
      font-size: 12px;
      text-transform: uppercase;
      color: rgba(215,180,106,0.92);
    }
    .maphead .meta {
      font-size: 12px;
      color: rgba(234,220,245,0.55);
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .entry {
      white-space: pre-wrap;
      color: rgba(234,220,245,0.82);
      font-size: 13px;
      line-height: 1.65;
      max-height: 220px;
      overflow: auto;
      padding-right: 6px;
    }
    .entry em { color: rgba(234,220,245,0.58); }

    .linkrow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: auto;
    }
    .linkrow a {
      text-decoration: none;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: rgba(187,134,252,0.92);
      border: 1px solid rgba(187,134,252,0.22);
      background: rgba(26,0,40,0.35);
      padding: 10px 12px;
      border-radius: 999px;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .linkrow a:hover {
      transform: translateY(-1px);
      border-color: rgba(187,134,252,0.55);
      box-shadow: 0 0 40px rgba(155,89,182,0.22);
    }

    .scores {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .scorebox {
      border-radius: 18px;
      border: 1px solid rgba(187,134,252,0.18);
      background: rgba(0,0,0,0.22);
      padding: 14px;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.55);
    }
    .scorebox .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .scorebox .label {
      font-weight: 950;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(215,180,106,0.92);
    }
    .scorebox .hint {
      font-size: 12px;
      color: rgba(234,220,245,0.55);
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .scoreinputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .scoreinputs label {
      font-size: 12px;
      color: rgba(234,220,245,0.68);
      letter-spacing: 1px;
    }
    input[type="number"] {
      width: 100%;
      margin-top: 6px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(187,134,252,0.20);
      background: rgba(0,0,0,0.55);
      color: rgba(234,220,245,0.95);
      outline: none;
      font-size: 14px;
      box-shadow: inset 0 0 22px rgba(0,0,0,0.55);
    }
    input[type="number"]:focus {
      border-color: rgba(187,134,252,0.55);
      box-shadow: 0 0 30px rgba(155,89,182,0.25), inset 0 0 22px rgba(0,0,0,0.55);
    }

    .scoreline {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(187,134,252,0.18);
    }
    .scoreline .big {
      font-size: 28px;
      font-weight: 950;
      letter-spacing: 2px;
      color: rgba(187,134,252,0.95);
      text-shadow: 0 0 40px rgba(155,89,182,0.35);
    }
    .scoreline .tag {
      font-size: 12px;
      color: rgba(234,220,245,0.60);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(187,134,252,0.18);
      background: rgba(0,0,0,0.55);
      color: rgba(234,220,245,0.92);
      outline: none;
      font-size: 14px;
      line-height: 1.7;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.55);
      resize: vertical;
    }
    textarea:focus {
      border-color: rgba(187,134,252,0.55);
      box-shadow: 0 0 35px rgba(155,89,182,0.25), inset 0 0 30px rgba(0,0,0,0.55);
    }

    .notegrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .task-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .tasklist { display: grid; gap: 8px; }
    .taskrow { padding-bottom: 8px; border-bottom: 1px solid rgba(187,134,252,0.18); }
    .taskrow:last-child { border-bottom: none; }
    .tasktitle { font-weight: 800; }
    .taskmeta { color: var(--muted); font-size: 12px; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(187,134,252,0.35); margin-right: 6px; font-size: 10px; letter-spacing: 1px; }

    .notehead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .notehead .k {
      font-weight: 950;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(187,134,252,0.95);
    }
    .notehead .s {
      font-size: 12px;
      color: rgba(234,220,245,0.55);
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .menucards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px) { .menucards { grid-template-columns: 1fr; } }

    .mcard {
      border-radius: 18px;
      border: 1px solid rgba(187,134,252,0.16);
      background: linear-gradient(135deg, rgba(0,0,0,0.22), rgba(0,0,0,0.10));
      padding: 14px;
      box-shadow: inset 0 0 26px rgba(0,0,0,0.55);
    }
    .mcard .t {
      margin: 0 0 8px;
      font-weight: 950;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(215,180,106,0.92);
    }
    .mcard .d {
      margin: 0 0 10px;
      color: rgba(234,220,245,0.70);
      font-size: 13px;
      line-height: 1.6;
    }

    footer {
      margin-top: 18px;
      text-align: center;
      color: rgba(234,220,245,0.45);
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 22px 0 10px;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="sigil" aria-hidden="true"></div>
      <div class="titlewrap">
        <p class="title">GENERAL‚ÄôS TENT</p>
        <p class="subtitle">Weekly Strategic Reflection ‚Ä¢ Return & Report ‚Ä¢ Counsel with GOD</p>
      </div>
    </div>
    <div class="controls">
      <div class="pill" id="weekPill">üóì Week: --</div>
      <div class="pill" id="stampPill">‚è≥ Updated: --</div>
      <button class="btn" type="button" onclick="loadAll()">Reload</button>
      <button class="btn" type="button" onclick="resetLocal()">Reset Local Notes</button>
    </div>
  </div>
</header>

<main>
  <section class="hero">
    <h1>THE GENERAL‚ÄôS TENT</h1>
    <p>
      In the heart of your battleground there is a sanctuary ‚Äî a weekly ritual of strategic reflection.
      You return. You report. You learn. You correct. You set new targets.
      And across the table sits the only ally that matters: <span style="color:rgba(215,180,106,0.95);font-weight:900;letter-spacing:1px;">GOD</span>.
    </p>
    <div class="quote">
      <strong>Chapter 41:</strong> ‚ÄúWhat happens in the Tent is not review. It‚Äôs commitment.‚Äù
    </div>
  </section>

  <section class="grid">
    <!-- LEFT: Weekly Overview -->
    <div class="card">
      <div class="hd">
        <h2>üèõÔ∏è General's Tent</h2>
        <p class="mini" id="tentWeek">Week Loading...</p>
      </div>
      <div class="bd">
        <div class="rit">
          <h3>Directive</h3>
          <p>
            The General's Tent is your weekly council. Review the week's battles,
            extract lessons, correct course, and set new targets.
          </p>
          <p style="margin-top:12px;font-size:12px;color:rgba(234,220,245,0.6);">
            üí° For pipeline intelligence & backend synthesis, see the <a href="#pipelineDebug" onclick="scrollToId('pipelineDebug');return false;" style="color:rgba(189,147,249,0.8);text-decoration:underline;">Pipeline Debug</a> section below.
          </p>
        </div>
      </div>
    </div>

    <!-- RIGHT: Scores + Menu -->
    <div style="display:grid;gap:18px;">
      <div class="card">
        <div class="hd">
          <h2>üìä Alpha Score</h2>
          <p class="mini">Report the Numbers</p>
        </div>
        <div class="bd">
          <div class="scores">
            <div class="scorebox">
              <div class="row">
                <div class="label">The Core</div>
                <div class="hint">__/28 (daily)</div>
              </div>
              <div class="scoreinputs">
                <label>Score
                  <input id="coreScore" type="number" min="0" max="28" placeholder="0..28">
                </label>
                <label>Max
                  <input id="coreMax" type="number" min="1" max="60" value="28">
                </label>
              </div>
              <div class="scoreline">
                <div class="big" id="coreDisplay">-- / 28</div>
                <div class="tag">Return & Report</div>
              </div>
            </div>

            <div class="scorebox">
              <div class="row">
                <div class="label">The Stack</div>
                <div class="hint">__/7 (weekly)</div>
              </div>
              <div class="scoreinputs">
                <label>Score
                  <input id="stackScore" type="number" min="0" max="7" placeholder="0..7">
                </label>
                <label>Max
                  <input id="stackMax" type="number" min="1" max="30" value="7">
                </label>
              </div>
              <div class="scoreline">
                <div class="big" id="stackDisplay">-- / 7</div>
                <div class="tag">Return & Report</div>
              </div>
            </div>

            <div class="scorebox">
              <div class="row">
                <div class="label">The Door</div>
                <div class="hint">__/21 (weekly)</div>
              </div>
              <div class="scoreinputs">
                <label>Score
                  <input id="doorScore" type="number" min="0" max="21" placeholder="0..21">
                </label>
                <label>Max
                  <input id="doorMax" type="number" min="1" max="60" value="21">
                </label>
              </div>
              <div class="scoreline">
                <div class="big" id="doorDisplay">-- / 21</div>
                <div class="tag">Return & Report</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="card" id="tasksCard">
        <div class="hd">
          <h2>‚öîÔ∏è Fire Tasks</h2>
          <p class="mini">Taskwarrior ‚Üí TickTick</p>
        </div>
        <div class="bd">
          <div class="task-actions">
            <button class="btn" type="button" onclick="loadTasks()">Load Tasks</button>
            <button class="btn" type="button" onclick="pushTasks()">Push TickTick</button>
          </div>
          <div class="mini" id="taskMeta">‚Äî</div>
          <div id="taskList" class="tasklist">Lade‚Ä¶</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>üß≠ Command Menu</h2>
          <p class="mini">Cards ‚Üí Submodules</p>
        </div>
        <div class="bd">
          <div class="menucards">
            <div class="mcard">
              <div class="t">GameCentre</div>
              <div class="d">Maps + Tent + Odyssey synthesis.</div>
              <div class="linkrow">
                <a id="link_gamecentre" href="#" target="_blank">‚Üí GameCentre Index</a>
              </div>
            </div>
            <div class="mcard">
              <div class="t">DoorCentre</div>
              <div class="d">Hot List ‚Ä¢ Door War ‚Ä¢ War Stack ‚Ä¢ Profit Review.</div>
              <div class="linkrow">
                <a id="link_doorcentre" href="#" target="_blank">‚Üí DoorCentre Index</a>
              </div>
            </div>
            <div class="mcard">
              <div class="t">Frame/Freedom/Focus/Fire</div>
              <div class="d">Navigate facts. Then choose targets.</div>
              <div class="linkrow">
                <a id="link_frame2" href="#" target="_blank">Frame</a>
                <a id="link_freedom2" href="#" target="_blank">Freedom</a>
                <a id="link_focus2" href="#" target="_blank">Focus</a>
                <a id="link_fire2" href="#" target="_blank">Fire</a>
              </div>
            </div>
            <div class="mcard">
              <div class="t">Memoirs Centre</div>
              <div class="d">Daily journaling via The Voice framework (Stop ‚Ä¢ Submit ‚Ä¢ Struggle ‚Ä¢ Strike).</div>
              <div class="linkrow">
                <a id="link_voice2" href="#" target="_blank">‚Üí Memoirs</a>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="rit">
            <h3>Directive</h3>
            <p>
              Keep the Tent clean: it‚Äôs the weekly council.
              The modules do the work. The Tent decides the war.
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>‚å®Ô∏è Embedded Terminal</h2>
          <p class="mini">Local shell (taskwarrior, calcurse, ranger)</p>
        </div>
        <div class="bd">
          <div id="terminalBox" style="height:320px;border:1px solid rgba(187,134,252,0.2);border-radius:14px;"></div>
          <div style="height:10px"></div>
          <div class="rit">
            <h3>Notes</h3>
            <p>Requires local deps: <code>npm install</code> in index-node.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- NOTES -->
  <section class="card" id="notesCard" style="margin-top:18px;">
    <div class="hd">
      <h2>‚úçÔ∏è The Fourfold Strategy Session</h2>
      <p class="mini">Lessons ‚Ä¢ Course Correction ‚Ä¢ New Targets</p>
    </div>
    <div class="bd">
      <div class="notegrid">
        <div>
          <div class="notehead">
            <div class="k">Component #2 ‚Äî Lessons Learned</div>
            <div class="s">What worked / What didn't</div>
          </div>
          <textarea id="lessons" placeholder="What did the week teach you? What pattern repeats? What cross-domain principle can you apply for exponential growth?"></textarea>
        </div>

        <div>
          <div class="notehead">
            <div class="k">Component #3 ‚Äî Course Correction</div>
            <div class="s">Adjust strategy</div>
          </div>
          <textarea id="correction" placeholder="Where did you drift? What needs realignment? What gets cut? What gets reinforced?"></textarea>
        </div>

        <div>
          <div class="notehead">
            <div class="k">Component #4 ‚Äî New Targets</div>
            <div class="s">Targets aligned to Focus ‚Üí Freedom</div>
          </div>
          <textarea id="targets" placeholder="List the new targets. Keep them aligned: Focus (month) ‚Üí Freedom (year)."></textarea>
        </div>

      </div>
    </div>
  </section>

  <!-- PIPELINE DEBUG SECTION -->
  <section class="card" id="pipelineDebug" style="margin-top:24px;border:2px solid rgba(189,147,249,0.3);">
    <div class="hd">
      <h2>üî¨ Pipeline Intelligence (Debug)</h2>
      <p class="mini">Backend synthesis for Telegram reports & monitoring</p>
    </div>
    <div class="bd">
      <div style="margin-bottom:18px;padding:12px;background:rgba(189,147,249,0.1);border-radius:8px;border-left:3px solid rgba(189,147,249,0.5);">
        <div style="font-size:12px;color:rgba(234,220,245,0.8);line-height:1.6;">
          <strong>‚ÑπÔ∏è About this section:</strong> This data is synthesized by the backend for automated Telegram reports and system monitoring.
          It's not part of your manual Tent workflow - it's the intelligence engine running in the background.
        </div>
      </div>

      <!-- Component #1: Return & Report Intelligence -->
      <details style="margin-bottom:18px;">
        <summary style="cursor:pointer;font-weight:600;font-size:14px;color:rgba(187,134,252,0.95);padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
          üìä Component #1: Return & Report Intelligence
        </summary>
        <div style="padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;margin-top:8px;">
          <!-- Domain Health Matrix -->
          <div style="marginBottom: 16px;">
            <h3 style="margin:0 0 10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:rgba(187,134,252,0.95);font-weight:950;">üìä DOMAIN HEALTH MATRIX</h3>
            <div id="domainHealthMatrix" style="font-family:monospace;font-size:12px;line-height:1.6;color:rgba(234,220,245,0.80);background:rgba(0,0,0,0.25);padding:12px;border-radius:12px;border:1px solid rgba(187,134,252,0.15);">
              Loading domain health...
            </div>
          </div>

          <div style="height:14px"></div>

          <!-- Strategic Intelligence Alerts -->
          <div id="strategicIntelligence" style="display:none;">
            <h3 style="margin:0 0 10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,92,138,0.95);font-weight:950;">üö® STRATEGIC INTELLIGENCE</h3>
            <div id="intelligenceAlerts"></div>
            <div style="height:12px"></div>
          </div>

          <!-- Pipeline Blockages -->
          <div id="pipelineSection" style="display:none;">
            <h3 style="margin:0 0 10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,209,102,0.95);font-weight:950;">‚ö†Ô∏è PIPELINE BLOCKAGES</h3>
            <div id="pipelineBlockages"></div>
            <div style="height:12px"></div>
          </div>

          <!-- Cascade Alignment -->
          <div style="marginBottom: 16px;">
            <h3 style="margin:0 0 10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:rgba(99,255,219,0.95);font-weight:950;">üìà CASCADE ALIGNMENT</h3>
            <div id="cascadeAlignment" style="font-family:monospace;font-size:12px;line-height:1.6;color:rgba(234,220,245,0.80);background:rgba(0,0,0,0.25);padding:12px;border-radius:12px;border:1px solid rgba(187,134,252,0.15);">
              Loading cascade health...
            </div>
          </div>

          <!-- Weekly Metrics Summary -->
          <div style="marginBottom: 8px;">
            <h3 style="margin:0 0 10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:rgba(215,180,106,0.95);font-weight:950;">üì¶ WEEKLY METRICS</h3>
            <div id="weeklyMetrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;"></div>
          </div>
        </div>
      </details>

      <!-- Component #2: Lessons Synthesis -->
      <details style="margin-bottom:18px;">
        <summary style="cursor:pointer;font-weight:600;font-size:14px;color:rgba(99,255,219,0.95);padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
          üß† Component #2: Lessons Synthesis
        </summary>
        <div style="padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;margin-top:8px;">
          <div id="debugLessonsContent">Loading lessons synthesis...</div>
        </div>
      </details>

      <!-- Component #3: Corrections Synthesis -->
      <details style="margin-bottom:18px;">
        <summary style="cursor:pointer;font-weight:600;font-size:14px;color:rgba(255,92,138,0.95);padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
          ‚ö†Ô∏è Component #3: Corrections Synthesis
        </summary>
        <div style="padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;margin-top:8px;">
          <div id="debugCorrectionsContent">Loading corrections synthesis...</div>
        </div>
      </details>

      <!-- Component #4: Targets Synthesis -->
      <details style="margin-bottom:8px;">
        <summary style="cursor:pointer;font-weight:600;font-size:14px;color:rgba(189,147,249,0.95);padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">
          üéØ Component #4: Targets Synthesis
        </summary>
        <div style="padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;margin-top:8px;">
          <div id="debugTargetsContent">Loading targets synthesis...</div>
        </div>
      </details>
    </div>
  </section>

  <footer>
    Œ±OS ‚Ä¢ General's Tent ‚Ä¢ Chapter 41 ‚Ä¢ Alpha Odyssey
  </footer>
</main>

<script>
  const CENTRE_LINKS = {
    frame: "",
    freedom: "",
    focus: "",
    fire: "",
    voice: "",
    doorcentre: "",
    gamecentre: ""
  };

  const LS = {
    prefix: "aos_gentent_",
    scores: "scores",
    notes:  "notes"
  };

  function scrollToId(id) {
    const el = document.getElementById(id);
    if (!el) return;
    window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 90, behavior: "smooth" });
  }

  function isoWeekString(date = new Date()) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  }

  function fmtDate(d) {
    try {
      return new Date(d).toLocaleDateString('de-DE');
    } catch (_) {
      return "";
    }
  }

  function safeText(s) {
    return String(s || "").replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  }

  function setLinks() {
    const pairs = [
      ["link_frame", "frame"], ["link_frame2", "frame"],
      ["link_freedom", "freedom"], ["link_freedom2", "freedom"],
      ["link_focus", "focus"], ["link_focus2", "focus"],
      ["link_fire", "fire"], ["link_fire2", "fire"],
      ["link_voice", "voice"], ["link_voice2", "voice"],
      ["link_doorcentre", "doorcentre"],
      ["link_gamecentre", "gamecentre"]
    ];
    pairs.forEach(([id, key]) => {
      const a = document.getElementById(id);
      if (!a) return;
      a.href = CENTRE_LINKS[key] || "#";
    });
  }

  function renderRow(type, payload) {
    const box = document.getElementById(type);
    const meta = document.getElementById("meta_" + type);
    if (!box) return;

    if (!payload || payload.empty || !payload.title) {
      box.innerHTML = "<em>Kein Eintrag ‚Äì Course Correction n√∂tig</em>";
      if (meta) meta.textContent = "‚Äî";
      return;
    }

    const title = payload.title || type.toUpperCase();
    const ts = payload.updated_at ? fmtDate(payload.updated_at) : "";
    const content = payload.excerpt || "";

    if (meta) meta.textContent = ts ? ts : "‚Äî";

    box.innerHTML =
      `<b>${safeText(title)}${ts ? " ¬∑ " + safeText(ts) : ""}</b>\n\n` +
      safeText(content || "(kein Inhalt)");
  }

  async function fetchCentres() {
    try {
      const res = await fetch("/api/centres", { cache: "no-store" });
      const data = await res.json();
      const centres = Array.isArray(data?.centres) ? data.centres : [];
      const byCmd = {};
      centres.forEach(item => {
        const cmd = String(item?.cmd || "").toLowerCase();
        if (cmd) byCmd[cmd] = String(item?.url || "");
      });
      CENTRE_LINKS.frame = byCmd.frame || CENTRE_LINKS.frame;
      CENTRE_LINKS.freedom = byCmd.freedom || CENTRE_LINKS.freedom;
      CENTRE_LINKS.focus = byCmd.focus || CENTRE_LINKS.focus;
      CENTRE_LINKS.fire = byCmd.fire || CENTRE_LINKS.fire;
      CENTRE_LINKS.voice = byCmd.memoirs || byCmd.voice || CENTRE_LINKS.voice;
      CENTRE_LINKS.doorcentre = byCmd.door || CENTRE_LINKS.doorcentre;
      CENTRE_LINKS.gamecentre = "/game/";
    } catch (_) {}
  }

  async function loadTasks() {
    const list = document.getElementById("taskList");
    const meta = document.getElementById("taskMeta");
    if (list) list.textContent = "Lade‚Ä¶";
    try {
      const res = await fetch("/api/taskwarrior/tasks?status=pending", { cache: "no-store" });
      const data = await res.json();
      if (!data?.ok) throw new Error(data?.error || "fetch failed");
      if (meta) meta.textContent = `${data.count} Tasks (Tags: ${data.tags.join(", ")})`;
      if (!data.tasks.length) {
        if (list) list.textContent = "Keine passenden Tasks gefunden.";
        return;
      }
      const html = data.tasks.map(t => {
        const tags = (t.tags || []).map(tag => `<span class="tag">${safeText(tag)}</span>`).join(" ");
        const due = t.due ? ` ¬∑ Due: ${safeText(t.due)}` : "";
        return `<div class="taskrow"><div class="tasktitle">${safeText(t.description || "(ohne Beschreibung)")}</div><div class="taskmeta">${tags}${due}</div></div>`;
      }).join("");
      if (list) list.innerHTML = html;
    } catch (err) {
      if (meta) meta.textContent = "Error";
      if (list) list.textContent = "Fehler beim Laden der Tasks.";
    }
  }

  async function pushTasks() {
    try {
      const res = await fetch("/api/taskwarrior/push", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "pending" })
      });
      const data = await res.json();
      if (!data?.ok) throw new Error(data?.error || "push failed");
      alert(`TickTick push: ${data.pushed}/${data.total} Tasks`);
      loadTasks();
    } catch (err) {
      alert("Fehler beim Push: " + (err?.message || String(err)));
    }
  }

  async function loadAll() {
    await fetchCentres();
    setLinks();

    document.getElementById("weekPill").textContent = "üóì Week: " + isoWeekString();
    document.getElementById("tentWeek").textContent = isoWeekString();
    setUpdatedStamp();

    // Load new Tent Intelligence
    loadTentIntelligence();

    restoreLocal();
    wireScoreLive();
    wireAutosave();
    initTerminal();
    loadTasks();
  }

  async function loadTentIntelligence() {
    try {
      const week = isoWeekString();
      const res = await fetch(`/api/tent/component/return-report?week=${week}`, { cache: "no-store" });

      if (!res.ok) {
        throw new Error(`API returned ${res.status}`);
      }

      const data = await res.json();

      if (!data.ok || !data.component) {
        throw new Error("Invalid response format");
      }

      const component = data.component;

      // Render Domain Health Matrix
      renderDomainHealthMatrix(component);

      // Render Strategic Intelligence
      renderStrategicIntelligence(component);

      // Render Pipeline Blockages
      renderPipelineBlockages(component);

      // Render Cascade Alignment
      renderCascadeAlignment(component);

      // Render Weekly Metrics
      renderWeeklyMetrics(component);

    } catch (err) {
      console.error("Failed to load Tent Intelligence (Component #1):", err);

      // Show error in UI
      const matrix = document.getElementById("domainHealthMatrix");
      if (matrix) {
        matrix.innerHTML = `<span style="color:rgba(255,92,138,0.8);">‚ö†Ô∏è Failed to load intelligence: ${err.message}</span><br><br><em style="font-size:11px;">Make sure domain-states are initialized:<br><code>curl -X POST http://127.0.0.1:8799/api/tent/init</code></em>`;
      }

      const cascade = document.getElementById("cascadeAlignment");
      if (cascade) {
        cascade.innerHTML = `<em style="color:rgba(255,92,138,0.7);">Data unavailable</em>`;
      }
    }

    // Component #2: Lessons (Debug section)
    try {
      const week = isoWeekString();
      const res = await fetch(`/api/tent/component/lessons?week=${week}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`API returned ${res.status}`);
      const data = await res.json();
      if (data.ok && data.component) {
        renderLessonsDebug(data.component);
      } else {
        throw new Error("Invalid response format");
      }
    } catch (err) {
      console.error('Failed to load Lessons:', err);
      document.getElementById('debugLessonsContent').innerHTML = '<div style="color:rgba(255,92,138,0.7);font-size:12px;">‚ö†Ô∏è Failed to load lessons</div>';
    }

    // Component #3: Corrections (Debug section)
    try {
      const week = isoWeekString();
      const res = await fetch(`/api/tent/component/corrections?week=${week}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`API returned ${res.status}`);
      const data = await res.json();
      if (data.ok && data.component) {
        renderCorrectionsDebug(data.component);
      } else {
        throw new Error("Invalid response format");
      }
    } catch (err) {
      console.error('Failed to load Corrections:', err);
      document.getElementById('debugCorrectionsContent').innerHTML = '<div style="color:rgba(255,92,138,0.7);font-size:12px;">‚ö†Ô∏è Failed to load corrections</div>';
    }

    // Component #4: Targets (Debug section)
    try {
      const week = isoWeekString();
      const res = await fetch(`/api/tent/component/targets?week=${week}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`API returned ${res.status}`);
      const data = await res.json();
      if (data.ok && data.component) {
        renderTargetsDebug(data.component);
      } else {
        throw new Error("Invalid response format");
      }
    } catch (err) {
      console.error('Failed to load Targets:', err);
      document.getElementById('debugTargetsContent').innerHTML = '<div style="color:rgba(255,92,138,0.7);font-size:12px;">‚ö†Ô∏è Failed to load targets</div>';
    }
  }

  function renderDomainHealthMatrix(component) {
    const metrics = component.weekly_metrics || {};
    const domainSynthesis = component.domain_synthesis || {};
    const domainHealth = domainSynthesis.domain_health || {};

    const domains = ['BODY', 'BEING', 'BALANCE', 'BUSINESS'];

    // Voice count map (from synthesis or hardcoded)
    const voiceMap = { 'BODY': 6, 'BEING': 4, 'BALANCE': 8, 'BUSINESS': 6 };

    let html = '';
    html += '<div style="color:rgba(234,220,245,0.65);font-size:11px;margin-bottom:8px;">Domain    V‚ÜíD‚ÜíF  Core4  Status</div>';
    html += '<div style="border-bottom:1px solid rgba(187,134,252,0.15);margin-bottom:6px;"></div>';

    domains.forEach(domain => {
      const voiceCount = voiceMap[domain] || 0;
      const core4 = (metrics.core4 || {})[domain] || 0;
      const fireData = (metrics.fire_hits || {})[domain] || {};
      const fireHits = fireData.total || 0;
      const warStacks = ((metrics.war_stacks || {}).by_domain || {})[domain] || {};
      const wsActive = warStacks.active || 0;

      // Status indicator
      let status, statusColor;
      if (wsActive > 0 && fireHits > 0 && core4 >= 6) {
        status = 'üü¢ STRONG';
        statusColor = 'rgba(99,255,219,0.9)';
      } else if (wsActive > 0 || fireHits > 0 || core4 >= 4) {
        status = 'üü° PARTIAL';
        statusColor = 'rgba(255,209,102,0.9)';
      } else {
        status = 'üî¥ BLOCKED';
        statusColor = 'rgba(255,92,138,0.9)';
      }

      html += `<div style="margin-bottom:4px;">`;
      html += `<span style="display:inline-block;width:70px;">${domain}</span>`;
      html += `<span style="display:inline-block;width:45px;text-align:center;">${voiceCount}‚Üí${wsActive}‚Üí${fireHits}</span>`;
      html += `<span style="display:inline-block;width:50px;text-align:center;">${core4}/7</span>`;
      html += `<span style="color:${statusColor};font-weight:bold;">${status}</span>`;
      html += `</div>`;
    });

    document.getElementById("domainHealthMatrix").innerHTML = html;
  }

  function renderStrategicIntelligence(component) {
    const insights = (component.domain_synthesis || {}).insights || [];

    if (insights.length === 0) {
      document.getElementById("strategicIntelligence").style.display = 'none';
      return;
    }

    document.getElementById("strategicIntelligence").style.display = 'block';

    let html = '';
    insights.slice(0, 3).forEach(insight => {
      const severityEmoji = {
        'high': 'üî¥',
        'medium': 'üü°',
        'low': 'üü¢'
      }[insight.severity] || '‚ö™';

      const severityColor = {
        'high': 'rgba(255,92,138,0.9)',
        'medium': 'rgba(255,209,102,0.9)',
        'low': 'rgba(99,255,219,0.9)'
      }[insight.severity] || 'rgba(234,220,245,0.7)';

      html += `<div style="background:rgba(0,0,0,0.3);padding:10px 12px;border-radius:10px;margin-bottom:8px;border-left:3px solid ${severityColor};">`;
      html += `<div style="color:${severityColor};font-weight:bold;font-size:11px;margin-bottom:4px;">${severityEmoji} ${insight.type.toUpperCase().replace(/_/g, ' ')}</div>`;
      html += `<div style="font-size:12px;color:rgba(234,220,245,0.85);margin-bottom:6px;">${insight.description}</div>`;
      html += `<div style="font-size:11px;color:rgba(234,220,245,0.65);font-style:italic;">‚Üí ${insight.recommendation}</div>`;
      html += `</div>`;
    });

    document.getElementById("intelligenceAlerts").innerHTML = html;
  }

  function renderPipelineBlockages(component) {
    const issues = (component.pipeline_synthesis || {}).issues || [];

    if (issues.length === 0) {
      document.getElementById("pipelineSection").style.display = 'none';
      return;
    }

    document.getElementById("pipelineSection").style.display = 'block';

    let html = '';
    issues.slice(0, 2).forEach(issue => {
      html += `<div style="background:rgba(0,0,0,0.3);padding:10px 12px;border-radius:10px;margin-bottom:8px;border-left:3px solid rgba(255,209,102,0.9);">`;
      html += `<div style="color:rgba(255,209,102,0.95);font-weight:bold;font-size:11px;margin-bottom:4px;">${issue.domain} ${issue.stage.toUpperCase().replace(/_/g, '‚Üí')}</div>`;
      html += `<div style="font-size:12px;color:rgba(234,220,245,0.85);margin-bottom:6px;">${issue.description}</div>`;
      html += `<div style="font-size:11px;color:rgba(99,255,219,0.8);">‚úÖ ${issue.correction}</div>`;
      html += `</div>`;
    });

    document.getElementById("pipelineBlockages").innerHTML = html;
  }

  function renderCascadeAlignment(component) {
    const cascade = (component.temporal_synthesis || {}).cascade_health || {};
    const domains = ['BODY', 'BEING', 'BALANCE', 'BUSINESS'];

    let html = '';
    html += '<div style="color:rgba(234,220,245,0.65);font-size:11px;margin-bottom:8px;">Fire‚ÜíFocus‚ÜíFreedom‚ÜíFrame</div>';
    html += '<div style="border-bottom:1px solid rgba(187,134,252,0.15);margin-bottom:6px;"></div>';

    domains.forEach(domain => {
      const domainCascade = cascade[domain] || {};
      const ff = domainCascade.fire_to_focus || 'unknown';
      const ff2 = domainCascade.focus_to_freedom || 'unknown';
      const ff3 = domainCascade.freedom_to_frame || 'unknown';

      const emojiMap = {
        'aligned': 'üü¢',
        'partial': 'üü°',
        'blocked': 'üî¥',
        'unknown': '‚ö™'
      };

      const e1 = emojiMap[ff] || '‚ö™';
      const e2 = emojiMap[ff2] || '‚ö™';
      const e3 = emojiMap[ff3] || '‚ö™';

      html += `<div style="margin-bottom:4px;">`;
      html += `<span style="display:inline-block;width:80px;">${domain}</span>`;
      html += `<span style="display:inline-block;width:30px;text-align:center;">${e1}</span>`;
      html += `<span style="display:inline-block;width:30px;text-align:center;">${e2}</span>`;
      html += `<span style="display:inline-block;width:30px;text-align:center;">${e3}</span>`;
      html += `<span style="display:inline-block;width:30px;text-align:center;">‚ö™</span>`;
      html += `</div>`;
    });

    document.getElementById("cascadeAlignment").innerHTML = html;
  }

  function renderWeeklyMetrics(component) {
    const metrics = component.weekly_metrics || {};

    const metricBoxes = [
      {
        label: 'Core4 Total',
        value: Object.values(metrics.core4 || {}).reduce((a, b) => a + b, 0),
        max: 28,
        color: 'rgba(187,134,252,0.9)'
      },
      {
        label: 'Fire Hits',
        value: Object.values(metrics.fire_hits || {}).reduce((a, b) => a + (b.completed || 0), 0),
        max: Object.values(metrics.fire_hits || {}).reduce((a, b) => a + (b.total || 0), 0) || 16,
        color: 'rgba(255,92,138,0.9)'
      },
      {
        label: 'War Stacks',
        value: (metrics.war_stacks || {}).active || 0,
        max: null,
        color: 'rgba(255,209,102,0.9)'
      }
    ];

    let html = '';
    metricBoxes.forEach(box => {
      html += `<div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:10px;text-align:center;">`;
      html += `<div style="font-size:11px;color:rgba(234,220,245,0.65);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">${box.label}</div>`;
      html += `<div style="font-size:22px;font-weight:bold;color:${box.color};">`;
      if (box.max) {
        html += `${box.value}/${box.max}`;
      } else {
        html += `${box.value}`;
      }
      html += `</div>`;
      html += `</div>`;
    });

    document.getElementById("weeklyMetrics").innerHTML = html;
  }

  // ============================================================
  // Component #2: Lessons (Debug)
  // ============================================================
  function renderLessonsDebug(component) {
    const autoLessons = (component.auto_lessons || []).slice(0, 5);
    const voiceInsights = (component.voice_insights || []).slice(0, 4);
    const fireReflections = (component.fire_reflections || []).slice(0, 3);

    if (autoLessons.length === 0 && voiceInsights.length === 0 && fireReflections.length === 0) {
      document.getElementById('debugLessonsContent').innerHTML = '<em style="color:rgba(234,220,245,0.5);font-size:12px;">No patterns detected yet</em>';
      return;
    }

    let html = '';

    // Auto-Generated Lessons
    if (autoLessons.length > 0) {
      html += '<div style="margin-bottom:12px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(99,255,219,0.8);margin-bottom:6px;">üß† Auto-Generated Lessons</div>';
      autoLessons.forEach(lesson => {
        html += `<div style="margin-left:8px;margin-bottom:6px;padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(234,220,245,0.95);margin-bottom:3px;">‚Ä¢ ${safeText(lesson.pattern)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.65);font-size:11px;">‚Üí ${safeText(lesson.evidence)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.5);font-size:10px;margin-top:2px;">${safeText(lesson.source)}</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    // VOICE Insights
    if (voiceInsights.length > 0) {
      html += '<div style="margin-bottom:12px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(189,147,249,0.8);margin-bottom:6px;">üó£Ô∏è VOICE Session Insights</div>';
      voiceInsights.forEach(insight => {
        html += `<div style="margin-left:8px;margin-bottom:6px;padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(215,180,106,0.9);font-weight:600;margin-bottom:3px;">${safeText(insight.domain)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.85);font-style:italic;">‚Äû${safeText(insight.strike || 'No strike yet')}"</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    // Fire Reflections
    if (fireReflections.length > 0) {
      html += '<div>';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(255,92,138,0.8);margin-bottom:6px;">üî• Fire Map Reflections</div>';
      fireReflections.forEach(reflection => {
        html += `<div style="margin-left:8px;margin-bottom:6px;padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(234,220,245,0.95);">‚Ä¢ ${safeText(reflection)}</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    document.getElementById('debugLessonsContent').innerHTML = html;
  }

  // ============================================================
  // Component #3: Corrections (Debug)
  // ============================================================
  function renderCorrectionsDebug(component) {
    const frameShifts = (component.frame_shift_triggers || []).slice(0, 3);
    const cascadeCorrections = (component.cascade_corrections || []).slice(0, 3);
    const domainCorrections = (component.domain_corrections || []).slice(0, 4);
    const pipelineCorrections = (component.pipeline_corrections || []).slice(0, 4);

    if (frameShifts.length === 0 && cascadeCorrections.length === 0 &&
        domainCorrections.length === 0 && pipelineCorrections.length === 0) {
      document.getElementById('debugCorrectionsContent').innerHTML = '<em style="color:rgba(234,220,245,0.5);font-size:12px;">No corrections needed</em>';
      return;
    }

    let html = '';

    // Frame Shift Triggers (Highest Priority)
    if (frameShifts.length > 0) {
      html += '<div style="margin-bottom:14px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(255,92,138,0.9);margin-bottom:6px;">üö® Frame Shift Triggers</div>';
      frameShifts.forEach(shift => {
        html += `<div style="margin-left:8px;margin-bottom:8px;padding:8px 10px;background:rgba(0,0,0,0.3);border-left:3px solid rgba(255,92,138,0.9);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(234,220,245,0.95);font-weight:600;margin-bottom:4px;">${safeText(shift.domain)} Frame Shift</div>`;
        html += `<div style="color:rgba(234,220,245,0.7);margin-bottom:4px;">${shift.days_ago} days ago: ${safeText(shift.new_status)}</div>`;
        html += `<div style="color:rgba(255,92,138,0.9);font-size:11px;">‚ö†Ô∏è Update Freedom/Focus/Fire cascade</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    // Domain-Specific Corrections
    if (domainCorrections.length > 0) {
      html += '<div style="margin-bottom:12px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(189,147,249,0.8);margin-bottom:6px;">üìä Domain Corrections</div>';
      domainCorrections.forEach(c => {
        html += `<div style="margin-left:8px;margin-bottom:8px;padding:8px 10px;background:rgba(0,0,0,0.2);border-left:3px solid rgba(189,147,249,0.5);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(215,180,106,0.9);font-weight:600;margin-bottom:3px;">${safeText(c.domain)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.8);margin-bottom:4px;">Issue: ${safeText(c.issue)}</div>`;
        html += `<div style="color:rgba(99,255,219,0.9);font-size:11px;">‚úì ${safeText(c.correction)}</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    // Pipeline Corrections
    if (pipelineCorrections.length > 0) {
      html += '<div style="margin-bottom:12px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(255,209,102,0.8);margin-bottom:6px;">‚ö° Pipeline Flow Fixes</div>';
      pipelineCorrections.forEach(correction => {
        const severityColor = {
          'high': 'rgba(255,92,138,0.9)',
          'medium': 'rgba(255,209,102,0.9)',
          'low': 'rgba(99,255,219,0.9)'
        }[correction.severity] || 'rgba(234,220,245,0.7)';

        html += `<div style="margin-left:8px;margin-bottom:8px;padding:8px 10px;background:rgba(0,0,0,0.2);border-left:3px solid ${severityColor};border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(234,220,245,0.95);font-weight:600;margin-bottom:3px;">${safeText(correction.domain)} ‚Üí ${safeText(correction.stage)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.7);margin-bottom:4px;">${safeText(correction.description)}</div>`;
        html += `<div style="color:${severityColor};font-size:11px;">‚úì ${safeText(correction.correction)}</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    // Cascade Corrections
    if (cascadeCorrections.length > 0) {
      html += '<div>';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(99,255,219,0.8);margin-bottom:6px;">üìà Cascade Alignment</div>';
      cascadeCorrections.forEach(correction => {
        html += `<div style="margin-left:8px;margin-bottom:6px;padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(234,220,245,0.95);">‚Ä¢ ${safeText(correction)}</div>`;
        html += `</div>`;
      });
      html += '</div>';
    }

    document.getElementById('debugCorrectionsContent').innerHTML = html;
  }

  // ============================================================
  // Component #4: Targets (Debug)
  // ============================================================
  function renderTargetsDebug(component) {
    const focusTargets = component.focus_targets || {};
    const fireTargets = component.fire_targets || {};
    const warStacksNeeded = (component.war_stacks_needed || []).slice(0, 4);

    const domains = ['BODY', 'BEING', 'BALANCE', 'BUSINESS'];
    const hasFocusTargets = domains.some(d => focusTargets[d] && focusTargets[d].mission !== 'unknown');
    const hasFireTargets = domains.some(d => (fireTargets[d] || []).length > 0);

    if (!hasFocusTargets && !hasFireTargets && warStacksNeeded.length === 0) {
      document.getElementById('debugTargetsContent').innerHTML = '<em style="color:rgba(234,220,245,0.5);font-size:12px;">No targets generated yet</em>';
      return;
    }

    let html = '';

    // War Stacks Needed (Highest Priority)
    if (warStacksNeeded.length > 0) {
      html += '<div style="margin-bottom:14px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(255,92,138,0.9);margin-bottom:6px;">‚öîÔ∏è War Stacks Needed</div>';
      warStacksNeeded.forEach(ws => {
        html += `<div style="margin-left:8px;margin-bottom:8px;padding:8px 10px;background:rgba(0,0,0,0.3);border-left:3px solid rgba(255,92,138,0.9);border-radius:6px;font-size:12px;line-height:1.5;">`;
        html += `<div style="color:rgba(215,180,106,0.95);font-weight:600;margin-bottom:3px;">${safeText(ws.domain)}: ${safeText(ws.title)}</div>`;
        html += `<div style="color:rgba(234,220,245,0.7);margin-bottom:6px;font-style:italic;">${safeText(ws.why)}</div>`;
        if (ws.suggested_hits && ws.suggested_hits.length > 0) {
          html += `<div style="margin-top:6px;">`;
          ws.suggested_hits.slice(0, 4).forEach(hit => {
            html += `<div style="color:rgba(99,255,219,0.85);font-size:11px;margin-left:8px;">‚Üí ${safeText(hit)}</div>`;
          });
          html += `</div>`;
        }
        html += `</div>`;
      });
      html += '</div>';
    }

    // Focus Targets (Monthly)
    if (hasFocusTargets) {
      html += '<div style="margin-bottom:12px;">';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(189,147,249,0.8);margin-bottom:6px;">üìç Focus Targets (Monthly)</div>';
      domains.forEach(domain => {
        const focus = focusTargets[domain];
        if (focus && focus.mission !== 'unknown') {
          html += `<div style="margin-left:8px;margin-bottom:6px;padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:12px;line-height:1.5;">`;
          html += `<div style="color:rgba(215,180,106,0.9);font-weight:600;margin-bottom:2px;">${domain} (${safeText(focus.quarter)})</div>`;
          html += `<div style="color:rgba(234,220,245,0.85);">Mission: ${safeText(focus.mission)}</div>`;
          html += `<div style="color:rgba(234,220,245,0.65);font-size:11px;">${safeText(focus.alignment)}</div>`;
          html += `</div>`;
        }
      });
      html += '</div>';
    }

    // Fire Targets (Weekly)
    if (hasFireTargets) {
      html += '<div>';
      html += '<div style="font-size:12px;font-weight:600;color:rgba(255,92,138,0.8);margin-bottom:6px;">üî• Fire Targets (This Week)</div>';
      domains.forEach(domain => {
        const targets = (fireTargets[domain] || []).slice(0, 3);
        if (targets.length > 0) {
          html += `<div style="margin-left:8px;margin-bottom:8px;">`;
          html += `<div style="font-size:11px;font-weight:600;color:rgba(234,220,245,0.8);margin-bottom:4px;">${domain}</div>`;
          targets.forEach(target => {
            html += `<div style="margin-left:8px;padding:4px 8px;background:rgba(0,0,0,0.2);border-radius:4px;font-size:11px;line-height:1.4;margin-bottom:4px;">`;
            html += `<div style="color:rgba(234,220,245,0.9);">‚Üí ${safeText(target)}</div>`;
            html += `</div>`;
          });
          html += `</div>`;
        }
      });
      html += '</div>';
    }

    document.getElementById('debugTargetsContent').innerHTML = html;
  }

  function restoreLocal() {
    try {
      const scores = JSON.parse(localStorage.getItem(LS.prefix + LS.scores) || "{}");
      if (scores.coreScore != null)  document.getElementById("coreScore").value = scores.coreScore;
      if (scores.coreMax != null)    document.getElementById("coreMax").value = scores.coreMax;
      if (scores.stackScore != null) document.getElementById("stackScore").value = scores.stackScore;
      if (scores.stackMax != null)   document.getElementById("stackMax").value = scores.stackMax;
      if (scores.doorScore != null)  document.getElementById("doorScore").value = scores.doorScore;
      if (scores.doorMax != null)    document.getElementById("doorMax").value = scores.doorMax;

      const notes = JSON.parse(localStorage.getItem(LS.prefix + LS.notes) || "{}");
      if (notes.lessons != null)    document.getElementById("lessons").value = notes.lessons;
      if (notes.correction != null) document.getElementById("correction").value = notes.correction;
      if (notes.targets != null)    document.getElementById("targets").value = notes.targets;
    } catch (_) {}
    updateScoreDisplays();
  }

  function saveLocalScores(silent = false) {
    const payload = {
      coreScore:  numVal("coreScore"),
      coreMax:    numVal("coreMax"),
      stackScore: numVal("stackScore"),
      stackMax:   numVal("stackMax"),
      doorScore:  numVal("doorScore"),
      doorMax:    numVal("doorMax"),
      week: isoWeekString(),
      ts: new Date().toISOString()
    };
    localStorage.setItem(LS.prefix + LS.scores, JSON.stringify(payload));
    updateScoreDisplays();
    if (!silent) flash("Scores saved (local).");
  }

  function saveLocalNotes(silent = false) {
    const payload = {
      lessons: document.getElementById("lessons").value || "",
      correction: document.getElementById("correction").value || "",
      targets: document.getElementById("targets").value || "",
      week: isoWeekString(),
      ts: new Date().toISOString()
    };
    localStorage.setItem(LS.prefix + LS.notes, JSON.stringify(payload));
    if (!silent) flash("Notes saved (local).");
  }

  function resetLocal() {
    localStorage.removeItem(LS.prefix + LS.scores);
    localStorage.removeItem(LS.prefix + LS.notes);
    location.reload();
  }

  function numVal(id) {
    const v = parseInt(document.getElementById(id).value, 10);
    return isNaN(v) ? null : v;
  }

  function updateScoreDisplays() {
    const cs = numVal("coreScore");
    const cm = numVal("coreMax") ?? 28;
    const ss = numVal("stackScore");
    const sm = numVal("stackMax") ?? 7;
    const ds = numVal("doorScore");
    const dm = numVal("doorMax") ?? 21;

    document.getElementById("coreDisplay").textContent = `${cs ?? "--"} / ${cm}`;
    document.getElementById("stackDisplay").textContent = `${ss ?? "--"} / ${sm}`;
    document.getElementById("doorDisplay").textContent = `${ds ?? "--"} / ${dm}`;
  }

  function wireScoreLive() {
    ["coreScore","coreMax","stackScore","stackMax","doorScore","doorMax"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", updateScoreDisplays);
    });
  }

  function wireAutosave() {
    ["lessons","correction","targets"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", () => {
        try { saveLocalNotes(true); } catch (_) {}
      });
      el.addEventListener("blur", () => {
        saveWeeklyReport(true);
      });
    });
    ["coreScore","coreMax","stackScore","stackMax","doorScore","doorMax"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", () => {
        try { saveLocalScores(true); } catch (_) {}
      });
      el.addEventListener("blur", () => {
        saveWeeklyReport(true);
      });
    });
  }

  function buildWeeklyReportMarkdown() {
    const week = isoWeekString();
    const scores = {
      coreScore: numVal("coreScore"),
      coreMax: numVal("coreMax") ?? 28,
      stackScore: numVal("stackScore"),
      stackMax: numVal("stackMax") ?? 7,
      doorScore: numVal("doorScore"),
      doorMax: numVal("doorMax") ?? 21
    };
    const notes = {
      lessons: document.getElementById("lessons").value || "",
      correction: document.getElementById("correction").value || "",
      targets: document.getElementById("targets").value || ""
    };
    const hasScores = [scores.coreScore, scores.stackScore, scores.doorScore].some(v => v != null);
    const hasNotes = [notes.lessons, notes.correction, notes.targets].some(v => v.trim());
    if (!hasScores && !hasNotes) return { week, markdown: "" };

    const md =
`# General's Tent - ${week}

## Component #1 - Return & Report
- Core: ${scores.coreScore ?? "__"} / ${scores.coreMax}
- Stack: ${scores.stackScore ?? "__"} / ${scores.stackMax}
- Door: ${scores.doorScore ?? "__"} / ${scores.doorMax}

## Component #2 - Lessons Learned
${(notes.lessons || "_empty_").trim()}

## Component #3 - Course Correction
${(notes.correction || "_empty_").trim()}

## Component #4 - New Targets
${(notes.targets || "_empty_").trim()}

---
Alpha Odyssey ‚Ä¢ Chapter 41
`;
    return { week, markdown: md };
  }

  function setUpdatedStamp() {
    const el = document.getElementById("stampPill");
    if (!el) return;
    el.textContent = "‚è≥ Updated: " + new Date().toLocaleString('de-DE');
  }

  async function saveWeeklyReport(silent = false) {
    const payload = buildWeeklyReportMarkdown();
    if (!payload.markdown) return;

    try {
      const res = await fetch("/api/generals/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ markdown: payload.markdown, week: payload.week })
      });
      const data = await res.json();
      if (data && data.ok) {
        if (silent) setUpdatedStamp();
        else flash("Weekly report saved.");
      } else if (!silent) {
        flash("Save failed.");
      }
    } catch (_) {
      if (!silent) flash("Save failed.");
    }
  }

  function flash(msg) {
    const el = document.getElementById("stampPill");
    const old = el.textContent;
    el.textContent = "‚ú® " + msg;
    setTimeout(() => { el.textContent = old; }, 1400);
  }

  function initTerminal() {
    const box = document.getElementById("terminalBox");
    if (!box) return;
    if (!window.Terminal) {
      box.innerHTML = "<em>Terminal unavailable (xterm.js missing).</em>";
      return;
    }
    const term = new window.Terminal({ cols: 120, rows: 24, convertEol: true });
    term.open(box);

    const proto = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${proto}://${location.host}/ws/terminal`);
    ws.addEventListener("message", (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === "output") term.write(msg.data);
      } catch (_) {}
    });
    term.onData((data) => {
      ws.send(JSON.stringify({ type: "input", data }));
    });
  }

  window.addEventListener("load", loadAll);
</script>
<script src="/vendor/xterm/xterm.js"></script>

</body>
</html>
