#!/usr/bin/env bash
set -euo pipefail

BACKUPCTL_VERSION="1.1.0"

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Codex session helper: backupctl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "main" "backupctl" "$@" && exit 0

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

# Shared UI helpers.
# shellcheck disable=SC1091
source "$SCRIPT_DIR/ctl-lib.sh"

SERVICE_NAME="aos-hub-backup-daily.service"
TIMER_NAME="aos-hub-backup-daily.timer"
BACKUP_SCRIPT="/usr/local/bin/aos-hub-backup-daily.sh"
CONFIG_FILE="/etc/aos-backup.conf"
USB_MOUNT="/mnt/eos-usb"
SRC_DIR="/home/alpha/aos-hub"
DST_DIR="${USB_MOUNT}/@aos-hub"
AOS_HUB_DIR="${AOS_HUB_DIR:-$HOME/aos-hub}"
SYNCVAULTCTL_FALLBACK="${AOS_HUB_DIR}/scripts/syncvaultctl"
VAULTCTL_FALLBACK="${AOS_HUB_DIR}/scripts/sync-utils/vaultctl"

need_systemctl() {
  need_cmd systemctl
}

systemctl_user() { systemctl --user "$@"; }

choose() {
  local prompt="$1"
  shift
  ui_choose "$prompt" "$@"
}

usage() {
  cat <<'EOF_HELP'
backupctl - manage/monitor daily aos-hub backup

Usage:
  backupctl [menu]
  backupctl status
  backupctl enable
  backupctl disable
  backupctl start
  backupctl run
  backupctl logs
  backupctl check
  backupctl doctor
  backupctl config
  backupctl sync
  backupctl pull
  backupctl sync-menu
  backupctl version

Notes:
  - enable/disable operates on the timer
  - start runs the service once
EOF_HELP
}

cmd_status() {
  need_systemctl
  systemctl_user status "$SERVICE_NAME" --no-pager || true
  echo ""
  systemctl_user status "$TIMER_NAME" --no-pager || true
}

cmd_enable() {
  need_systemctl
  systemctl_user enable --now "$TIMER_NAME"
}

cmd_disable() {
  need_systemctl
  systemctl_user disable --now "$TIMER_NAME"
}

cmd_start() {
  need_systemctl
  systemctl_user start "$SERVICE_NAME"
}

cmd_run() {
  if [[ ! -x "$BACKUP_SCRIPT" ]]; then
    ui_err "script missing: $BACKUP_SCRIPT"
    exit 1
  fi
  "$BACKUP_SCRIPT"
}

cmd_logs() {
  need_systemctl
  journalctl --user -u "$SERVICE_NAME" -n 200 --no-pager
}

cmd_check() {
  ui_title "backupctl check"
  ui_info "src: $SRC_DIR"
  ui_info "dst: $DST_DIR"
  if [[ -d "$SRC_DIR" ]]; then
    ui_ok "src present"
  else
    ui_warn "src missing"
  fi
  if mountpoint -q "$USB_MOUNT"; then
    ui_ok "usb mounted ($USB_MOUNT)"
    df -h "$USB_MOUNT" 2>/dev/null || true
  else
    ui_warn "usb not mounted ($USB_MOUNT)"
  fi
}

cmd_doctor() {
  cmd_check
}

cmd_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    ui_warn "config not found: $CONFIG_FILE"
    return 0
  fi
  if [[ -r "$CONFIG_FILE" ]]; then
    cat "$CONFIG_FILE"
    return 0
  fi
  if has_cmd sudo; then
    if sudo -n true 2>/dev/null; then
      sudo cat "$CONFIG_FILE"
      return 0
    fi
  fi
  ui_warn "config requires sudo: $CONFIG_FILE"
}

syncvaultctl_bin() {
  if has_cmd syncvaultctl; then
    echo "syncvaultctl"
    return 0
  fi
  if [[ -x "$SYNCVAULTCTL_FALLBACK" ]]; then
    echo "$SYNCVAULTCTL_FALLBACK"
    return 0
  fi
  return 1
}

vaultctl_bin() {
  if has_cmd vaultctl; then
    echo "vaultctl"
    return 0
  fi
  if [[ -x "$VAULTCTL_FALLBACK" ]]; then
    echo "$VAULTCTL_FALLBACK"
    return 0
  fi
  return 1
}

cmd_sync() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" sync
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" sync
    return 0
  fi
  ui_err "syncvaultctl/vaultctl not found"
  exit 1
}

cmd_pull() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" pull
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" pull
    return 0
  fi
  ui_err "syncvaultctl/vaultctl not found"
  exit 1
}

cmd_sync_menu() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" menu
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" menu
    return 0
  fi
  ui_err "syncvaultctl/vaultctl not found"
  exit 1
}

cmd_menu() {
  local actions=("status" "enable" "disable" "start" "run" "logs" "check" "config" "sync" "pull" "sync-menu" "quit")
  while true; do
    local action
    action="$(choose "backupctl" "${actions[@]}")" || { usage; return 1; }
    case "$action" in
      quit) return 0 ;;
      status) cmd_status ;;
      enable) cmd_enable ;;
      disable) cmd_disable ;;
      start) cmd_start ;;
      run) cmd_run ;;
      logs) cmd_logs ;;
      check) cmd_check ;;
      config) cmd_config ;;
      sync) cmd_sync ;;
      pull) cmd_pull ;;
      sync-menu) cmd_sync_menu ;;
    esac
    echo ""
  done
}

cmd_version() {
  echo "backupctl version $BACKUPCTL_VERSION"
}

case "${1:-}" in
  ""|menu) cmd_menu ;;
  -h|--help|help) usage ;;
  status) cmd_status ;;
  enable) cmd_enable ;;
  disable) cmd_disable ;;
  start) cmd_start ;;
  run) cmd_run ;;
  logs) cmd_logs ;;
  check) cmd_check ;;
  doctor) cmd_doctor ;;
  config) cmd_config ;;
  sync) cmd_sync ;;
  pull) cmd_pull ;;
  sync-menu) cmd_sync_menu ;;
  version) cmd_version ;;
  *)
    ui_err "unknown command: $1"
    usage
    exit 2
    ;;
esac
