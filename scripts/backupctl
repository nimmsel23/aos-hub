#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

SERVICE_NAME="aos-hub-backup-daily.service"
TIMER_NAME="aos-hub-backup-daily.timer"
BACKUP_SCRIPT="/usr/local/bin/aos-hub-backup-daily.sh"
CONFIG_FILE="/etc/aos-backup.conf"
USB_MOUNT="/mnt/eos-usb"
SRC_DIR="/home/alpha/aos-hub"
DST_DIR="${USB_MOUNT}/@aos-hub"
AOS_HUB_DIR="${AOS_HUB_DIR:-$HOME/aos-hub}"
SYNCVAULTCTL_FALLBACK="${AOS_HUB_DIR}/scripts/syncvaultctl"
VAULTCTL_FALLBACK="${AOS_HUB_DIR}/scripts/sync-utils/vaultctl"

have_gum() { command -v gum >/dev/null 2>&1; }
have_fzf() { command -v fzf >/dev/null 2>&1; }
have_tty() { [[ -t 0 || -t 1 || -t 2 ]] || [[ -r /dev/tty ]]; }

need_systemctl() {
  if ! command -v systemctl >/dev/null 2>&1; then
    echo "backupctl: systemctl not found" >&2
    exit 127
  fi
}

systemctl_user() { systemctl --user "$@"; }

choose() {
  local prompt="$1"
  shift
  local opts=("$@")
  if have_fzf; then
    printf "%s\n" "${opts[@]}" | fzf --prompt="backupctl> " --height=18 --reverse --border
    return $?
  fi
  if have_gum; then
    printf "%s\n" "${opts[@]}" | gum choose --header "$prompt"
    return $?
  fi
  if have_tty; then
    echo "$prompt"
    select opt in "${opts[@]}"; do
      echo "$opt"
      return 0
    done
  fi
  return 1
}

usage() {
  cat <<'EOF'
backupctl - manage/monitor daily aos-hub backup

Usage:
  backupctl [menu]
  backupctl status
  backupctl enable
  backupctl disable
  backupctl start
  backupctl run
  backupctl logs
  backupctl check
  backupctl config
  backupctl sync
  backupctl pull
  backupctl sync-menu

Notes:
  - enable/disable operates on the timer
  - start runs the service once
EOF
}

cmd_status() {
  need_systemctl
  systemctl_user status "$SERVICE_NAME" --no-pager || true
  echo ""
  systemctl_user status "$TIMER_NAME" --no-pager || true
}

cmd_enable() {
  need_systemctl
  systemctl_user enable --now "$TIMER_NAME"
}

cmd_disable() {
  need_systemctl
  systemctl_user disable --now "$TIMER_NAME"
}

cmd_start() {
  need_systemctl
  systemctl_user start "$SERVICE_NAME"
}

cmd_run() {
  if [[ ! -x "$BACKUP_SCRIPT" ]]; then
    echo "backupctl: script missing: $BACKUP_SCRIPT" >&2
    exit 1
  fi
  "$BACKUP_SCRIPT"
}

cmd_logs() {
  need_systemctl
  journalctl --user -u "$SERVICE_NAME" -n 200 --no-pager
}

cmd_check() {
  echo "backupctl check"
  echo "- src: $SRC_DIR"
  echo "- dst: $DST_DIR"
  if [[ -d "$SRC_DIR" ]]; then
    echo "  src: OK"
  else
    echo "  src: MISSING"
  fi
  if mountpoint -q "$USB_MOUNT"; then
    echo "  usb: mounted ($USB_MOUNT)"
    df -h "$USB_MOUNT" 2>/dev/null || true
  else
    echo "  usb: not mounted ($USB_MOUNT)"
  fi
}

cmd_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "backupctl: config not found: $CONFIG_FILE"
    return 0
  fi
  if [[ -r "$CONFIG_FILE" ]]; then
    cat "$CONFIG_FILE"
    return 0
  fi
  if command -v sudo >/dev/null 2>&1; then
    if sudo -n true 2>/dev/null; then
      sudo cat "$CONFIG_FILE"
      return 0
    fi
  fi
  echo "backupctl: config requires sudo: $CONFIG_FILE"
}

syncvaultctl_bin() {
  if command -v syncvaultctl >/dev/null 2>&1; then
    echo "syncvaultctl"
    return 0
  fi
  if [[ -x "$SYNCVAULTCTL_FALLBACK" ]]; then
    echo "$SYNCVAULTCTL_FALLBACK"
    return 0
  fi
  return 1
}

vaultctl_bin() {
  if command -v vaultctl >/dev/null 2>&1; then
    echo "vaultctl"
    return 0
  fi
  if [[ -x "$VAULTCTL_FALLBACK" ]]; then
    echo "$VAULTCTL_FALLBACK"
    return 0
  fi
  return 1
}

cmd_sync() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" sync
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" sync
    return 0
  fi
  echo "backupctl: syncvaultctl/vaultctl not found" >&2
  exit 1
}

cmd_pull() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" pull
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" pull
    return 0
  fi
  echo "backupctl: syncvaultctl/vaultctl not found" >&2
  exit 1
}

cmd_sync_menu() {
  local bin
  if bin="$(syncvaultctl_bin)"; then
    "$bin" menu
    return 0
  fi
  if bin="$(vaultctl_bin)"; then
    "$bin" menu
    return 0
  fi
  echo "backupctl: syncvaultctl/vaultctl not found" >&2
  exit 1
}

cmd_menu() {
  local actions=("status" "enable" "disable" "start" "run" "logs" "check" "config" "sync" "pull" "sync-menu" "quit")
  while true; do
    local action
    action="$(choose "backupctl" "${actions[@]}")" || { usage; return 1; }
    case "$action" in
      quit) return 0 ;;
      status) cmd_status ;;
      enable) cmd_enable ;;
      disable) cmd_disable ;;
      start) cmd_start ;;
      run) cmd_run ;;
      logs) cmd_logs ;;
      check) cmd_check ;;
      config) cmd_config ;;
      sync) cmd_sync ;;
      pull) cmd_pull ;;
      sync-menu) cmd_sync_menu ;;
    esac
    echo ""
  done
}

case "${1:-}" in
  ""|menu) cmd_menu ;;
  -h|--help|help) usage ;;
  status) cmd_status ;;
  enable) cmd_enable ;;
  disable) cmd_disable ;;
  start) cmd_start ;;
  run) cmd_run ;;
  logs) cmd_logs ;;
  check) cmd_check ;;
  config) cmd_config ;;
  sync) cmd_sync ;;
  pull) cmd_pull ;;
  sync-menu) cmd_sync_menu ;;
  *)
    echo "backupctl: unknown command: $1" >&2
    usage
    exit 2
    ;;
esac
