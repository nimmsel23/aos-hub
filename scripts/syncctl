#!/usr/bin/env bash
set -euo pipefail

# syncctl
# A small, readable frontdoor for the various rclone helpers in this repo.
#
# Design goals:
# - predictable behavior (no "silent nothing happens")
# - safe defaults (dry-run and skip symlinks unless you turn it on)
# - minimal interactive UI logic (gum if available, otherwise simple numbered prompts)

APP="syncctl"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd -P)"

# Codex session helper: syncctl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "main" "syncctl" "$@" && exit 0

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

# Shared UI/helpers.
# shellcheck disable=SC1091
source "$SCRIPT_DIR/ctl-lib.sh"
CTL_APP_PREFIX="$APP"

AOS_SYNC="${SCRIPT_DIR}/aos-sync"
VAULTCTL_PRIMARY="${SCRIPT_DIR}/sync-utils/vaultctl"
VAULTCTL_FALLBACK="${SCRIPT_DIR}/utils/vaultctl"
DOMAIN_PRIMARY="${SCRIPT_DIR}/sync-utils/rclone-domain-sync.sh"
DOMAIN_FALLBACK="${SCRIPT_DIR}/utils/rclone-domain-sync.sh"
VITAL_PRIMARY="${SCRIPT_DIR}/sync-utils/rclone-vitaltrainer-copy.sh"
VITAL_FALLBACK="${SCRIPT_DIR}/utils/rclone-vitaltrainer-copy.sh"
FADARO_PRIMARY="${SCRIPT_DIR}/sync-utils/rclone-fadaro-push.sh"
HUB_LIVE_PRIMARY="${SCRIPT_DIR}/sync-utils/rclone-aos-hub-live-push.sh"
HUB_LIVE_FALLBACK="${SCRIPT_DIR}/utils/rclone-aos-hub-live-push.sh"

have_tty() { [[ -t 0 && -t 1 ]]; }
gum_tty_available() { has_gum && [[ -t 1 ]]; }

pick_bin() {
  local primary="$1"
  local fallback="$2"
  local name="$3"

  if [[ -n "$primary" && -x "$primary" ]]; then
    printf "%s\n" "$primary"
    return 0
  fi
  if [[ -n "$fallback" && -x "$fallback" ]]; then
    printf "%s\n" "$fallback"
    return 0
  fi
  if [[ -n "$name" ]] && has_cmd "$name"; then
    command -v "$name"
    return 0
  fi
  return 1
}

doctor_tty() {
  local in_tty="no" out_tty="no" err_tty="no"
  [[ -t 0 ]] && in_tty="yes"
  [[ -t 1 ]] && out_tty="yes"
  [[ -t 2 ]] && err_tty="yes"

  echo "syncctl doctor-tty"
  echo "  stdin tty : $in_tty"
  echo "  stdout tty: $out_tty"
  echo "  stderr tty: $err_tty"
  echo "  TERM      : ${TERM:-}"
  echo "  SSH_TTY   : ${SSH_TTY:-}"
  if [[ -e /dev/tty ]]; then
    if [[ -r /dev/tty && -w /dev/tty ]]; then
      echo "  /dev/tty  : readable+writable"
    else
      echo "  /dev/tty  : exists, but not readable/writable"
    fi
  else
    echo "  /dev/tty  : missing"
  fi
}

doctor_path_collisions() {
  local name="$1"
  if ! has_cmd "$name"; then
    return 0
  fi
  local -a hits=()
  mapfile -t hits < <(type -a "$name" 2>/dev/null | sed -n "s/^${name} is //p")
  local count="${#hits[@]}"
  if (( count <= 1 )); then
    return 0
  fi
  ui_warn "PATH collision for '$name' (${count} entries)"
  local i=0
  for p in "${hits[@]}"; do
    if (( i == 0 )); then
      ui_info "  active: $p"
    else
      ui_info "  shadow: $p"
    fi
    i=$((i + 1))
  done
}

doctor() {
  ui_title "syncctl doctor"

  if has_cmd rclone; then
    ui_ok "rclone binary found"
  else
    ui_warn "rclone binary missing in PATH"
  fi

  if [[ -f "${AOS_RCLONE_CONFIG:-$HOME/.config/rclone/rclone.conf}" ]]; then
    ui_ok "rclone config present"
  else
    ui_warn "rclone config missing"
  fi

  doctor_path_collisions syncctl
  doctor_path_collisions vaultctl
  doctor_path_collisions backupctl

  local bin=""
  if bin="$(pick_bin "$VAULTCTL_PRIMARY" "$VAULTCTL_FALLBACK" "vaultctl")"; then
    ui_ok "vaultctl resolved: $bin"
  else
    ui_warn "vaultctl not found"
  fi
  if bin="$(pick_bin "$DOMAIN_PRIMARY" "$DOMAIN_FALLBACK" "")"; then
    ui_ok "domain script resolved: $bin"
  else
    ui_warn "rclone-domain-sync.sh not found"
  fi
  if bin="$(pick_bin "$VITAL_PRIMARY" "$VITAL_FALLBACK" "")"; then
    ui_ok "vitaltrainer script resolved: $bin"
  else
    ui_warn "rclone-vitaltrainer-copy.sh not found"
  fi
}

ensure_menu_tty() {
  if have_tty; then
    return 0
  fi
  if [[ -r /dev/tty && -w /dev/tty ]]; then
    exec </dev/tty >/dev/tty 2>/dev/tty
  fi
  have_tty
}

SYNCCTL_DRY_RUN="${AOS_DRY_RUN:-0}"
SYNCCTL_COPY_LINKS="${AOS_COPY_LINKS:-0}"
SYNCCTL_BACKUP_OVERWRITES="${AOS_SYNC_BACKUP_OVERWRITES:-1}"
SYNCCTL_BACKUP_BASE_REMOTE="${AOS_SYNC_BACKUP_BASE_REMOTE:-_aos-overwrite-backups}"
SYNCCTL_BACKUP_BASE_LOCAL="${AOS_SYNC_BACKUP_BASE_LOCAL:-$HOME/.local/share/alphaos/overwrite-backups}"
export AOS_COPY_LINKS="${SYNCCTL_COPY_LINKS}"
export AOS_SYNC_BACKUP_OVERWRITES="${SYNCCTL_BACKUP_OVERWRITES}"
export AOS_SYNC_BACKUP_BASE_REMOTE="${SYNCCTL_BACKUP_BASE_REMOTE}"
export AOS_SYNC_BACKUP_BASE_LOCAL="${SYNCCTL_BACKUP_BASE_LOCAL}"

badge() {
  local run links backups
  [[ "${SYNCCTL_DRY_RUN}" == "1" ]] && run="DRY-RUN (no changes)" || run="RUN (makes changes)"
  [[ "${SYNCCTL_COPY_LINKS}" == "1" ]] && links="Symlinks: COPY contents" || links="Symlinks: SKIP"
  [[ "${SYNCCTL_BACKUP_OVERWRITES}" == "1" ]] && backups="Overwrite backup: ON" || backups="Overwrite backup: OFF"
  printf "%s | %s | %s" "$run" "$links" "$backups"
}

toggle_dry_run() {
  if [[ "${SYNCCTL_DRY_RUN}" == "1" ]]; then
    SYNCCTL_DRY_RUN=0
  else
    SYNCCTL_DRY_RUN=1
  fi
}

toggle_copy_links() {
  if [[ "${SYNCCTL_COPY_LINKS}" == "1" ]]; then
    SYNCCTL_COPY_LINKS=0
  else
    SYNCCTL_COPY_LINKS=1
  fi
  export AOS_COPY_LINKS="${SYNCCTL_COPY_LINKS}"
}

toggle_backup_overwrites() {
  if [[ "${SYNCCTL_BACKUP_OVERWRITES}" == "1" ]]; then
    SYNCCTL_BACKUP_OVERWRITES=0
  else
    SYNCCTL_BACKUP_OVERWRITES=1
  fi
  export AOS_SYNC_BACKUP_OVERWRITES="${SYNCCTL_BACKUP_OVERWRITES}"
}

print_safety_notes() {
  cat <<'EOF'
Safety / mental model
---------------------

The two most common ways to lose data with rclone are:
1) pointing at the wrong remote path, especially the Drive root, and
2) using a destructive mode (sync/bisync) without a dry-run first.

Remote paths:
  - "eldanioo:" (no folder after the colon) means: Drive root.
    That is almost never what you want because it can pull your entire "Meine Ablage"
    into a local folder if you run a sync/bisync.
  - Use a specific folder path instead, for example: "eldanioo:business" or "eldanioo:Dokumente".
    A leading slash like "eldanioo:/business" is usually equivalent to "eldanioo:business".

Modes (roughly from safest to most dangerous):
  - copy push/pull: uploads/downloads new and changed files, but does not delete on the destination.
  - sync: mirrors one side into the other and can delete files on the destination.
  - bisync: two-way mirroring and can delete files on BOTH sides.

Symlinks:
  - Default here is to SKIP symlinks because they can point outside the folder.
  - If you enable link copying, rclone copies the link target contents (it does not preserve the symlink).

Dry-run:
  - Dry-run prints what would happen, but does not upload/download/delete anything.
  - If you are unsure, dry-run first.

Overwrite backups:
  - syncctl defaults to backup overwritten/deleted destination files via rclone --backup-dir.
  - Remote backups go under AOS_SYNC_BACKUP_BASE_REMOTE (default: _aos-overwrite-backups).
  - Local pull backups go under AOS_SYNC_BACKUP_BASE_LOCAL.
EOF
}

usage() {
  cat <<'EOF'
syncctl — rclone sync frontdoor

This tool is intentionally small. Most of the real work happens in:
  - aos-sync (targets + timers)
  - vaultctl (copy push/pull)
  - rclone-domain-sync.sh (domain copy)
  - rclone-vitaltrainer-copy.sh (Vitaltrainer)

Common:
  syncctl overview [--long]
  syncctl summary [--long]
  syncctl menu
  syncctl safety
  syncctl doctor
  syncctl doctor-tty
  syncctl install-cli [--user|--system]
  syncctl uninstall-cli [--user|--system]
  syncctl fix-path [--dry-run]

Targets (aos-sync):
  syncctl list
  syncctl status [--brief|--long|<target>]
  syncctl run <target> [--dry] [--mode sync|bisync] [--resync]
  syncctl enable <target> [--at HH:MM]
  syncctl disable <target>
  syncctl logs <target> [--follow]
  syncctl doctor <target>

Vault copy (vaultctl):
  syncctl vault <status|sync|pull|sync-root|pull-root|sync-all|pull-all|sync-vitaltrainer|pull-vitaltrainer|logs|timers|watch> [args...]

Domains copy:
  syncctl domains <DOMAIN> <push|pull|push-sync|sync|status|log> [--dry-run]
  syncctl domains status-all

Vitaltrainer copy:
  syncctl vitaltrainer <push|pull|status> [--dry-run]

FADARO push:
  syncctl fadaro [--dry-run]

aos-hub live backup:
  syncctl hub <status|push> [--dry-run]

Overwrite-backup env:
  AOS_SYNC_BACKUP_OVERWRITES=1
  AOS_SYNC_BACKUP_BASE_REMOTE=_aos-overwrite-backups
  AOS_SYNC_BACKUP_BASE_LOCAL=$HOME/.local/share/alphaos/overwrite-backups
EOF
}

section_title() {
  local title="$1"
  echo ""
  echo "$title"
  echo "----------------------------------------"
}

syncctl_color_enabled() {
  [[ -t 1 && -z "${NO_COLOR:-}" ]]
}

syncctl_color() {
  local code="$1"
  local text="$2"
  if syncctl_color_enabled; then
    printf "\033[%sm%s\033[0m" "$code" "$text"
  else
    printf "%s" "$text"
  fi
}

syncctl_chip() {
  local state="$1"
  case "$state" in
    ok) syncctl_color "1;32" "OK" ;;
    warn) syncctl_color "1;33" "WARN" ;;
    err) syncctl_color "1;31" "ERR" ;;
    info|*) syncctl_color "1;36" "INFO" ;;
  esac
}

print_flow_row() {
  local flow="$1"
  local direction="$2"
  local local_path="$3"
  local remote_path="$4"
  local local_state="MISSING"
  if [[ -d "$local_path" ]]; then
    local_state="OK"
  fi

  printf "  %-18s %-4s %-8s %s\n" "$flow" "$direction" "$local_state" "$local_path"
  printf "  %-18s %-4s %-8s %s\n" "" "" "REMOTE" "$remote_path"
}

print_flow_row_compact() {
  local flow="$1"
  local direction="$2"
  local local_path="$3"
  local remote_path="$4"
  local local_state="warn"
  if [[ -d "$local_path" ]]; then
    local_state="ok"
  fi
  printf "  %-16s %-3s [%s] %s -> %s\n" \
    "$flow" "$direction" "$(syncctl_chip "$local_state")" "$local_path" "$remote_path"
}

print_timer_row() {
  local unit="$1"
  local enabled active
  enabled="$(systemctl --user is-enabled "$unit" 2>/dev/null || true)"
  active="$(systemctl --user is-active "$unit" 2>/dev/null || true)"
  [[ -z "$enabled" ]] && enabled="-"
  [[ -z "$active" ]] && active="-"
  printf "  %-32s enabled=%-12s active=%s\n" "$unit" "$enabled" "$active"
}

print_timer_row_compact() {
  local unit="$1"
  local enabled active
  enabled="$(systemctl --user is-enabled "$unit" 2>/dev/null || true)"
  active="$(systemctl --user is-active "$unit" 2>/dev/null || true)"
  [[ -z "$enabled" ]] && enabled="-"
  [[ -z "$active" ]] && active="-"
  local state="warn"
  if [[ "$active" == "active" ]]; then
    state="ok"
  elif [[ "$enabled" == "not-found" ]]; then
    state="err"
  fi
  printf "  %-30s [%s] enabled=%s active=%s\n" "$unit" "$(syncctl_chip "$state")" "$enabled" "$active"
}

show_overview() {
  local long_mode=0
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --long|-l) long_mode=1 ;;
      *)
        die "Usage: syncctl overview [--long]"
        ;;
    esac
    shift || true
  done

  ui_title "syncctl overview"
  ui_info "$(badge)"
  section_title "Runtime"
  if has_cmd rclone; then
    printf "  [%s] rclone %s\n" "$(syncctl_chip ok)" "$(command -v rclone)"
  else
    printf "  [%s] rclone not found\n" "$(syncctl_chip err)"
  fi
  if [[ -f "${AOS_RCLONE_CONFIG:-$HOME/.config/rclone/rclone.conf}" ]]; then
    printf "  [%s] config %s\n" "$(syncctl_chip ok)" "${AOS_RCLONE_CONFIG:-$HOME/.config/rclone/rclone.conf}"
  else
    printf "  [%s] config missing %s\n" "$(syncctl_chip warn)" "${AOS_RCLONE_CONFIG:-$HOME/.config/rclone/rclone.conf}"
  fi

  if [[ "$long_mode" == "1" ]]; then
    section_title "Backup Policy"
    printf "  overwrite backups: %s\n" "$([[ "${SYNCCTL_BACKUP_OVERWRITES}" == "1" ]] && echo "ON" || echo "OFF")"
    printf "  remote backup base: %s\n" "${SYNCCTL_BACKUP_BASE_REMOTE}"
    printf "  local backup base:  %s\n" "${SYNCCTL_BACKUP_BASE_LOCAL}"

    section_title "Vault"
    local vault_root
    vault_root="${AOS_VAULT_ROOT:-${AOS_RCLONE_LOCAL:-${AOS_VAULT_DIR:-$HOME/AlphaOS-Vault}}}"
    print_flow_row "Vault:Game"  "<->" "$vault_root/Game"  "${AOS_VAULT_REMOTE_GAME:-eldanioo:Alpha_Game}"
    print_flow_row "Vault:Door"  "<->" "$vault_root/Door"  "${AOS_VAULT_REMOTE_DOOR:-eldanioo:Alpha_Door}"
    print_flow_row "Vault:Voice" "<->" "$vault_root/Voice" "${AOS_VAULT_REMOTE_VOICE:-eldanioo:Alpha_Voice}"
    print_flow_row "Vault:Core4" "<->" "$vault_root/Core4" "${AOS_VAULT_REMOTE_CORE4:-eldanioo:Alpha_Core4}"

    section_title "Domains"
    local domain_local_base domain_remote_base domain_remote_name
    domain_local_base="${AOS_DOMAIN_LOCAL_BASE:-$HOME/Dokumente}"
    domain_remote_base="${AOS_DOMAIN_REMOTE_BASE:-}"
    domain_remote_name="${AOS_RCLONE_REMOTE_NAME:-eldanioo}"
    print_flow_row "Domain:BODY"     "<->" "$domain_local_base/BODY"     "${domain_remote_name}:${domain_remote_base}BODY"
    print_flow_row "Domain:BEING"    "<->" "$domain_local_base/BEING"    "${domain_remote_name}:${domain_remote_base}BEING"
    print_flow_row "Domain:BALANCE"  "<->" "$domain_local_base/BALANCE"  "${domain_remote_name}:${domain_remote_base}BALANCE"
    print_flow_row "Domain:BUSINESS" "<->" "$domain_local_base/BUSINESS" "${domain_remote_name}:${domain_remote_base}BUSINESS"

    section_title "Other Flows"
    local remote_name
    remote_name="${AOS_RCLONE_REMOTE_NAME:-eldanioo}"
    print_flow_row "Vitaltrainer" "<->" "${AOS_VITALTRAINER_LOCAL_PATH:-$HOME/Dokumente/BUSINESS/Vitaltrainer}" "${remote_name}:${AOS_VITALTRAINER_REMOTE_PATH:-Vitaltrainer}"
    print_flow_row "FADARO"       "->"  "${AOS_FADARO_LOCAL_PATH:-$HOME/Dokumente/BUSINESS/FADARO}"             "${remote_name}:${AOS_FADARO_REMOTE_PATH:-FADARO}"
    print_flow_row "Dokumente"    "->"  "${AOS_DOKUMENTE_LOCAL_PATH:-$HOME/Dokumente}"                           "${AOS_DOKUMENTE_REMOTE:-eldanioo:Dokumente}"
    print_flow_row "aos-hub live" "->"  "${AOS_AOS_HUB_LOCAL_PATH:-$HOME/aos-hub}"                                "${AOS_AOS_HUB_REMOTE:-eldanioo:aos-hub-live}"

    section_title "Timers"
    if has_cmd systemctl; then
      local -a timers=(
        "${AOS_HUB_LIVE_TIMER_UNIT:-aos-hub-live-push.timer}"
        "${AOS_HUB_ROUTINE_TIMER_UNIT:-aos-hub-backup-daily.timer}"
        "${AOS_VAULT_SYNC_TIMER_UNIT:-alphaos-vault-sync.timer}"
        "${AOS_SAFE_RCLONE_PUSH_TIMER_UNIT:-alphaos-safe-rclone-push.timer}"
      )
      local t
      for t in "${timers[@]}"; do
        [[ -z "$t" ]] && continue
        print_timer_row "$t"
      done

      local -a aos_sync_timers=()
      mapfile -t aos_sync_timers < <(systemctl --user list-unit-files "aos-sync-*.timer" --no-legend --no-pager 2>/dev/null | awk '{print $1}')
      if [[ "${#aos_sync_timers[@]}" -gt 0 ]]; then
        echo ""
        ui_info "aos-sync target timers"
        for t in "${aos_sync_timers[@]}"; do
          [[ -z "$t" ]] && continue
          print_timer_row "$t"
        done
      fi
    else
      printf "  [%s] systemctl missing\n" "$(syncctl_chip warn)"
    fi

    section_title "Quick Commands"
    echo "  syncctl vault sync --dry-run"
    echo "  syncctl domains status-all"
    echo "  syncctl hub status"
    return 0
  fi

  section_title "Flows"
  local vault_root
  vault_root="${AOS_VAULT_ROOT:-${AOS_RCLONE_LOCAL:-${AOS_VAULT_DIR:-$HOME/AlphaOS-Vault}}}"
  local domain_local_base domain_remote_base domain_remote_name
  domain_local_base="${AOS_DOMAIN_LOCAL_BASE:-$HOME/Dokumente}"
  domain_remote_base="${AOS_DOMAIN_REMOTE_BASE:-}"
  domain_remote_name="${AOS_RCLONE_REMOTE_NAME:-eldanioo}"
  local remote_name
  remote_name="${AOS_RCLONE_REMOTE_NAME:-eldanioo}"
  print_flow_row_compact "Vault:Game" "<->" "$vault_root/Game" "${AOS_VAULT_REMOTE_GAME:-eldanioo:Alpha_Game}"
  print_flow_row_compact "Vault:Door" "<->" "$vault_root/Door" "${AOS_VAULT_REMOTE_DOOR:-eldanioo:Alpha_Door}"
  print_flow_row_compact "Vault:Voice" "<->" "$vault_root/Voice" "${AOS_VAULT_REMOTE_VOICE:-eldanioo:Alpha_Voice}"
  print_flow_row_compact "Vault:Core4" "<->" "$vault_root/Core4" "${AOS_VAULT_REMOTE_CORE4:-eldanioo:Alpha_Core4}"
  print_flow_row_compact "Domain:BODY" "<->" "$domain_local_base/BODY" "${domain_remote_name}:${domain_remote_base}BODY"
  print_flow_row_compact "Domain:BEING" "<->" "$domain_local_base/BEING" "${domain_remote_name}:${domain_remote_base}BEING"
  print_flow_row_compact "Domain:BALANCE" "<->" "$domain_local_base/BALANCE" "${domain_remote_name}:${domain_remote_base}BALANCE"
  print_flow_row_compact "Domain:BUSINESS" "<->" "$domain_local_base/BUSINESS" "${domain_remote_name}:${domain_remote_base}BUSINESS"
  print_flow_row_compact "Vitaltrainer" "<->" "${AOS_VITALTRAINER_LOCAL_PATH:-$HOME/Dokumente/BUSINESS/Vitaltrainer}" "${remote_name}:${AOS_VITALTRAINER_REMOTE_PATH:-Vitaltrainer}"
  print_flow_row_compact "FADARO" "->" "${AOS_FADARO_LOCAL_PATH:-$HOME/Dokumente/BUSINESS/FADARO}" "${remote_name}:${AOS_FADARO_REMOTE_PATH:-FADARO}"
  print_flow_row_compact "Dokumente" "->" "${AOS_DOKUMENTE_LOCAL_PATH:-$HOME/Dokumente}" "${AOS_DOKUMENTE_REMOTE:-eldanioo:Dokumente}"
  print_flow_row_compact "aos-hub live" "->" "${AOS_AOS_HUB_LOCAL_PATH:-$HOME/aos-hub}" "${AOS_AOS_HUB_REMOTE:-eldanioo:aos-hub-live}"

  section_title "Timers"
  if has_cmd systemctl; then
    local -a timers=(
      "${AOS_HUB_LIVE_TIMER_UNIT:-aos-hub-live-push.timer}"
      "${AOS_HUB_ROUTINE_TIMER_UNIT:-aos-hub-backup-daily.timer}"
      "${AOS_VAULT_SYNC_TIMER_UNIT:-alphaos-vault-sync.timer}"
      "${AOS_SAFE_RCLONE_PUSH_TIMER_UNIT:-alphaos-safe-rclone-push.timer}"
    )
    local t
    for t in "${timers[@]}"; do
      [[ -z "$t" ]] && continue
      print_timer_row_compact "$t"
    done
  else
    printf "  [%s] systemctl missing\n" "$(syncctl_chip warn)"
  fi
}

install_cli_user() {
  local src="$ROOT_DIR/scripts/syncctl"
  local bin_dir="${SYNCCTL_BIN_DIR:-$HOME/.local/bin}"
  local dst="$bin_dir/syncctl"
  [[ -x "$src" ]] || die "source script missing or not executable: $src"
  mkdir -p "$bin_dir" 2>/dev/null || die "cannot create: $bin_dir"
  if [[ -e "$dst" && ! -L "$dst" ]]; then
    die "refusing to overwrite non-symlink: $dst"
  fi
  ln -sfn "$src" "$dst"
  ui_ok "installed: $dst -> $src"
  if [[ ":$PATH:" != *":$bin_dir:"* ]]; then
    ui_warn "PATH does not include $bin_dir"
    ui_info "add with: export PATH=\"$bin_dir:\$PATH\""
  fi
}

install_cli_system() {
  local src="$ROOT_DIR/scripts/syncctl"
  local bin_dir="/usr/local/bin"
  local dst="$bin_dir/syncctl"
  [[ -x "$src" ]] || die "source script missing or not executable: $src"
  if [[ "$EUID" -eq 0 ]]; then
    install -d -m 755 "$bin_dir"
    ln -sfn "$src" "$dst"
  elif has_cmd sudo; then
    sudo install -d -m 755 "$bin_dir"
    sudo ln -sfn "$src" "$dst"
  else
    die "sudo is required for --system install"
  fi
  ui_ok "installed: $dst -> $src"
}

cmd_install_cli() {
  local mode="${1:---user}"
  case "$mode" in
    --user) install_cli_user ;;
    --system) install_cli_system ;;
    *)
      die "Usage: syncctl install-cli [--user|--system]"
      ;;
  esac
}

cmd_uninstall_cli() {
  local mode="${1:---user}"
  local dst=""
  case "$mode" in
    --user)
      dst="${SYNCCTL_BIN_DIR:-$HOME/.local/bin}/syncctl"
      if [[ -L "$dst" ]]; then
        rm -f "$dst"
        ui_ok "removed: $dst"
      else
        ui_info "nothing to remove at: $dst"
      fi
      ;;
    --system)
      dst="/usr/local/bin/syncctl"
      if [[ "$EUID" -eq 0 ]]; then
        [[ -e "$dst" || -L "$dst" ]] && rm -f "$dst" || true
      elif has_cmd sudo; then
        sudo rm -f "$dst"
      else
        die "sudo is required for --system uninstall"
      fi
      ui_ok "removed: $dst"
      ;;
    *)
      die "Usage: syncctl uninstall-cli [--user|--system]"
      ;;
  esac
}

fix_path_for_command() {
  local name="$1"
  local canonical="$2"
  local dry_run="$3"
  local -a managed=("$HOME/bin/$name" "$HOME/.local/bin/$name")
  local p=""

  for p in "${managed[@]}"; do
    [[ -e "$p" || -L "$p" ]] || continue
    local rp=""
    rp="$(readlink -f "$p" 2>/dev/null || true)"
    if [[ "$rp" == "$canonical" ]]; then
      ui_ok "$name path already canonical: $p -> $canonical"
      continue
    fi
    if [[ -L "$p" ]]; then
      if [[ "$dry_run" == "1" ]]; then
        ui_info "dry-run: would remove shadow symlink: $p"
      else
        rm -f "$p"
        ui_ok "removed shadow symlink: $p"
      fi
    else
      ui_warn "not a symlink, skipped: $p"
    fi
  done

  local dst="$HOME/.local/bin/$name"
  if [[ "$dry_run" == "1" ]]; then
    ui_info "dry-run: would ensure canonical link: $dst -> $canonical"
  else
    mkdir -p "$HOME/.local/bin" 2>/dev/null || true
    if [[ -e "$dst" && ! -L "$dst" ]]; then
      ui_warn "cannot overwrite non-symlink: $dst"
    else
      ln -sfn "$canonical" "$dst"
      ui_ok "installed canonical link: $dst -> $canonical"
    fi
  fi
}

cmd_fix_path() {
  local dry_run=0
  if [[ "${1:-}" == "--dry-run" ]]; then
    dry_run=1
  elif [[ -n "${1:-}" ]]; then
    die "Usage: syncctl fix-path [--dry-run]"
  fi

  ui_title "syncctl fix-path"
  fix_path_for_command "syncctl" "$ROOT_DIR/scripts/syncctl" "$dry_run"
  fix_path_for_command "backupctl" "$ROOT_DIR/scripts/backupctl" "$dry_run"
  fix_path_for_command "vaultctl" "$ROOT_DIR/scripts/sync-utils/vaultctl" "$dry_run"
  ui_info "run 'hash -r' and then 'type -a syncctl backupctl vaultctl'"
}

choose_plain() {
  local prompt="$1"
  shift
  local -a options=("$@")

  echo ""
  echo "$prompt"
  local i=1
  for opt in "${options[@]}"; do
    printf "  [%s] %s\n" "$i" "$opt"
    i=$((i + 1))
  done
  echo "  [q] Back/quit"
  printf "> "

  local reply
  IFS= read -r reply || return 1
  if [[ -z "$reply" || "$reply" =~ ^[qQ]$ ]]; then
    return 1
  fi
  if [[ "$reply" =~ ^[0-9]+$ ]] && (( reply >= 1 && reply <= ${#options[@]} )); then
    printf "%s" "${options[$((reply - 1))]}"
    return 0
  fi
  echo "Please enter a number from 1..${#options[@]}, or 'q'." >&2
  return 2
}

sync_choose() {
  local prompt="$1"
  shift
  local -a options=("$@")

  if gum_tty_available; then
    gum choose --header "$prompt" "${options[@]}"
    return $?
  fi

  while true; do
    local out=""
    if out="$(choose_plain "$prompt" "${options[@]}")"; then
      printf "%s" "$out"
      return 0
    fi
    local rc=$?
    if [[ "$rc" -eq 1 ]]; then
      return 1
    fi
  done
}

pause() {
  if gum_tty_available; then
    gum input --prompt "Press Enter to continue > " --value "" >/dev/null 2>&1 || true
  else
    read -r -p "Press Enter to continue..." _ || true
  fi
}

run_aos_sync() {
  local bin
  bin="$(pick_bin "$AOS_SYNC" "" "aos-sync")" || die "aos-sync not found"
  exec "$bin" "$@"
}

run_vault() {
  local bin
  bin="$(pick_bin "$VAULTCTL_PRIMARY" "$VAULTCTL_FALLBACK" "vaultctl")" || die "vaultctl not found"
  exec "$bin" "$@"
}

run_domains() {
  local bin
  bin="$(pick_bin "$DOMAIN_PRIMARY" "$DOMAIN_FALLBACK" "")" || die "rclone-domain-sync.sh not found"

  local sub="${1:-}"
  if [[ -z "$sub" || "$sub" == "status-all" ]]; then
    for d in BODY BEING BALANCE BUSINESS; do
      "$bin" "$d" status
    done
    exit 0
  fi

  local domain="$1"
  shift || true
  [[ -n "$domain" ]] || die "domains requires <DOMAIN>"
  exec "$bin" "$domain" "$@"
}

run_vitaltrainer() {
  local bin
  bin="$(pick_bin "$VITAL_PRIMARY" "$VITAL_FALLBACK" "")" || die "rclone-vitaltrainer-copy.sh not found"
  exec "$bin" "$@"
}

run_fadaro() {
  local bin
  bin="$(pick_bin "$FADARO_PRIMARY" "" "")" || die "rclone-fadaro-push.sh not found"
  exec "$bin" "$@"
}

run_hub_live() {
  local bin
  bin="$(pick_bin "$HUB_LIVE_PRIMARY" "$HUB_LIVE_FALLBACK" "")" || die "rclone-aos-hub-live-push.sh not found"
  exec "$bin" "$@"
}

menu_targets() {
  local bin
  bin="$(pick_bin "$AOS_SYNC" "" "aos-sync")" || die "aos-sync not found"

  local -a targets=()
  mapfile -t targets < <("$bin" list 2>/dev/null || true)
  if [[ "${#targets[@]}" -eq 0 ]]; then
    echo "I cannot find any configured targets right now." >&2
    echo "If you expected targets, check your sync.d/*.env files." >&2
    pause
    return 0
  fi

  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local t
    t="$(sync_choose "Select a target. This lists configured target files; it does not run anything yet." "${targets[@]}")" || return 0

    while true; do
      echo ""
      echo "Target: $t"
      echo "Current mode: $(badge)"
      local a
      a="$(sync_choose "Choose what you want to do. If you are unsure, start with Status or Doctor." \
        "Status" \
        "Doctor (explain configuration)" \
        "Run (sync)" \
        "Run (bisync — can delete on both sides)" \
        "Enable timer" \
        "Disable timer" \
        "Logs" \
        "Back")" || break

      case "$a" in
        "Status") "$bin" status "$t" ;;
        "Doctor (explain configuration)") "$bin" doctor "$t" ;;
        "Run (sync)")
          if [[ "${SYNCCTL_DRY_RUN}" == "1" ]]; then
            "$bin" run "$t" --dry --mode sync
          else
            "$bin" run "$t" --mode sync
          fi
          ;;
        "Run (bisync — can delete on both sides)")
          if [[ "${SYNCCTL_DRY_RUN}" == "1" ]]; then
            "$bin" run "$t" --dry --mode bisync
          else
            "$bin" run "$t" --mode bisync
          fi
          ;;
        "Enable timer")
          echo ""
          echo "This creates/enables a systemd user timer for the target."
          echo "If you are unsure, do not enable timers until a dry-run looks correct."
          local at=""
          read -r -p "Enable at (HH:MM, empty=default): " at || true
          if [[ -n "$at" ]]; then
            "$bin" enable "$t" --at "$at"
          else
            "$bin" enable "$t"
          fi
          ;;
        "Disable timer") "$bin" disable "$t" ;;
        "Logs") "$bin" logs "$t" ;;
        "Back") break ;;
      esac
      pause
    done
  done
}

menu_vault() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "Vault copy uses rclone copy (no deletes). If you are unsure, use dry-run first." \
      "Status" \
      "Push now (copy)" \
      "Pull now (copy)" \
      "Push all (root + sections)" \
      "Pull all (root + sections)" \
      "Logs" \
      "Timers" \
      "Back")" || return 0

    case "$a" in
      "Status") run_vault status ;;
      "Push now (copy)") run_vault sync $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Pull now (copy)") run_vault pull $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Push all (root + sections)") run_vault sync-all $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Pull all (root + sections)") run_vault pull-all $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Logs") run_vault logs ;;
      "Timers") run_vault timers ;;
      "Back") return 0 ;;
    esac
    pause
  done
}

menu_domains() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local domain
    domain="$(sync_choose "Select a domain. Domain copy is usually safe (copy push/pull). 'push-sync' is destructive." \
      "BODY" "BEING" "BALANCE" "BUSINESS" "Status all" "Back")" || return 0

    case "$domain" in
      "Back") return 0 ;;
      "Status all") run_domains status-all; pause; continue ;;
    esac

    while true; do
      echo ""
      echo "Domain: $domain"
      echo "Current mode: $(badge)"
      local a
      a="$(sync_choose "Choose an action. If you are unsure, start with Status and then a dry-run Push." \
        "Status" \
        "Push now (copy)" \
        "Pull now (copy)" \
        "Push-sync (delete remote files that are not present locally)" \
        "Log" \
        "Back")" || break

      case "$a" in
        "Status") run_domains "$domain" status ;;
        "Push now (copy)") run_domains "$domain" push $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
        "Pull now (copy)") run_domains "$domain" pull $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
        "Push-sync (delete remote files that are not present locally)") run_domains "$domain" push-sync $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
        "Log") run_domains "$domain" log ;;
        "Back") break ;;
      esac
      pause
    done
  done
}

menu_vitaltrainer() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "Vitaltrainer copy uses rclone copy. It does not delete on the destination." \
      "Status" \
      "Push now (copy)" \
      "Pull now (copy)" \
      "Back")" || return 0

    case "$a" in
      "Status") run_vitaltrainer status ;;
      "Push now (copy)") run_vitaltrainer push $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Pull now (copy)") run_vitaltrainer pull $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Back") return 0 ;;
    esac
    pause
  done
}

menu_fadaro() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "This runs the FADARO push script. If you are unsure, start with dry-run." \
      "Push now" \
      "Back")" || return 0

    case "$a" in
      "Push now") run_fadaro $([[ "${SYNCCTL_DRY_RUN}" == "1" ]] && echo "--dry-run") ;;
      "Back") return 0 ;;
    esac
    pause
  done
}

menu_hub_live() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "aos-hub live backup uses rclone copy (push-only, no deletes)." \
      "Status" \
      "Push now (copy)" \
      "Push now (dry-run)" \
      "Back")" || return 0

    case "$a" in
      "Status") run_hub_live status ;;
      "Push now (copy)") run_hub_live push ;;
      "Push now (dry-run)") run_hub_live push --dry-run ;;
      "Back") return 0 ;;
    esac
    pause
  done
}

menu_settings() {
  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "Settings change only this menu session. They do not modify any config files." \
      "Toggle dry-run" \
      "Toggle symlink copying" \
      "Toggle overwrite backups" \
      "Safety notes" \
      "Back")" || return 0

    case "$a" in
      "Toggle dry-run") toggle_dry_run ;;
      "Toggle symlink copying") toggle_copy_links ;;
      "Toggle overwrite backups") toggle_backup_overwrites ;;
      "Safety notes") print_safety_notes; pause ;;
      "Back") return 0 ;;
    esac
  done
}

run_menu() {
  if ! ensure_menu_tty; then
    echo "syncctl: I cannot open an interactive menu because no usable TTY was detected." >&2
    echo "syncctl: Please run it from a normal terminal (not from a launcher/pipe)." >&2
    echo "" >&2
    doctor_tty >&2
    exit 2
  fi

  echo ""
  echo "syncctl menu"
  echo "This menu is just a shortcut. It will still ask the underlying tools to do the real work."

  while true; do
    echo ""
    echo "Current mode: $(badge)"
    local a
    a="$(sync_choose "What do you want to work on?" \
      "Targets (timers + sync/bisync)" \
      "Vault copy (push/pull)" \
      "Domains copy" \
      "Vitaltrainer copy" \
      "FADARO push" \
      "aos-hub live backup" \
      "Settings" \
      "Safety notes" \
      "Quit")" || return 0

    case "$a" in
      "Targets (timers + sync/bisync)") menu_targets ;;
      "Vault copy (push/pull)") menu_vault ;;
      "Domains copy") menu_domains ;;
      "Vitaltrainer copy") menu_vitaltrainer ;;
      "FADARO push") menu_fadaro ;;
      "aos-hub live backup") menu_hub_live ;;
      "Settings") menu_settings ;;
      "Safety notes") print_safety_notes; pause ;;
      "Quit") return 0 ;;
    esac
  done
}

main() {
  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    ""|-h|--help|help) usage ;;
    overview|show) show_overview "$@" ;;
    summary) show_overview "$@" ;;
    menu|ui) run_menu ;;
    safety|notes) print_safety_notes ;;
    doctor-tty) doctor_tty ;;
    doctor)
      if [[ $# -eq 0 ]]; then
        doctor
      else
        run_aos_sync doctor "$@"
      fi
      ;;
    status)
      if [[ $# -eq 0 || "${1:-}" == "--brief" || "${1:-}" == "--compact" ]]; then
        show_overview
        exit 0
      fi
      if [[ "${1:-}" == "--long" || "${1:-}" == "--full" ]]; then
        show_overview --long
        exit 0
      fi
      run_aos_sync status "$@"
      ;;
    list|run|enable|disable|logs)
      run_aos_sync "$cmd" "$@"
      ;;
    install-cli) cmd_install_cli "$@" ;;
    uninstall-cli) cmd_uninstall_cli "$@" ;;
    fix-path) cmd_fix_path "$@" ;;
    vault) run_vault "$@" ;;
    domains|domain) run_domains "$@" ;;
    vitaltrainer|vital) run_vitaltrainer "$@" ;;
    fadaro) run_fadaro "$@" ;;
    hub|aos-hub) run_hub_live "$@" ;;
    *)
      usage
      die "unknown command: $cmd"
      ;;
  esac
}

main "$@"
