#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Codex session helper: indexctl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "node" "indexctl" "$@" && exit 0

# Load global env (optional).
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

SERVICE_NAME="aos-index.service"
UNIT_SRC="$ROOT_DIR/systemd/$SERVICE_NAME"
UNIT_DST="/etc/systemd/system/$SERVICE_NAME"
# Keep this aligned with `systemd/aos-index.service` which reads from `/etc/alphaos-hub/alphaos-index.env`.
ENV_FILE="${AOS_INDEX_ENV_FILE:-/etc/alphaos-hub/alphaos-index.env}"
HEALTH_URL="${AOS_INDEX_HEALTH_URL:-http://127.0.0.1:8799/health}"
HUB_DOCTOR="${AOS_HUB_DOCTOR:-$ROOT_DIR/scripts/aos-doctor}"

msg() { printf "%s\n" "$*"; }
warn() { printf "WARN: %s\n" "$*" >&2; }
die() { printf "ERR: %s\n" "$*" >&2; exit 1; }

has_cmd() { command -v "$1" >/dev/null 2>&1; }

write_env_file() {
  if [[ -d "$ENV_FILE" ]]; then
    die "env file path points to a directory (must be a file): $ENV_FILE"
  fi
  if [[ -f "$ENV_FILE" ]]; then
    return 0
  fi
  sudo_cmd mkdir -p "$(dirname -- "$ENV_FILE")"
  sudo_cmd tee "$ENV_FILE" >/dev/null <<'EOF'
# AlphaOS Index Node env (systemd reads: /etc/alphaos-hub/alphaos-index.env)

# Bind / listen
HOST=0.0.0.0
PORT=8799

# Menu SSOT (relative to index-node WorkingDirectory)
MENU_YAML=./menu.yaml

# Optional: Bridge integration for Core4 logging
# AOS_BRIDGE_URL=http://127.0.0.1:8080

# Optional: Telegram CLI path used by /api/tele/send
# TELE_BIN=/home/alpha/bin/utils/tele
EOF
  sudo_cmd chmod 600 "$ENV_FILE" || true
  msg "✅ Created env file: $ENV_FILE"
}

sudo_cmd() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    sudo "$@"
  else
    "$@"
  fi
}

install_unit() {
  [[ -f "$UNIT_SRC" ]] || die "missing unit: $UNIT_SRC"
  write_env_file
  sudo_cmd cp "$UNIT_SRC" "$UNIT_DST"
  sudo_cmd systemctl daemon-reload
  msg "✅ Installed unit: $UNIT_DST"
}

start_svc() { sudo_cmd systemctl start "$SERVICE_NAME"; }
stop_svc() { sudo_cmd systemctl stop "$SERVICE_NAME"; }
restart_svc() { sudo_cmd systemctl restart "$SERVICE_NAME"; }
status_svc() { sudo_cmd systemctl status "$SERVICE_NAME" --no-pager; }
enable_svc() { sudo_cmd systemctl enable "$SERVICE_NAME"; }
disable_svc() { sudo_cmd systemctl disable "$SERVICE_NAME"; }
logs_svc() { sudo_cmd journalctl -u "$SERVICE_NAME" -f; }

env_edit() {
  write_env_file
  # `/etc/...` needs sudo; `sudoedit` keeps editor UX consistent.
  if [[ "$ENV_FILE" == /etc/* ]] && has_cmd sudoedit; then
    sudoedit "$ENV_FILE"
    return 0
  fi
  sudo_cmd "${EDITOR:-nano}" "$ENV_FILE"
}
env_show() { [[ -f "$ENV_FILE" ]] && sudo_cmd cat "$ENV_FILE" || warn "missing env: $ENV_FILE"; }

health_check() {
  if ! has_cmd curl; then
    warn "curl not found"
    return 0
  fi
  if curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
    msg "✅ health OK: $HEALTH_URL"
  else
    warn "health failed: $HEALTH_URL"
  fi
}

doctor() {
  msg "Indexctl doctor"
  msg "Unit src : $UNIT_SRC"
  msg "Unit dst : $UNIT_DST"
  msg "Env file : $ENV_FILE"
  msg "Health   : $HEALTH_URL"
  msg ""
  if [[ -f "$UNIT_DST" ]]; then
    msg "Unit installed: yes"
  else
    warn "Unit installed: no"
  fi
  if [[ -f "$ENV_FILE" ]]; then
    msg "Env file exists: yes"
  else
    warn "Env file exists: no"
  fi
  health_check
}

hub_doctor() {
  if [[ ! -e "$HUB_DOCTOR" ]]; then
    die "missing: $HUB_DOCTOR"
  fi
  if [[ -x "$HUB_DOCTOR" ]]; then
    "$HUB_DOCTOR"
    return 0
  fi
  if has_cmd bash; then
    bash "$HUB_DOCTOR"
    return 0
  fi
  die "not executable and bash not found: $HUB_DOCTOR"
}

usage() {
  cat <<EOF
indexctl - manage AlphaOS index-node service

Usage:
  scripts/indexctl install
  scripts/indexctl start|stop|restart|status|logs
  scripts/indexctl enable|disable
  scripts/indexctl env|env-show
  scripts/indexctl doctor
  scripts/indexctl hub-doctor

Env:
  AOS_INDEX_ENV_FILE=/etc/alphaos-hub/alphaos-index.env
  AOS_INDEX_HEALTH_URL=http://127.0.0.1:8799/health
  AOS_HUB_DOCTOR=$ROOT_DIR/scripts/aos-doctor
EOF
}

cmd="${1:-}"
case "$cmd" in
  install) install_unit ;;
  start) start_svc ;;
  stop) stop_svc ;;
  restart) restart_svc ;;
  status) status_svc ;;
  enable) enable_svc ;;
  disable) disable_svc ;;
  logs) logs_svc ;;
  env) env_edit ;;
  env-show) env_show ;;
  doctor) doctor ;;
  hub-doctor|aos-doctor) hub_doctor ;;
  -h|--help|help|"") usage ;;
  *) usage; exit 1 ;;
esac
