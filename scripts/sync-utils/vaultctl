#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Load global env (optional).
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

VAULT_ROOT="${AOS_VAULT_ROOT:-${AOS_RCLONE_LOCAL:-${AOS_VAULT_DIR:-$HOME/AlphaOS-Vault}}}"
if command -v realpath >/dev/null 2>&1; then
  VAULT_ROOT="$(realpath -m -- "$VAULT_ROOT")"
elif command -v readlink >/dev/null 2>&1; then
  VAULT_ROOT="$(readlink -f -- "$VAULT_ROOT" 2>/dev/null || echo "$VAULT_ROOT")"
fi
LOG_DIR="${AOS_LOG_DIR:-$HOME/.local/share/alphaos/logs}"
LOG_FILE="${AOS_VAULT_LOG_FILE:-}"
if [ -z "${LOG_FILE}" ]; then
  if [ -f "$HOME/.dotfiles/logs/vaultctl-sync.log" ]; then
    LOG_FILE="$HOME/.dotfiles/logs/vaultctl-sync.log"
  else
    LOG_FILE="$LOG_DIR/vaultctl-sync.log"
  fi
fi
RCLONE_CONFIG="${AOS_RCLONE_CONFIG:-$HOME/.config/rclone/rclone.conf}"
RCLONE_BIN="${AOS_RCLONE_BIN:-$(command -v rclone || true)}"
SYSTEMCTL_BIN="${AOS_SYSTEMCTL_BIN:-$(command -v systemctl || true)}"
SLEEP_BETWEEN="${AOS_VAULT_SLEEP_BETWEEN:-30}"
COPY_LINKS_MODE="${AOS_VAULT_COPY_LINKS:-${AOS_COPY_LINKS:-1}}"
BACKUP_DIR_REMOTE="${AOS_VAULT_BACKUP_DIR_REMOTE:-${AOS_VAULT_BACKUP_DIR:-}}"
BACKUP_DIR_LOCAL="${AOS_VAULT_BACKUP_DIR_LOCAL:-}"
BACKUP_SUFFIX="${AOS_VAULT_BACKUP_SUFFIX:-}"

RCLONE_COMMON_OPTS=(--create-empty-src-dirs)
if [ "${COPY_LINKS_MODE}" = "1" ]; then
  RCLONE_COMMON_OPTS+=(--copy-links)
fi

LOCAL_PATHS=(
  "$VAULT_ROOT/Game"
  "$VAULT_ROOT/Door"
  "$VAULT_ROOT/Voice"
  "$VAULT_ROOT/Core4"
)

REMOTE_PATHS=(
  "${AOS_VAULT_REMOTE_GAME:-eldanioo:Alpha_Game}"
  "${AOS_VAULT_REMOTE_DOOR:-eldanioo:Alpha_Door}"
  "${AOS_VAULT_REMOTE_VOICE:-eldanioo:Alpha_Voice}"
  "${AOS_VAULT_REMOTE_CORE4:-eldanioo:Alpha_Core4}"
)

LABELS=(
  "Game"
  "Door"
  "Voice"
  "Core4"
)

have_tty() {
  [ -t 1 ]
}

have_gum() {
  command -v gum >/dev/null 2>&1
}

info() {
  if have_gum && have_tty; then
    gum style --bold -- "$1"
  else
    echo "$1"
  fi
}

warn() {
  if have_gum && have_tty; then
    gum style --foreground 214 -- "$1"
  else
    echo "WARN: $1"
  fi
}

run_cmd() {
  local title="$1"
  shift

  if have_gum && have_tty; then
    gum spin --spinner dot --title "$title" -- "$@"
  else
    echo "$title"
    "$@"
  fi
}

wait_between() {
  if [ "${SLEEP_BETWEEN}" -le 0 ]; then
    return 0
  fi
  if have_tty; then
    info "waiting ${SLEEP_BETWEEN}s (press Enter to skip)"
    read -r -t "$SLEEP_BETWEEN" _ || true
  else
    info "waiting ${SLEEP_BETWEEN}s"
    sleep "$SLEEP_BETWEEN"
  fi
}

status() {
  info "vaultctl status"
  echo ""

  if [ -f "$RCLONE_CONFIG" ]; then
    info "rclone config: present"
  else
    warn "rclone config: missing"
  fi

  echo ""
  for i in "${!LOCAL_PATHS[@]}"; do
    if [ -d "${LOCAL_PATHS[$i]}" ]; then
      info "${LABELS[$i]}: ${LOCAL_PATHS[$i]} -> ${REMOTE_PATHS[$i]}"
    else
      warn "${LABELS[$i]}: missing (${LOCAL_PATHS[$i]})"
    fi
  done

  if [ -f "$LOG_FILE" ]; then
    echo ""
    info "last log lines ($LOG_FILE)"
    tail -n 10 "$LOG_FILE"
  fi
}

copy_direction() {
  local direction="$1"
  local dry_run="${2:-false}"

  mkdir -p "$LOG_DIR"

  if [ -z "$RCLONE_BIN" ] || [ ! -x "$RCLONE_BIN" ]; then
    warn "rclone not found in PATH"
    exit 1
  fi

  if [ ! -f "$RCLONE_CONFIG" ]; then
    warn "rclone config missing; nothing to do"
    exit 0
  fi

  if [ "$dry_run" = "true" ]; then
    info "vaultctl ${direction} (copy, dry-run)"
  else
    info "vaultctl ${direction} (copy)"
  fi
  echo ""

  for i in "${!LOCAL_PATHS[@]}"; do
    local_path="${LOCAL_PATHS[$i]}"
    remote_path="${REMOTE_PATHS[$i]}"
    label="${LABELS[$i]}"
    filter_from=()
    ignore_file="$local_path/.rcloneignore"
    if [ "$label" = "Core4" ]; then
      # Core4 derived JSON can be rebuilt from the append-only event ledger.
      # Sync only `.core4/**` to avoid Google Drive duplicate-name issues.
      filter_from=(--filter "+ .core4/**" --filter "- *")
    elif [ -f "$ignore_file" ]; then
      filter_from=(--filter-from "$ignore_file")
    fi
    backup_dir=""
    backup_opts=()
    if [ "$direction" = "push" ]; then
      backup_dir="$BACKUP_DIR_REMOTE"
    else
      backup_dir="$BACKUP_DIR_LOCAL"
    fi
    if [ -n "$backup_dir" ]; then
      backup_opts+=(--backup-dir "$backup_dir")
      if [ -n "$BACKUP_SUFFIX" ]; then
        backup_opts+=(--suffix "$BACKUP_SUFFIX")
      else
        backup_opts+=(--suffix ".bak-$(date +%Y%m%d-%H%M%S)")
      fi
    fi

    case "$direction" in
      push)
        if [ ! -d "$local_path" ]; then
          warn "skip $label; missing $local_path"
          continue
        fi
        if [ "$dry_run" = "true" ]; then
          run_cmd "copy $label -> $remote_path (dry-run)" "$RCLONE_BIN" --config "$RCLONE_CONFIG" copy "${RCLONE_COMMON_OPTS[@]}" "${backup_opts[@]}" "${filter_from[@]}" --dry-run "$local_path" "$remote_path"
        else
          run_cmd "copy $label -> $remote_path" "$RCLONE_BIN" --config "$RCLONE_CONFIG" copy "${RCLONE_COMMON_OPTS[@]}" "${backup_opts[@]}" "${filter_from[@]}" "$local_path" "$remote_path"
        fi
        ;;
      pull)
        mkdir -p "$local_path"
        if [ "$dry_run" = "true" ]; then
          run_cmd "copy $label <- $remote_path (dry-run)" "$RCLONE_BIN" --config "$RCLONE_CONFIG" copy "${RCLONE_COMMON_OPTS[@]}" "${backup_opts[@]}" "${filter_from[@]}" --dry-run "$remote_path" "$local_path"
        else
          run_cmd "copy $label <- $remote_path" "$RCLONE_BIN" --config "$RCLONE_CONFIG" copy "${RCLONE_COMMON_OPTS[@]}" "${backup_opts[@]}" "${filter_from[@]}" "$remote_path" "$local_path"
        fi
        ;;
      *)
        warn "Unknown direction: $direction"
        exit 1
        ;;
    esac

    if [ "$i" -lt $(( ${#LOCAL_PATHS[@]} - 1 )) ]; then
      wait_between
    fi
  done
}

sync() {
  copy_direction push "${1:-false}"
}

pull() {
  copy_direction pull "${1:-false}"
}

timers() {
  info "vaultctl timers"
  echo ""

  if [ -z "$SYSTEMCTL_BIN" ] || [ ! -x "$SYSTEMCTL_BIN" ]; then
    warn "systemctl not found"
    exit 1
  fi

  "$SYSTEMCTL_BIN" --user status alphaos-vault-sync.timer || true
  echo ""
  "$SYSTEMCTL_BIN" --user list-timers --all | rg -i "alphaos-vault-sync|vaultctl" || true
}

logs() {
  local lines="${1:-50}"

  if [ -f "$LOG_FILE" ]; then
    info "vaultctl logs ($LOG_FILE)"
    tail -n "$lines" "$LOG_FILE"
  else
    warn "log file missing: $LOG_FILE"
  fi
}

watch() {
  if have_gum && have_tty; then
    gum watch --interval 3s -- "vaultctl _render"
  else
    while true; do
      clear
      status
      sleep 3
    done
  fi
}

menu() {
  if ! have_gum || ! have_tty; then
    warn "menu requires gum and a TTY"
    return 1
  fi

  while true; do
    local choice
    choice="$(printf "%s\n" \
      "Status" \
      "Push now (copy)" \
      "Push dry-run (copy)" \
      "Pull now (copy)" \
      "Pull dry-run (copy)" \
      "Timers" \
      "Logs" \
      "Watch" \
      "Exit" \
      | gum choose --header "vaultctl menu")"

    case "$choice" in
      "Status") status ;;
      "Push now (copy)") sync ;;
      "Push dry-run (copy)") sync true ;;
      "Pull now (copy)") pull ;;
      "Pull dry-run (copy)") pull true ;;
      "Timers") timers ;;
      "Logs") logs ;;
      "Watch") watch ;;
      "Exit") break ;;
    esac
  done
}

render() {
  if ! have_gum || ! have_tty; then
    status
    return
  fi

  local rclone_status="missing"
  if [ -f "$RCLONE_CONFIG" ]; then
    rclone_status="present"
  fi

  local paths_block=""
  for i in "${!LOCAL_PATHS[@]}"; do
    if [ -d "${LOCAL_PATHS[$i]}" ]; then
      paths_block+="${LABELS[$i]}: ${LOCAL_PATHS[$i]} -> ${REMOTE_PATHS[$i]}\n"
    else
      paths_block+="${LABELS[$i]}: missing (${LOCAL_PATHS[$i]})\n"
    fi
  done

  local timers_block
  timers_block="$($SYSTEMCTL_BIN --user list-timers --all 2>/dev/null | rg -i "alphaos-vault-sync" || true)"

  local log_block="(no log)"
  if [ -f "$LOG_FILE" ]; then
    log_block="$(tail -n 10 "$LOG_FILE")"
  fi

  gum style --border normal --padding "0 1" --margin "1 0" --bold -- "vaultctl watch"
  gum style --border normal --padding "0 1" --margin "1 0" -- "rclone config: $rclone_status"
  gum style --border normal --padding "0 1" --margin "1 0" -- "$(printf "%b" "$paths_block")"

  if [ -n "$timers_block" ]; then
    gum style --border normal --padding "0 1" --margin "1 0" -- "timer:\n$timers_block"
  else
    gum style --border normal --padding "0 1" --margin "1 0" -- "timer: not found"
  fi

  gum style --border normal --padding "0 1" --margin "1 0" -- "log tail:\n$log_block"
}

case "${1:-sync}" in
  sync|"")
    if [ "${2:-}" = "--dry-run" ]; then
      sync true
    else
      sync
    fi
    ;;
  pull)
    if [ "${2:-}" = "--dry-run" ]; then
      pull true
    else
      pull
    fi
    ;;
  status)
    status
    ;;
  watch)
    watch
    ;;
  menu)
    menu
    ;;
  timers)
    timers
    ;;
  logs)
    logs "${2:-50}"
    ;;
  _render)
    render
    ;;
  help|-h|--help)
    echo "vaultctl - AlphaOS Vault sync manager"
    echo ""
    echo "Usage:"
    echo "  vaultctl [command]"
    echo ""
    echo "Commands:"
    echo "  sync    Push local -> remote with rclone copy (default)"
    echo "  sync --dry-run  Dry-run push"
    echo "  pull    Pull remote -> local with rclone copy"
    echo "  pull --dry-run  Dry-run pull"
    echo "  status  Show paths and recent log lines"
    echo "  watch   Live status view"
    echo "  menu    Gum menu (interactive)"
    echo "  timers  Show alphaos-vault-sync timer status"
    echo "  logs    Show recent log lines (default: 50)"
    echo "  help    Show this help"
    ;;
  *)
    echo "Unknown command: $1"
    echo "Run 'vaultctl help' for usage."
    exit 1
    ;;
esac
