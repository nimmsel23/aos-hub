#!/usr/bin/env bash
set -euo pipefail

SYSTEMCTL_BIN="${SYSTEMCTL_BIN:-systemctl}"
JOURNALCTL_BIN="${JOURNALCTL_BIN:-journalctl}"
SYSTEMCTL_USER=("$SYSTEMCTL_BIN" --user)
JOURNALCTL_USER=("$JOURNALCTL_BIN" --user)

UNITS=(
  warstack-bot.service
)

usage() {
  cat <<'EOF'
doorctl

Manage Door/Warstack-related systemd user units.

Commands
  list                       List managed units
  status                     Show status for all units
  start                      Start all units
  stop                       Stop all units
  restart                    Restart all units
  enable                     Enable all units
  disable                    Disable all units
  logs [--follow|-f] [unit]  Show logs for a unit (defaults to all units)

Notes
  - Uses systemd user units (systemctl --user).
EOF
}

cmd_list() {
  printf "%s\n" "${UNITS[@]}"
}

cmd_status() {
  "${SYSTEMCTL_USER[@]}" status "${UNITS[@]}"
}

cmd_start() {
  "${SYSTEMCTL_USER[@]}" start "${UNITS[@]}"
}

cmd_stop() {
  "${SYSTEMCTL_USER[@]}" stop "${UNITS[@]}"
}

cmd_restart() {
  "${SYSTEMCTL_USER[@]}" restart "${UNITS[@]}"
}

cmd_enable() {
  "${SYSTEMCTL_USER[@]}" enable "${UNITS[@]}"
}

cmd_disable() {
  "${SYSTEMCTL_USER[@]}" disable "${UNITS[@]}"
}

cmd_logs() {
  local follow=""
  local unit=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -f|--follow) follow="--follow" ;;
      *) unit="$1" ;;
    esac
    shift
  done

  if [[ -n "$unit" ]]; then
    "${JOURNALCTL_USER[@]}" $follow -u "$unit"
    return
  fi

  "${JOURNALCTL_USER[@]}" $follow "${UNITS[@]/#/-u }"
}

case "${1:-}" in
  ""|-h|--help|help) usage ;;
  list) cmd_list ;;
  status) cmd_status ;;
  start) cmd_start ;;
  stop) cmd_stop ;;
  restart) cmd_restart ;;
  enable) cmd_enable ;;
  disable) cmd_disable ;;
  logs) shift; cmd_logs "$@" ;;
  *)
    echo "doorctl: unknown command: ${1}" >&2
    usage
    exit 2
    ;;
esac
