#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

FIRECTL_VERSION="0.2.0"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd -P)"

has_cmd() { command -v "$1" >/dev/null 2>&1; }
has_gum() { command -v gum >/dev/null 2>&1; }
has_fzf() { command -v fzf >/dev/null 2>&1; }

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

ui_title(){ has_gum && gum style --bold --border normal --padding "1 2" "firectl" || echo "firectl"; }
ui_info() { has_gum && gum style --faint "$*" || echo "$*"; }
ui_ok()   { has_gum && gum style --foreground 10 "✔ $*" || echo "✔ $*"; }
ui_err()  { has_gum && gum style --foreground 9  "✘ $*" || echo "✘ $*"; }

die() { ui_err "$*"; exit 1; }

systemd_ok() {
  has_cmd systemctl || return 1
  systemctl --user show-environment >/dev/null 2>&1
}

choose() {
  if has_fzf; then
    printf "%s\n" "$@" | fzf --prompt="firectl> " --height=18 --reverse --border
    return 0
  fi
  if has_gum; then
    gum choose "$@"
    return 0
  fi
  ui_info "Choose one:"
  select opt in "$@"; do echo "$opt"; break; done
}

abs_path() {
  local p="$1"
  if command -v realpath >/dev/null 2>&1; then
    realpath -m -- "$p"
    return 0
  fi
  [[ "$p" = /* ]] && echo "$p" || echo "$PWD/$p"
}

run() {
  # shellcheck disable=SC2068
  "$@"
}

load_fire_env() {
  local f="${AOS_FIRE_ENV_FILE:-}"
  [[ -z "$f" ]] && return 0
  [[ -f "$f" ]] || return 0
  # shellcheck disable=SC1090
  set -a; source "$f"; set +a
}

# Optional override (default config should live in `aos.env`).
load_fire_env || true

TASK_BIN="${AOS_TASK_BIN:-task}"
PYTHON_BIN="${AOS_PYTHON_BIN:-python}"
VAULT_DIR="${AOS_VAULT_DIR:-$HOME/AlphaOS-Vault}"
FIRE_ROOT="${AOS_FIRE_DIR:-$VAULT_DIR/Game/Fire}"
FIREBOT_SCRIPT="${AOS_FIREBOT_SCRIPT:-$ROOT_DIR/python-firemap/firemap_bot.py}"
SYSTEMD_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
SERVICE_DAILY="alphaos-fire-daily.service"
TIMER_DAILY="alphaos-fire-daily.timer"
SERVICE_WEEKLY="alphaos-fire-weekly.service"
TIMER_WEEKLY="alphaos-fire-weekly.timer"

need_task() { has_cmd "$TASK_BIN" || die "missing: $TASK_BIN"; }
need_firebot() { has_cmd "$PYTHON_BIN" || die "missing: $PYTHON_BIN"; [[ -f "$FIREBOT_SCRIPT" ]] || die "missing: $FIREBOT_SCRIPT"; }

week_label() {
  local w y
  w="$(date +%V)"
  y="$(date +%Y)"
  printf "KW%s_%s" "$w" "$y"
}

today_iso() { date +%F; }

fire_dir_daily()  { printf "%s/Daily/%s"  "$FIRE_ROOT" "$(week_label)"; }
fire_dir_weekly() { printf "%s/Weekly/%s" "$FIRE_ROOT" "$(week_label)"; }

out_file_daily()  { printf "%s/fire-%s.md" "$(fire_dir_daily)" "$(today_iso)"; }
out_file_weekly() { printf "%s/fire-week-%s.md" "$(fire_dir_weekly)" "$(week_label)"; }

print_message() {
  local scope="$1"
  case "$scope" in
    daily|weekly) ;;
    *) die "unknown scope: $scope" ;;
  esac
  need_firebot
  run "$PYTHON_BIN" "$FIREBOT_SCRIPT" print --scope "$scope"
}

build_markdown() {
  local scope="$1" file_dir out
  case "$scope" in
    daily)
      file_dir="$(fire_dir_daily)"
      out="$(out_file_daily)"
      ;;
    weekly)
      file_dir="$(fire_dir_weekly)"
      out="$(out_file_weekly)"
      ;;
    *) die "unknown scope: $scope" ;;
  esac

  mkdir -p "$file_dir"
  print_message "$scope" >"$out"
  ui_ok "Wrote: $out"
}

send_message() {
  local scope="$1"
  need_firebot
  case "$scope" in
    daily) run "$PYTHON_BIN" "$FIREBOT_SCRIPT" daily ;;
    weekly) run "$PYTHON_BIN" "$FIREBOT_SCRIPT" weekly ;;
    *) die "unknown scope: $scope" ;;
  esac
  ui_ok "Sent: $scope"
}

test_message() {
  need_firebot
  run "$PYTHON_BIN" "$FIREBOT_SCRIPT" test "$@"
  ui_ok "Sent test message."
}

write_systemd_units() {
  mkdir -p "$SYSTEMD_DIR"

  cat >"$SYSTEMD_DIR/$SERVICE_DAILY" <<EOF
[Unit]
Description=AlphaOS Fire Daily Send

[Service]
Type=oneshot
ExecStart=$SCRIPT_DIR/firectl send daily
EOF

  cat >"$SYSTEMD_DIR/$TIMER_DAILY" <<'EOF'
[Unit]
Description=AlphaOS Fire Daily Send (08:00)

[Timer]
OnCalendar=*-*-* 08:00:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

  cat >"$SYSTEMD_DIR/$SERVICE_WEEKLY" <<EOF
[Unit]
Description=AlphaOS Fire Weekly Send

[Service]
Type=oneshot
ExecStart=$SCRIPT_DIR/firectl send weekly
EOF

  cat >"$SYSTEMD_DIR/$TIMER_WEEKLY" <<'EOF'
[Unit]
Description=AlphaOS Fire Weekly Send (Mon 08:05)

[Timer]
OnCalendar=Mon *-*-* 08:05:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

  systemctl --user daemon-reload
  ui_ok "Wrote: $SYSTEMD_DIR/$TIMER_DAILY"
  ui_ok "Wrote: $SYSTEMD_DIR/$TIMER_WEEKLY"
}

setup_systemd() {
  has_cmd systemctl || die "missing: systemctl"
  systemd_ok || die "systemctl --user not available (run on the host user session)"
  write_systemd_units
  systemctl --user enable --now "$TIMER_DAILY" >/dev/null 2>&1 || true
  systemctl --user enable --now "$TIMER_WEEKLY" >/dev/null 2>&1 || true
  ui_ok "Enabled timers."
}

status() {
  has_cmd systemctl || die "missing: systemctl"
  systemd_ok || die "systemctl --user not available (run on the host user session)"

  ui_title
  ui_info "Timers:"
  systemctl --user list-timers --all --no-pager | (grep -E "alphaos-fire-(daily|weekly)\\.timer" || true)
  echo
  ui_info "Status:"
  systemctl --user status "$TIMER_DAILY" "$TIMER_WEEKLY" --no-pager || true
}

logs() {
  has_cmd journalctl || die "missing: journalctl"
  local follow="0" lines="200"

  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      -f|--follow) follow="1"; shift ;;
      -n|--lines) lines="${2:-200}"; shift 2 || true ;;
      *) shift ;;
    esac
  done

  local args=(--user -n "$lines" --no-pager -u "$SERVICE_DAILY" -u "$SERVICE_WEEKLY")
  if [[ "$follow" == "1" ]]; then
    args=(--user -f -u "$SERVICE_DAILY" -u "$SERVICE_WEEKLY")
  fi
  journalctl "${args[@]}" || true
}

doctor() {
  need_task
  need_firebot
  ui_info "task: $("$TASK_BIN" --version 2>/dev/null || echo ok)"
  ui_info "vault: $(abs_path "$VAULT_DIR")"
  ui_info "fire root: $(abs_path "$FIRE_ROOT")"
  ui_info "taskrc: $(abs_path "${AOS_TASKRC:-$HOME/.taskrc}")"
  ui_info "fire bot: $FIREBOT_SCRIPT"
  ui_info "fire bot .env: $(abs_path "$(dirname -- "$FIREBOT_SCRIPT")/.env")"
}

menu() {
  ui_title
  local action
  action="$(choose \
    "send daily" "send weekly" \
    "build daily md" "build weekly md" \
    "print daily" "print weekly" \
    "test --debug --scope daily" \
    "status" "logs --follow" \
    "setup systemd timers" \
    "doctor" \
    "quit")"

  case "$action" in
    "send daily") send_message daily ;;
    "send weekly") send_message weekly ;;
    "build daily md") build_markdown daily ;;
    "build weekly md") build_markdown weekly ;;
    "print daily") print_message daily ;;
    "print weekly") print_message weekly ;;
    "test --debug --scope daily") test_message --debug --scope daily ;;
    "status") status ;;
    "logs --follow") logs --follow ;;
    "setup systemd timers") setup_systemd ;;
    "doctor") doctor ;;
    "quit") exit 0 ;;
  esac
}

usage() {
  cat <<EOF
firectl — Fire tooling ($FIRECTL_VERSION)

Usage:
  firectl menu
  firectl doctor
  firectl status
  firectl logs [--follow] [--lines N]
  firectl print daily|weekly
  firectl build daily|weekly
  firectl send  daily|weekly
  firectl test [--debug] [--scope daily|weekly] [--text "..."]
  firectl setup-systemd

Env:
  AOS_TASK_BIN=task
  AOS_PYTHON_BIN=python
  AOS_FIREBOT_SCRIPT=<repo>/python-firemap/firemap_bot.py
  AOS_VAULT_DIR=~/AlphaOS-Vault
  AOS_FIRE_DIR=<vault>/Game/Fire
  AOS_TASKRC=~/.taskrc
EOF
}

cmd="${1:-menu}"
shift || true

case "$cmd" in
  -h|--help|help) usage ;;
  menu) menu ;;
  doctor) doctor ;;
  status) status ;;
  logs) logs "$@" ;;
  print) print_message "${1:-}" ;;
  build) build_markdown "${1:-}" ;;
  send) send_message "${1:-}" ;;
  test) test_message "$@" ;;
  setup-systemd) setup_systemd ;;
  *) ui_err "unknown command: $cmd"; usage; exit 1 ;;
esac
