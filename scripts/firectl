#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

FIRECTL_VERSION="0.3.0"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd -P)"

# Codex session helper: firectl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "game" "firectl" "$@" && exit 0

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

# Shared UI/helpers.
# shellcheck disable=SC1091
source "$SCRIPT_DIR/ctl-lib.sh"

CTL_UI_OK_PREFIX="✔"
CTL_UI_ERR_PREFIX="✘"
CTL_CHOOSE_PROMPT="firectl"
CTL_FZF_HEIGHT="18"
CTL_FZF_REVERSE="1"
CTL_FZF_PROMPT_SUFFIX="> "

systemd_ok() {
  has_cmd systemctl || return 1
  systemctl --user show-environment >/dev/null 2>&1
}

abs_path() {
  local p="$1"
  if command -v realpath >/dev/null 2>&1; then
    realpath -m -- "$p"
    return 0
  fi
  [[ "$p" = /* ]] && echo "$p" || echo "$PWD/$p"
}

run() {
  # shellcheck disable=SC2068
  "$@"
}

load_fire_env() {
  local f="${AOS_FIRE_ENV_FILE:-}"
  [[ -z "$f" ]] && return 0
  [[ -f "$f" ]] || return 0
  # shellcheck disable=SC1090
  set -a; source "$f"; set +a
}

# Optional override (default config should live in `aos.env`).
load_fire_env || true

TASK_BIN="${AOS_TASK_BIN:-task}"
PYTHON_BIN="${AOS_PYTHON_BIN:-python}"
VAULT_DIR="${AOS_VAULT_DIR:-$HOME/AlphaOS-Vault}"
FIRE_ROOT="${AOS_FIRE_DIR:-$VAULT_DIR/Game/Fire}"
FIREBOT_SCRIPT="${AOS_FIREBOT_SCRIPT:-$ROOT_DIR/game/python-firemap/firemap_bot.py}"
SYSTEMD_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
SERVICE_DAILY="alphaos-fire-daily.service"
TIMER_DAILY="alphaos-fire-daily.timer"
SERVICE_WEEKLY="alphaos-fire-weekly.service"
TIMER_WEEKLY="alphaos-fire-weekly.timer"
FIRE_GIT_DIR="${AOS_FIRE_GIT_DIR:-$FIRE_ROOT}"

need_task() { has_cmd "$TASK_BIN" || die "missing: $TASK_BIN"; }
need_firebot() { has_cmd "$PYTHON_BIN" || die "missing: $PYTHON_BIN"; [[ -f "$FIREBOT_SCRIPT" ]] || die "missing: $FIREBOT_SCRIPT"; }

week_label() {
  local w y
  w="$(date +%V)"
  y="$(date +%Y)"
  printf "KW%s_%s" "$w" "$y"
}

today_iso() { date +%F; }

fire_dir_daily()  { printf "%s/Daily/%s"  "$FIRE_ROOT" "$(week_label)"; }
fire_dir_weekly() { printf "%s/Weekly/%s" "$FIRE_ROOT" "$(week_label)"; }

out_file_daily()  { printf "%s/fire-%s.md" "$(fire_dir_daily)" "$(today_iso)"; }
out_file_weekly() { printf "%s/fire-week-%s.md" "$(fire_dir_weekly)" "$(week_label)"; }

print_message() {
  local scope="$1"
  case "$scope" in
    daily|weekly) ;;
    *) die "unknown scope: $scope" ;;
  esac
  need_firebot
  run "$PYTHON_BIN" "$FIREBOT_SCRIPT" print --scope "$scope"
}

build_markdown() {
  local scope="$1" file_dir out
  case "$scope" in
    daily)
      file_dir="$(fire_dir_daily)"
      out="$(out_file_daily)"
      ;;
    weekly)
      file_dir="$(fire_dir_weekly)"
      out="$(out_file_weekly)"
      ;;
    *) die "unknown scope: $scope" ;;
  esac

  mkdir -p "$file_dir"
  print_message "$scope" >"$out"
  ui_ok "Wrote: $out"
}

send_message() {
  local scope="$1"
  need_firebot
  case "$scope" in
    daily) run "$PYTHON_BIN" "$FIREBOT_SCRIPT" daily ;;
    weekly) run "$PYTHON_BIN" "$FIREBOT_SCRIPT" weekly ;;
    *) die "unknown scope: $scope" ;;
  esac
  ui_ok "Sent: $scope"
}

test_message() {
  need_firebot
  run "$PYTHON_BIN" "$FIREBOT_SCRIPT" test "$@"
  ui_ok "Sent test message."
}

write_systemd_units() {
  mkdir -p "$SYSTEMD_DIR"

  cat >"$SYSTEMD_DIR/$SERVICE_DAILY" <<EOF
[Unit]
Description=αOS Fire Daily Send

[Service]
Type=oneshot
ExecStart=$SCRIPT_DIR/firectl send daily
EOF

  cat >"$SYSTEMD_DIR/$TIMER_DAILY" <<'EOF'
[Unit]
Description=αOS Fire Daily Send (08:00)

[Timer]
OnCalendar=*-*-* 08:00:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

  cat >"$SYSTEMD_DIR/$SERVICE_WEEKLY" <<EOF
[Unit]
Description=αOS Fire Weekly Send

[Service]
Type=oneshot
ExecStart=$SCRIPT_DIR/firectl send weekly
EOF

  cat >"$SYSTEMD_DIR/$TIMER_WEEKLY" <<'EOF'
[Unit]
Description=αOS Fire Weekly Send (Mon 08:05)

[Timer]
OnCalendar=Mon *-*-* 08:05:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

  systemctl --user daemon-reload
  ui_ok "Wrote: $SYSTEMD_DIR/$TIMER_DAILY"
  ui_ok "Wrote: $SYSTEMD_DIR/$TIMER_WEEKLY"
}

setup_systemd() {
  has_cmd systemctl || die "missing: systemctl"
  systemd_ok || die "systemctl --user not available (run on the host user session)"
  write_systemd_units
  systemctl --user enable --now "$TIMER_DAILY" >/dev/null 2>&1 || true
  systemctl --user enable --now "$TIMER_WEEKLY" >/dev/null 2>&1 || true
  ui_ok "Enabled timers."
}

status() {
  has_cmd systemctl || die "missing: systemctl"
  systemd_ok || die "systemctl --user not available (run on the host user session)"

  ui_title "firectl"
  ui_info "Timers:"
  systemctl --user list-timers --all --no-pager | (grep -E "alphaos-fire-(daily|weekly)\\.timer" || true)
  echo
  ui_info "Status:"
  systemctl --user status "$TIMER_DAILY" "$TIMER_WEEKLY" --no-pager || true
}

logs() {
  has_cmd journalctl || die "missing: journalctl"
  local follow="0" lines="200"

  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      -f|--follow) follow="1"; shift ;;
      -n|--lines) lines="${2:-200}"; shift 2 || true ;;
      *) shift ;;
    esac
  done

  local args=(--user -n "$lines" --no-pager -u "$SERVICE_DAILY" -u "$SERVICE_WEEKLY")
  if [[ "$follow" == "1" ]]; then
    args=(--user -f -u "$SERVICE_DAILY" -u "$SERVICE_WEEKLY")
  fi
  journalctl "${args[@]}" || true
}

doctor() {
  need_task
  need_firebot
  ui_info "task: $("$TASK_BIN" --version 2>/dev/null || echo ok)"
  ui_info "vault: $(abs_path "$VAULT_DIR")"
  ui_info "fire root: $(abs_path "$FIRE_ROOT")"
  ui_info "taskrc: $(abs_path "${AOS_TASKRC:-$HOME/.taskrc}")"
  ui_info "fire bot: $FIREBOT_SCRIPT"
  ui_info "fire bot .env: $(abs_path "$(dirname -- "$FIREBOT_SCRIPT")/.env")"
}

need_git() { has_cmd git || die "missing: git"; }

fire_git_root() {
  need_git
  [[ -d "$FIRE_GIT_DIR" ]] || die "missing dir: $FIRE_GIT_DIR"
  git -C "$FIRE_GIT_DIR" rev-parse --show-toplevel 2>/dev/null || return 1
}

fire_git_status() {
  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  ui_title "firectl"
  ui_info "repo: $root"
  git -C "$root" status -sb
  echo ""
  git -C "$root" remote -v || true
}

fire_git_log() {
  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  git -C "$root" log --oneline --graph --decorate -15
}

fire_git_diff() {
  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  git -C "$root" diff
}

fire_git_commit() {
  local root msg="${1:-}"
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  [[ -n "$msg" ]] || msg="fire: update $(date +%F)"
  git -C "$root" add -A
  if git -C "$root" diff --cached --quiet; then
    ui_ok "No changes to commit."
    return 0
  fi
  git -C "$root" commit -m "$msg"
}

fire_git_pull() {
  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  git -C "$root" pull --rebase --autostash
}

fire_git_push() {
  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  git -C "$root" push
}

fire_git_sync() {
  local msg="" do_commit=1 do_pull=1 do_push=1 dry_run=0

  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      -m|--message) msg="${2:-}"; shift 2 ;;
      --no-commit) do_commit=0; shift ;;
      --no-pull) do_pull=0; shift ;;
      --no-push) do_push=0; shift ;;
      -n|--dry-run|--print) dry_run=1; shift ;;
      -h|--help)
        cat <<EOF
firectl git sync

Usage:
  firectl git sync [options]

Options:
  -m, --message MSG   Commit message (default: fire: update YYYY-MM-DD)
  --no-commit         Skip git add/commit step
  --no-pull           Skip pull --rebase
  --no-push           Skip push
  --dry-run           Print actions only

Env:
  AOS_FIRE_GIT_DIR    Directory inside the Fire git worktree (default: AOS_FIRE_DIR)
EOF
        return 0
        ;;
      *)
        die "unknown option: $1"
        ;;
    esac
  done

  local root
  root="$(fire_git_root)" || die "not a git repo: $FIRE_GIT_DIR"
  ui_info "repo: $root"

  if [[ "$dry_run" == "1" ]]; then
    ui_info "dry-run:"
    [[ "$do_commit" == "1" ]] && ui_info "  git add -A && git commit -m <msg> (if changes)"
    [[ "$do_pull" == "1" ]] && ui_info "  git pull --rebase --autostash"
    [[ "$do_push" == "1" ]] && ui_info "  git push"
    return 0
  fi

  if [[ "$do_commit" == "1" ]]; then
    fire_git_commit "${msg:-}"
  fi
  if [[ "$do_pull" == "1" ]]; then
    fire_git_pull
  fi
  if [[ "$do_push" == "1" ]]; then
    fire_git_push
  fi
  ui_ok "Git sync done."
}

git_menu() {
  ui_title "firectl"
  local action
  action="$(choose \
    "git status" \
    "git sync" \
    "git log" \
    "git diff" \
    "quit")"
  case "$action" in
    "git status") fire_git_status ;;
    "git sync") fire_git_sync ;;
    "git log") fire_git_log ;;
    "git diff") fire_git_diff ;;
    "quit") exit 0 ;;
  esac
}

menu() {
  ui_title "firectl"
  local action
  action="$(choose \
    "send daily" "send weekly" \
    "build daily md" "build weekly md" \
    "print daily" "print weekly" \
    "test --debug --scope daily" \
    "git menu" \
    "status" "logs --follow" \
    "setup systemd timers" \
    "doctor" \
    "quit")"

  case "$action" in
    "send daily") send_message daily ;;
    "send weekly") send_message weekly ;;
    "build daily md") build_markdown daily ;;
    "build weekly md") build_markdown weekly ;;
    "print daily") print_message daily ;;
    "print weekly") print_message weekly ;;
    "test --debug --scope daily") test_message --debug --scope daily ;;
    "git menu") git_menu ;;
    "status") status ;;
    "logs --follow") logs --follow ;;
    "setup systemd timers") setup_systemd ;;
    "doctor") doctor ;;
    "quit") exit 0 ;;
  esac
}

usage() {
  cat <<EOF
firectl — Fire tooling ($FIRECTL_VERSION)

Usage:
  firectl menu
  firectl doctor
  firectl status
  firectl logs [--follow] [--lines N]
  firectl print daily|weekly
  firectl build daily|weekly
  firectl send  daily|weekly
  firectl test [--debug] [--scope daily|weekly] [--text "..."]
  firectl setup-systemd
  firectl git <status|sync|log|diff|commit|pull|push|menu>

Env:
  AOS_TASK_BIN=task
  AOS_PYTHON_BIN=python
  AOS_FIREBOT_SCRIPT=<repo>/game/python-firemap/firemap_bot.py
  AOS_VAULT_DIR=~/AlphaOS-Vault
  AOS_FIRE_DIR=<vault>/Game/Fire
  AOS_TASKRC=~/.taskrc
  AOS_FIRE_GIT_DIR=<vault>/Game/Fire
EOF
}

cmd="${1:-menu}"
shift || true

case "$cmd" in
  -h|--help|help) usage ;;
  menu) menu ;;
  doctor) doctor ;;
  status) status ;;
  logs) logs "$@" ;;
  print) print_message "${1:-}" ;;
  build) build_markdown "${1:-}" ;;
  send) send_message "${1:-}" ;;
  test) test_message "$@" ;;
  setup-systemd) setup_systemd ;;
  git)
    sub="${1:-menu}"; shift || true
    case "$sub" in
      menu) git_menu ;;
      status) fire_git_status ;;
      sync) fire_git_sync "$@" ;;
      log) fire_git_log ;;
      diff) fire_git_diff ;;
      commit) fire_git_commit "${*:-}" ;;
      pull) fire_git_pull ;;
      push) fire_git_push ;;
      *) die "unknown git subcommand: $sub" ;;
    esac
    ;;
  *) ui_err "unknown command: $cmd"; usage; exit 1 ;;
esac
