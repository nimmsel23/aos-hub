#!/usr/bin/env bash
set -euo pipefail

APP="hubctl"

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Codex session helper: hubctl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "main" "hubctl" "$@" && exit 0

# Load global env (optional) so subcommands inherit exported AOS_* vars.
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

# Shared UI helpers (gum/fzf fallback + consistent messages).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/ctl-lib.sh"

export CTL_UI_OK_PREFIX="[$APP]"
export CTL_UI_WARN_PREFIX="[$APP]"
export CTL_UI_ERR_PREFIX="[$APP]"

die() { ui_err "$*"; exit 1; }

repo_exec() {
  local rel="$1"; shift || true
  local path="$ROOT_DIR/$rel"
  [[ -e "$path" ]] || die "missing: $path"
  [[ -x "$path" ]] || die "not executable: $path"
  exec "$path" "$@"
}

install_cli() {
  local bin_dir="${HUBCTL_BIN_DIR:-$HOME/.local/bin}"
  local dst="$bin_dir/hubctl"
  mkdir -p "$bin_dir" 2>/dev/null || die "cannot create: $bin_dir (set HUBCTL_BIN_DIR=... )"
  if [[ -e "$dst" && ! -L "$dst" ]]; then
    die "refusing to overwrite non-symlink: $dst"
  fi
  ln -sf "$ROOT_DIR/scripts/hubctl" "$dst"
  ui_ok "installed: $dst"
  if [[ ":$PATH:" != *":$bin_dir:"* ]]; then
    ui_warn "PATH does not include $bin_dir"
    ui_info "Add it with: export PATH=\"$bin_dir:\$PATH\""
  fi
}

uninstall_cli() {
  local bin_dir="${HUBCTL_BIN_DIR:-$HOME/.local/bin}"
  local dst="$bin_dir/hubctl"
  if [[ -L "$dst" ]]; then
    rm -f "$dst"
    ui_ok "removed: $dst"
    return 0
  fi
  ui_info "nothing to remove at: $dst"
}

usage() {
  cat <<EOF
$APP — unified CLI for the hub repo

Usage:
  $APP list
  $APP doctor
  $APP bridge <bridgectl-args...>
  $APP router <routerctl-args...>
  $APP heartbeat <cmd>   (standalone heartbeat manager)
  $APP systemstatus      (trigger GAS system status via local Bridge)
  $APP index  <indexctl-args...>
  $APP sync   <syncctl-args...>
  $APP git    <gitctl-args...>
  $APP backup <backupctl-args...>
  $APP mount  <mountctl-args...>
  $APP hook   <hookctl-args...>
  $APP core4  <core4ctl-args...>
  $APP tent   <tentctl-args...>
  $APP gas    <gasctl-args...>
  $APP firectl <firectl-args...>
  $APP tele  <telectl-args...>
  $APP door   <doorctl-args...>
  $APP game   <gamectl-args...>
  $APP voice  <voicectl-args...>
  $APP fire   <command>

Install into PATH (optional):
  $APP install-cli
  $APP uninstall-cli

Examples:
  $APP list
  $APP doctor
  $APP bridge health
  $APP router doctor
  $APP heartbeat status
  $APP systemstatus
  $APP index doctor
  $APP sync status
  $APP git status
  $APP backup status
  $APP mount status
  $APP hook status
  $APP core4 status
  $APP tent status
  $APP gas tent status
  $APP firectl status
  $APP tele status
  $APP door status
  $APP game status
  $APP voice status
  $APP fire status
  $APP fire enable
  $APP fire run

Env:
  AOS_ENV_FILE=$ROOT_DIR/.env/aos.env
EOF
}

list_scripts() {
  ui_title "$APP list"
  ui_info "Available scripts:"
  local dir="$ROOT_DIR/scripts"
  if [[ -d "$dir" ]]; then
    while IFS= read -r -d '' p; do
      local rel="${p#$ROOT_DIR/}"
      [[ "$rel" == "scripts/hubctl" ]] && continue
      echo "  - $rel"
    done < <(find "$dir" -maxdepth 1 -type f -perm -u+x -print0 2>/dev/null | sort -z)
  else
    ui_warn "missing: $dir"
  fi

  echo ""
  ui_info "Other tools:"
  for p in "$ROOT_DIR/router/routerctl" "$ROOT_DIR/bridge/bridgectl" "$ROOT_DIR/aosctl"; do
    if [[ -x "$p" ]]; then
      echo "  - ${p#$ROOT_DIR/}"
    fi
  done
}

cmd="${1:-}"
shift || true

case "$cmd" in
  -h|--help|help|"") usage ;;
  list) list_scripts ;;
  install-cli) install_cli ;;
  uninstall-cli) uninstall_cli ;;

  doctor) repo_exec "scripts/aos-doctor" "$@" ;;
  bridge) repo_exec "bridge/bridgectl" "$@" ;;
  router) repo_exec "router/routerctl" "$@" ;;
  heartbeat) repo_exec "scripts/heartbeat" "${1:-status}" ;;
  systemstatus) repo_exec "scripts/systemstatusctl" trigger "$@" ;;
  index) repo_exec "scripts/indexctl" "$@" ;;
  sync) repo_exec "scripts/syncctl" "$@" ;;
  git) repo_exec "scripts/gitctl" "$@" ;;
  backup) repo_exec "scripts/backupctl" "$@" ;;
  mount) repo_exec "scripts/mountctl" "$@" ;;
  hook|hooks) repo_exec "scripts/hookctl" "$@" ;;
  core4) repo_exec "python-core4/core4ctl" "$@" ;;
  tent|tentctl) repo_exec "python-tent-bot/tentctl" "$@" ;;
  gas|gasctl) repo_exec "scripts/gasctl" "$@" ;;
  firectl) repo_exec "scripts/firectl" "$@" ;;
  tele|telectl) repo_exec "scripts/telectl" "$@" ;;
  door|doorctl) repo_exec "scripts/doorctl" "$@" ;;
  game|gamectl) repo_exec "scripts/gamectl" "$@" ;;
  voice|voicectl) repo_exec "scripts/voicectl" "$@" ;;
  fire)
    sub="${1:-}"; shift || true
    case "$sub" in
      setup)
        repo_exec "scripts/setup-fire-map.sh" "$@"
        ;;
      run|sync)
        repo_exec "firemap" sync "$@"
        ;;
      status)
        repo_exec "firemap" status
        ;;
      list)
        repo_exec "firemap" list
        ;;
      enable)
        systemctl --user enable --now alphaos-firemap-weekly.timer
        ;;
      disable)
        systemctl --user disable --now alphaos-firemap-weekly.timer
        ;;
      start)
        systemctl --user start alphaos-firemap-weekly.timer
        ;;
      stop)
        systemctl --user stop alphaos-firemap-weekly.timer
        ;;
      logs)
        journalctl --user -u alphaos-firemap-weekly.service -n 200 -f
        ;;
      ""|-h|--help|help)
        cat <<EOF
hubctl fire — Fire Map scheduling + sync

Commands:
  hubctl fire setup        # install Taskwarrior config + weekly timer
  hubctl fire enable       # enable + start weekly timer
  hubctl fire disable      # disable + stop weekly timer
  hubctl fire start|stop   # start/stop weekly timer
  hubctl fire status       # show Fire Map status (current week)
  hubctl fire list         # list Fire Maps
  hubctl fire run|sync     # sync Fire Maps to Taskwarrior now
  hubctl fire logs         # follow weekly sync logs
EOF
        ;;
      *)
        die "unknown fire command: $sub"
        ;;
    esac
    ;;

  *)
    ui_err "unknown command: $cmd"
    usage
    exit 1
    ;;
esac
