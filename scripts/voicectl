#!/usr/bin/env bash
set -euo pipefail

VOICECTL_VERSION="1.1.0"

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

# Shared UI helpers.
# shellcheck disable=SC1091
source "$SCRIPT_DIR/ctl-lib.sh"

SYSTEMCTL_BIN="${SYSTEMCTL_BIN:-systemctl}"
JOURNALCTL_BIN="${JOURNALCTL_BIN:-journalctl}"
SYSTEMCTL_USER=("$SYSTEMCTL_BIN" --user)
JOURNALCTL_USER=("$JOURNALCTL_BIN" --user)

UNITS=(
  "${AOS_VOICE_MOUNT_SERVICE:-rclone-alpha-voice.service}"
)

get_units() {
  local out=()
  local unit
  for unit in "${UNITS[@]}"; do
    [[ -n "$unit" ]] && out+=("$unit")
  done
  printf '%s\n' "${out[@]}"
}

show_help() {
  cat <<'EOF_HELP'
voicectl - Voice service manager

Usage:
  voicectl <command> [args...]

Commands:
  list                       List managed units
  status                     Show status for all units
  start                      Start all units
  stop                       Stop all units
  restart                    Restart all units
  enable                     Enable all units
  disable                    Disable all units
  logs [--follow|-f] [unit]  Show logs for a unit (defaults to all units)
  doctor                     Health check (units + systemd)
  menu                       Interactive menu
  version                    Show version
  help                        Show this help

Notes:
  - Uses systemd user units (systemctl --user).
  - Override unit via AOS_VOICE_MOUNT_SERVICE.
EOF_HELP
}

cmd_list() {
  get_units
}

cmd_status() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  if ((${#units[@]} == 0)); then
    ui_warn "No units configured"
    return 0
  fi
  "${SYSTEMCTL_USER[@]}" status "${units[@]}"
}

cmd_start() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  ((${#units[@]} > 0)) || { ui_warn "No units configured"; return 0; }
  "${SYSTEMCTL_USER[@]}" start "${units[@]}"
}

cmd_stop() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  ((${#units[@]} > 0)) || { ui_warn "No units configured"; return 0; }
  "${SYSTEMCTL_USER[@]}" stop "${units[@]}"
}

cmd_restart() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  ((${#units[@]} > 0)) || { ui_warn "No units configured"; return 0; }
  "${SYSTEMCTL_USER[@]}" restart "${units[@]}"
}

cmd_enable() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  ((${#units[@]} > 0)) || { ui_warn "No units configured"; return 0; }
  "${SYSTEMCTL_USER[@]}" enable "${units[@]}"
}

cmd_disable() {
  need_cmd "$SYSTEMCTL_BIN"
  mapfile -t units < <(get_units)
  ((${#units[@]} > 0)) || { ui_warn "No units configured"; return 0; }
  "${SYSTEMCTL_USER[@]}" disable "${units[@]}"
}

cmd_logs() {
  need_cmd "$JOURNALCTL_BIN"
  local follow=""
  local unit=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -f|--follow) follow="--follow" ;;
      *) unit="$1" ;;
    esac
    shift
  done

  if [[ -n "$unit" ]]; then
    "${JOURNALCTL_USER[@]}" $follow -u "$unit"
    return
  fi

  mapfile -t units < <(get_units)
  if ((${#units[@]} == 0)); then
    ui_warn "No units configured"
    return 0
  fi

  "${JOURNALCTL_USER[@]}" $follow "${units[@]/#/-u }"
}

cmd_doctor() {
  ui_title "voicectl doctor"
  if ! has_cmd "$SYSTEMCTL_BIN"; then
    ui_err "systemctl not found"
    return 1
  fi

  mapfile -t units < <(get_units)
  if ((${#units[@]} == 0)); then
    ui_warn "No units configured"
    return 0
  fi

  for unit in "${units[@]}"; do
    if "${SYSTEMCTL_USER[@]}" is-active --quiet "$unit"; then
      ui_ok "$unit active"
    else
      ui_warn "$unit inactive"
    fi
  done
}

cmd_menu() {
  ui_title "voicectl"
  local action
  action=$(ui_choose "Select" \
    "status" \
    "start" \
    "stop" \
    "restart" \
    "enable" \
    "disable" \
    "logs" \
    "doctor" \
    "list" \
    "quit")

  case "$action" in
    status) cmd_status ;;
    start) cmd_start ;;
    stop) cmd_stop ;;
    restart) cmd_restart ;;
    enable) cmd_enable ;;
    disable) cmd_disable ;;
    logs) cmd_logs ;;
    doctor) cmd_doctor ;;
    list) cmd_list ;;
    quit) exit 0 ;;
    *) exit 0 ;;
  esac
}

cmd_version() {
  echo "voicectl version $VOICECTL_VERSION"
}

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    list) cmd_list ;;
    status) cmd_status ;;
    start) cmd_start ;;
    stop) cmd_stop ;;
    restart) cmd_restart ;;
    enable) cmd_enable ;;
    disable) cmd_disable ;;
    logs) cmd_logs "$@" ;;
    doctor) cmd_doctor ;;
    menu) cmd_menu ;;
    version) cmd_version ;;
    help|-h|--help) show_help ;;
    *)
      ui_err "Unknown command: $cmd"
      show_help
      exit 2
      ;;
  esac
}

main "$@"
