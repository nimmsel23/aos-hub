#!/usr/bin/env bash
# syncvaultctl - Unified sync control for AlphaOS
# Version: 2.4.0
# Description: Simple, safe sync interface + advanced tools

set -euo pipefail

SYNCVAULTCTL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNCVAULTCTL_LIB="${SYNCVAULTCTL_DIR}/syncvaultctl.d"

require_module() {
    local module="$1"
    local file="${SYNCVAULTCTL_LIB}/${module}.sh"
    if [ ! -f "$file" ]; then
        echo "Missing module: $file" >&2
        exit 1
    fi
    # shellcheck disable=SC1090
    source "$file"
}

require_module common
require_module paths
require_module git
require_module rclone

repo_script() {
    local name="$1"
    local base="$SYNCVAULTCTL_DIR/.."
    local p="$base/scripts/sync-utils/$name"
    if [ -x "$p" ]; then
        echo "$p"
        return 0
    fi
    p="$base/scripts/utils/$name"
    if [ -x "$p" ]; then
        echo "$p"
        return 0
    fi
    return 1
}

domain_sync_script() {
    repo_script "rclone-domain-sync.sh" && return 0
    local p="$HOME/.dotfiles/scripts/utils/rclone-domain-sync.sh"
    [ -x "$p" ] && echo "$p" && return 0
    return 1
}

vitaltrainer_copy_script() {
    repo_script "rclone-vitaltrainer-copy.sh" && return 0
    local p="$HOME/.dotfiles/scripts/utils/rclone-vitaltrainer-copy.sh"
    [ -x "$p" ] && echo "$p" && return 0
    return 1
}

# Show all sync timers
show_timers() {
    print_header "üìÖ SCHEDULED SYNCS (systemd timers)"

    echo ""
    systemctl --user list-timers --all | grep -E "(auto-push|domain-sync|vault-sync|vitaltrainer-sync|vitaltrainer-rclone|desktop-sync|fadaro-rclone)" || echo "No sync timers found"
}

# Safe sync: no deletes, no bisync
sync_all() {
    print_header "‚úÖ SAFE SYNC (no deletes)"

    # Git auto-sync (safe)
    echo ""
    print_msg "$BOLD$YELLOW" "Git auto-sync (safe)..."
    run_allow_fail git_autosync_all

    # Rclone copy push (safe)
    echo ""
    print_msg "$BOLD$YELLOW" "Rclone copy push (safe)..."
    local vaultctl
    vaultctl="$(vaultctl_cmd)" || true
    if [ -n "${vaultctl:-}" ]; then
        run_allow_fail "$vaultctl" sync
    fi
    local vital_script
    vital_script="$(vitaltrainer_copy_script || true)"
    if [ -n "${vital_script:-}" ]; then
        run_allow_fail "$vital_script" push
    fi

    local domain_script
    domain_script="$(domain_sync_script || true)"
    if [ -n "${domain_script:-}" ]; then
        for domain in BODY BEING BALANCE BUSINESS; do
            run_allow_fail "$domain_script" "$domain" push
        done
    fi

    echo ""
    print_msg "$GREEN" "‚úì Safe sync completed"
}

# Safe pull: no deletes
pull_all() {
    print_header "‚¨áÔ∏è SAFE PULL (no deletes)"

    local vaultctl
    vaultctl="$(vaultctl_cmd)" || true
    if [ -n "${vaultctl:-}" ]; then
        run_allow_fail "$vaultctl" pull
    fi
    local vital_script
    vital_script="$(vitaltrainer_copy_script || true)"
    if [ -n "${vital_script:-}" ]; then
        run_allow_fail "$vital_script" pull
    fi

    local domain_script
    domain_script="$(domain_sync_script || true)"
    if [ -n "${domain_script:-}" ]; then
        for domain in BODY BEING BALANCE BUSINESS; do
            run_allow_fail "$domain_script" "$domain" pull
        done
    fi

    echo ""
    print_msg "$GREEN" "‚úì Safe pull completed"
}

# Sync specific domain (safe copy push)
sync_domain() {
    local domain="${1^^}"  # Convert to uppercase

    if [[ ! "$domain" =~ ^(BODY|BEING|BALANCE|BUSINESS)$ ]]; then
        print_msg "$RED" "Invalid domain. Must be one of: BODY, BEING, BALANCE, BUSINESS"
        return 1
    fi

    print_header "$(domain_emoji "$domain") Pushing ${domain} Domain (copy)"

    local script
    script="$(domain_sync_script || true)"
    if [ -z "${script:-}" ]; then
        print_msg "$RED" "Domain sync script not found"
        return 1
    fi
    "$script" "$domain" push
}

# Copy mode info (no init required)
init_rclone() {
    print_header "‚ÑπÔ∏è  RCLONE INIT"
    echo ""
    echo "Bisync has been replaced with copy push/pull."
    echo "No init is required."
}

menu_advanced() {
    if ! have_gum || ! have_tty; then
        print_msg "$RED" "gum not available or no TTY"
        return 1
    fi

    while true; do
        local choice
        choice="$(printf "%s\n" \
            "Status overview" \
            "Timers overview" \
            "Vault sync (vaultctl)" \
            "Domain copy (push/pull)" \
            "Vitaltrainer copy (push/pull)" \
            "AOS sync targets" \
            "AlphaOS-Vault git sync" \
            "Vitaltrainer git sync" \
            "FADARO git sync" \
            "Vault git tools" \
            "Domain logs (last 10 files)" \
            "Git status" \
            "Back" \
            | gum choose --header "syncvaultctl advanced")"

        case "$choice" in
            "Status overview")
                show_status
                pause_screen
                ;;
            "Timers overview")
                show_timers
                pause_screen
                ;;
            "Vault sync (vaultctl)") menu_vaultctl ;;
            "Domain copy (push/pull)") menu_domains ;;
            "Vitaltrainer copy (push/pull)") menu_vitaltrainer_copy ;;
            "AOS sync targets") menu_aos_sync ;;
            "AlphaOS-Vault git sync") menu_vault_push ;;
            "Vitaltrainer git sync") menu_vitaltrainer_push ;;
            "FADARO git sync") menu_fadaro_push ;;
            "Vault git tools") menu_vault_git ;;
            "Domain logs (last 10 files)")
                show_domain_logs
                pause_screen
                ;;
            "Git status")
                show_git_status
                pause_screen
                ;;
            "Back") break ;;
        esac
    done
}

menu_main() {
    if ! have_gum || ! have_tty; then
        print_msg "$RED" "gum not available or no TTY; use syncvaultctl status/help instead"
        return 1
    fi

    while true; do
        local choice
        choice="$(printf "%s\n" \
            "Status" \
            "Sync now (safe)" \
            "Pull now (safe)" \
            "Advanced" \
            "Quit" \
            | gum choose --header "syncvaultctl")"

        case "$choice" in
            "Status")
                show_status
                pause_screen
                ;;
            "Sync now (safe)")
                sync_all
                pause_screen
                ;;
            "Pull now (safe)")
                pull_all
                pause_screen
                ;;
            "Advanced") menu_advanced ;;
            "Quit") break ;;
        esac
    done
}

# Show comprehensive status (default)
show_status() {
    show_timers
    show_git_status
    show_rclone_status
}

# Print help
show_help() {
    cat << EOF
${BOLD}syncvaultctl${NC} - Unified sync control for AlphaOS v2.4

${BOLD}SIMPLE COMMANDS:${NC}
    syncvaultctl             Show status overview (default)
    syncvaultctl sync        Safe sync all (no deletes)
    syncvaultctl pull        Safe pull all (no deletes)
    syncvaultctl menu        Simple menu
    syncvaultctl advanced    Advanced menu

${BOLD}ADVANCED COMMANDS:${NC}
    timers              Show scheduled sync timers
    git                 Show git sync status only
    rclone              Show rclone status only
    domains             Show 4 Domains status only
    sync <DOMAIN>       Push specific domain (BODY|BEING|BALANCE|BUSINESS)
    vault <cmd>         Vault git tools (sync/status/log/diff/remote/check/setup)
    vault-sync          Auto-commit + pull/push AlphaOS-Vault
    vitaltrainer-sync   Auto-commit + pull/push Vitaltrainer
    fadaro-sync         Auto-commit + pull/push FADARO
    vault-push          Alias of vault-sync
    vitaltrainer-push   Alias of vitaltrainer-sync
    fadaro-push         Alias of fadaro-sync
    log                 Show last 10 pushed files for all domains
    init                Info (no init required for copy mode)
    help                Show this help message

${BOLD}NOTES:${NC}
    - Safe sync/pull use rclone copy (no deletes)
    - Overwrite remote (delete) is only in Advanced ‚Üí Domain menu (push-sync)
EOF
}

# Main command dispatcher
main() {
    case "${1:-status}" in
        menu)
            menu_main
            ;;
        advanced)
            menu_advanced
            ;;
        status)
            show_status
            ;;
        sync)
            if [ $# -eq 2 ]; then
                sync_domain "$2"
            else
                sync_all
            fi
            ;;
        pull)
            pull_all
            ;;
        timers)
            show_timers
            ;;
        git)
            show_git_status
            ;;
        rclone)
            show_rclone_status
            ;;
        domains)
            show_domains_status
            ;;
        vault-sync|vault-push)
            vault_git_sync
            ;;
        vitaltrainer-sync|vitaltrainer-push)
            vitaltrainer_git_sync
            ;;
        fadaro-sync|fadaro-push)
            fadaro_git_sync
            ;;
        log|logs|--log)
            show_domain_logs
            ;;
        init)
            init_rclone
            ;;
        vault)
            shift
            vault_git_dispatch "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_msg "$RED" "Unknown command: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
