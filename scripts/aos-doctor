#!/usr/bin/env bash
set -u

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ROUTERCTL="$ROOT_DIR/router/routerctl"
BRIDGECTL="$ROOT_DIR/bridge/bridgectl"

INDEX_URL="${AOS_INDEX_URL:-http://127.0.0.1:8799/api/centres}"
BRIDGE_HEALTH_URL="${AOS_BRIDGE_HEALTH_URL:-http://127.0.0.1:8080/health}"

USER_UNITS_DEFAULT=(
  "alphaos-router.service"
  "aos-bridge.service"
  "alphaos-heartbeat.timer"
  "aos-vault-push-eldanioo.timer"
  "dokumente-push-fabian.timer"
)

SYSTEM_UNITS_DEFAULT=(
  "aos-router.service"
  "aos-bridge.service"
  "aos-index.service"
)

print_title() {
  printf "\n== %s ==\n" "$1"
}

print_kv() {
  printf "%-18s %s\n" "$1" "$2"
}

has_cmd() { command -v "$1" >/dev/null 2>&1; }

run_cmd() {
  local label="$1"
  shift
  printf "\n-- %s --\n" "$label"
  if "$@"; then
    return 0
  fi
  printf "ERR: command failed (%s)\n" "$label"
  return 1
}

systemctl_user_ok() {
  systemctl --user show-environment >/dev/null 2>&1
}

unit_status() {
  local unit="$1"
  local active="unknown"
  local enabled="unknown"
  active="$(systemctl --user is-active "$unit" 2>/dev/null || true)"
  enabled="$(systemctl --user is-enabled "$unit" 2>/dev/null || true)"
  printf "%-32s active=%-10s enabled=%s\n" "$unit" "$active" "$enabled"
}

show_units() {
  if ! has_cmd systemctl; then
    echo "systemctl not found."
    return 0
  fi
  if ! systemctl_user_ok; then
    echo "systemctl --user not available (no user bus)."
    return 0
  fi

local units=("${USER_UNITS_DEFAULT[@]}")
if [[ -n "${AOS_USER_UNITS:-}" ]]; then
  read -r -a units <<<"${AOS_USER_UNITS}"
fi

for unit in "${units[@]}"; do
  unit_status "$unit"
done
}

unit_status_system() {
  local unit="$1"
  local active="unknown"
  local enabled="unknown"
  active="$(systemctl is-active "$unit" 2>/dev/null || true)"
  enabled="$(systemctl is-enabled "$unit" 2>/dev/null || true)"
  printf "%-32s active=%-10s enabled=%s\n" "$unit" "$active" "$enabled"
}

show_system_units() {
  if ! has_cmd systemctl; then
    echo "systemctl not found."
    return 0
  fi
  local units=("${SYSTEM_UNITS_DEFAULT[@]}")
  if [[ -n "${AOS_SYSTEM_UNITS:-}" ]]; then
    read -r -a units <<<"${AOS_SYSTEM_UNITS}"
  fi
  for unit in "${units[@]}"; do
    unit_status_system "$unit"
  done
}

http_check() {
  local label="$1"
  local url="$2"
  if ! has_cmd curl; then
    printf "%s: curl not found\n" "$label"
    return 0
  fi
  if curl -fsS -o /dev/null "$url"; then
    printf "%s: OK (%s)\n" "$label" "$url"
  else
    printf "%s: FAIL (%s)\n" "$label" "$url"
  fi
}

print_help() {
  cat <<EOF
aos-doctor â€” combined status report

Usage:
  scripts/aos-doctor

Env overrides:
  AOS_INDEX_URL=http://127.0.0.1:8799/api/centres
  AOS_BRIDGE_HEALTH_URL=http://127.0.0.1:8080/health
  AOS_USER_UNITS="unit1.service unit2.timer"
  AOS_SYSTEM_UNITS="unit1.service unit2.timer"
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  print_help
  exit 0
fi

print_title "AlphaOS Doctor"
print_kv "Root" "$ROOT_DIR"
print_kv "routerctl" "$ROUTERCTL"
print_kv "bridgectl" "$BRIDGECTL"

print_title "Systemd (user)"
show_units

print_title "Systemd (system)"
show_system_units

print_title "HTTP checks"
http_check "Index API" "$INDEX_URL"
http_check "Bridge health" "$BRIDGE_HEALTH_URL"

if [[ -x "$ROUTERCTL" ]]; then
  print_title "routerctl doctor"
  "$ROUTERCTL" doctor || true
else
  print_title "routerctl doctor"
  echo "routerctl not found or not executable."
fi

if [[ -x "$BRIDGECTL" ]]; then
  print_title "bridgectl doctor"
  "$BRIDGECTL" doctor || true
else
  print_title "bridgectl doctor"
  echo "bridgectl not found or not executable."
fi
