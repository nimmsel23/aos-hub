#!/usr/bin/env bash
set -u
set -o pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ROUTERCTL="$ROOT_DIR/router/routerctl"
BRIDGECTL="$ROOT_DIR/bridge/bridgectl"

# Load shared env (optional). Makes AOS_* overrides consistent across scripts.
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

INDEX_URL="${AOS_INDEX_URL:-http://127.0.0.1:8799/api/centres}"
BRIDGE_HEALTH_URL="${AOS_BRIDGE_HEALTH_URL:-http://127.0.0.1:8080/health}"

USER_UNITS_DEFAULT=(
  "alphaos-router.service"
  "aos-bridge.service"
  "alphaos-heartbeat.timer"
  "aos-vault-push-eldanioo.timer"
  "dokumente-push-fabian.timer"
)

SYSTEM_UNITS_DEFAULT=(
  "aos-router.service"
  "aos-bridge.service"
  "aos-index.service"
)

print_title() {
  printf "\n== %s ==\n" "$1"
}

print_kv() {
  printf "%-18s %s\n" "$1" "$2"
}

has_cmd() { command -v "$1" >/dev/null 2>&1; }

systemctl_user_ok() {
  systemctl --user show-environment >/dev/null 2>&1
}

systemctl_system_ok() {
  systemctl list-units --no-pager >/dev/null 2>&1
}

# Summary counters (populated by check functions)
SYSTEMD_USER_AVAILABLE=0
SYSTEMD_SYSTEM_AVAILABLE=0

USER_UNITS_TOTAL=0
USER_UNITS_ACTIVE=0

SYSTEM_UNITS_TOTAL=0
SYSTEM_UNITS_ACTIVE=0

HTTP_TOTAL=0
HTTP_OK=0
HTTP_FAIL=0
HTTP_SKIPPED=0

ROUTER_DOCTOR_STATUS="skipped"
BRIDGE_DOCTOR_STATUS="skipped"

unit_status_user() {
  local unit="$1"
  local active enabled
  active="$(systemctl --user is-active "$unit" 2>/dev/null || true)"
  enabled="$(systemctl --user is-enabled "$unit" 2>/dev/null || true)"

  ((USER_UNITS_TOTAL++))
  if [[ "$active" == "active" ]]; then
    ((USER_UNITS_ACTIVE++))
  fi

  printf "%-32s active=%-10s enabled=%s\n" "$unit" "$active" "$enabled"
}

show_units_user() {
  if ! has_cmd systemctl; then
    echo "systemctl not found."
    SYSTEMD_USER_AVAILABLE=0
    return 0
  fi
  if ! systemctl_user_ok; then
    echo "systemctl --user not available (no user bus)."
    SYSTEMD_USER_AVAILABLE=0
    return 0
  fi

  SYSTEMD_USER_AVAILABLE=1

  local units=("${USER_UNITS_DEFAULT[@]}")
  if [[ -n "${AOS_USER_UNITS:-}" ]]; then
    read -r -a units <<<"${AOS_USER_UNITS}"
  fi

  for unit in "${units[@]}"; do
    unit_status_user "$unit"
  done
}

unit_status_system() {
  local unit="$1"
  local active enabled
  active="$(systemctl is-active "$unit" 2>/dev/null || true)"
  enabled="$(systemctl is-enabled "$unit" 2>/dev/null || true)"

  ((SYSTEM_UNITS_TOTAL++))
  if [[ "$active" == "active" ]]; then
    ((SYSTEM_UNITS_ACTIVE++))
  fi

  printf "%-32s active=%-10s enabled=%s\n" "$unit" "$active" "$enabled"
}

show_units_system() {
  if ! has_cmd systemctl; then
    echo "systemctl not found."
    SYSTEMD_SYSTEM_AVAILABLE=0
    return 0
  fi
  if ! systemctl_system_ok; then
    echo "systemctl (system) not available (no system bus)."
    SYSTEMD_SYSTEM_AVAILABLE=0
    return 0
  fi

  SYSTEMD_SYSTEM_AVAILABLE=1

  local units=("${SYSTEM_UNITS_DEFAULT[@]}")
  if [[ -n "${AOS_SYSTEM_UNITS:-}" ]]; then
    read -r -a units <<<"${AOS_SYSTEM_UNITS}"
  fi

  for unit in "${units[@]}"; do
    unit_status_system "$unit"
  done
}

http_check() {
  local label="$1"
  local url="$2"

  ((HTTP_TOTAL++))

  if ! has_cmd curl; then
    ((HTTP_SKIPPED++))
    printf "%s: SKIP (curl not found)\n" "$label"
    return 2
  fi

  if curl -fsS -o /dev/null "$url"; then
    ((HTTP_OK++))
    printf "%s: OK (%s)\n" "$label" "$url"
    return 0
  fi

  ((HTTP_FAIL++))
  printf "%s: FAIL (%s)\n" "$label" "$url"
  return 1
}

print_help() {
  cat <<'__HELP__'
aos-doctor â€” combined status report

Usage:
  scripts/aos-doctor

Env overrides:
  AOS_INDEX_URL=http://127.0.0.1:8799/api/centres
  AOS_BRIDGE_HEALTH_URL=http://127.0.0.1:8080/health
  AOS_USER_UNITS="unit1.service unit2.timer"
  AOS_SYSTEM_UNITS="unit1.service unit2.timer"
__HELP__
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
  print_help
  exit 0
fi

print_title "AlphaOS Doctor"
print_kv "Root" "$ROOT_DIR"
print_kv "Env" "${AOS_ENV_FILE_EFFECTIVE:-$ROOT_DIR/.env/aos.env (missing)}"
print_kv "routerctl" "$ROUTERCTL"
print_kv "bridgectl" "$BRIDGECTL"

print_title "Systemd (user)"
show_units_user

print_title "Systemd (system)"
show_units_system

print_title "HTTP checks"
http_check "Index API" "$INDEX_URL" || true
http_check "Bridge health" "$BRIDGE_HEALTH_URL" || true

print_title "routerctl doctor"
if [[ -x "$ROUTERCTL" ]]; then
  if "$ROUTERCTL" doctor; then
    ROUTER_DOCTOR_STATUS="ok"
  else
    ROUTER_DOCTOR_STATUS="fail"
  fi
else
  ROUTER_DOCTOR_STATUS="missing"
  echo "routerctl not found or not executable."
fi

print_title "bridgectl doctor"
if [[ -x "$BRIDGECTL" ]]; then
  if "$BRIDGECTL" doctor; then
    BRIDGE_DOCTOR_STATUS="ok"
  else
    BRIDGE_DOCTOR_STATUS="fail"
  fi
else
  BRIDGE_DOCTOR_STATUS="missing"
  echo "bridgectl not found or not executable."
fi

print_title "Summary"
if ((SYSTEMD_USER_AVAILABLE)); then
  printf "Systemd (user):   %s/%s active\n" "$USER_UNITS_ACTIVE" "$USER_UNITS_TOTAL"
else
  printf "Systemd (user):   skipped\n"
fi

if ((SYSTEMD_SYSTEM_AVAILABLE)); then
  printf "Systemd (system): %s/%s active\n" "$SYSTEM_UNITS_ACTIVE" "$SYSTEM_UNITS_TOTAL"
else
  printf "Systemd (system): skipped\n"
fi

if ((HTTP_TOTAL)); then
  printf "HTTP checks:      %s ok, %s fail" "$HTTP_OK" "$HTTP_FAIL"
  if ((HTTP_SKIPPED)); then
    printf ", %s skipped" "$HTTP_SKIPPED"
  fi
  printf "\n"
else
  printf "HTTP checks:      skipped\n"
fi

printf "routerctl doctor: %s\n" "$ROUTER_DOCTOR_STATUS"
printf "bridgectl doctor: %s\n" "$BRIDGE_DOCTOR_STATUS"
