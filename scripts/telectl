#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

APP="telectl"
TELECTL_VERSION="0.1.0"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd -P)"

# Load global env (optional).
# shellcheck disable=SC1091
source "$SCRIPT_DIR/lib/aos-env.sh"
aos_env_load "" "$ROOT_DIR" || true

TELE_BIN="${AOS_TELE_BIN:-tele}"

has_cmd() { command -v "$1" >/dev/null 2>&1; }
die() { printf "ERR: %s\n" "$*" >&2; exit 1; }

need_tele() { has_cmd "$TELE_BIN" || die "missing: $TELE_BIN"; }

run_tele() {
  need_tele
  "$TELE_BIN" "$@"
}

usage() {
  cat <<EOF
$APP â€” Telegram sender wrappers (${TELECTL_VERSION})

Usage:
  telectl status
  telectl send [-s|--silent] <text...>
  telectl doc  [-s|--silent] <file> [caption...]
  telectl fire daily|weekly
  telectl blueprint send [--scope all|foundation|voice|door|game]
  telectl help

Env:
  AOS_TELE_BIN=tele
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  -h|--help|help) usage ;;
  version|-v|--version) echo "$APP $TELECTL_VERSION" ;;

  status)
    run_tele --status
    ;;

  send)
    run_tele "$@"
    ;;

  doc|document)
    [[ $# -ge 1 ]] || die "doc requires a file path"
    file="$1"; shift || true
    args=()
    if [[ "${1:-}" == "-s" || "${1:-}" == "--silent" ]]; then
      args+=("-s")
      shift || true
    fi
    run_tele "${args[@]}" --document "$file" --caption "${*:-}"
    ;;

  fire)
    scope="${1:-}"
    case "$scope" in
      daily|weekly) ;;
      *) die "usage: telectl fire daily|weekly" ;;
    esac
    exec "$ROOT_DIR/scripts/firectl" send "$scope"
    ;;

  blueprint)
    sub="${1:-}"
    shift || true
    case "$sub" in
      send)
        exec "$ROOT_DIR/scripts/blueprintctl" send "$@"
        ;;
      *)
        die "usage: telectl blueprint send [--scope ...]"
        ;;
    esac
    ;;

  *)
    usage
    exit 1
    ;;
esac

