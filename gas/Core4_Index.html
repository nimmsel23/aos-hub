<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CORE4</title>
    <style>
      :root {
        --bg: #0a0e17;
        --surface: rgba(255,255,255,0.04);
        --surface2: rgba(255,255,255,0.07);
        --text: rgba(255,255,255,0.92);
        --muted: rgba(255,255,255,0.5);
        --line: rgba(255,255,255,0.1);
        --body: #ef4444;
        --body-bg: rgba(239,68,68,0.12);
        --being: #a855f7;
        --being-bg: rgba(168,85,247,0.12);
        --balance: #ec4899;
        --balance-bg: rgba(236,72,153,0.12);
        --business: #eab308;
        --business-bg: rgba(234,179,8,0.12);
        --done: rgba(255,255,255,0.15);
        --radius: 12px;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, 'Segoe UI', Roboto, sans-serif; font-size: 14px; min-height: 100vh; }

      .app { max-width: 520px; margin: 0 auto; padding: 16px 12px 40px; }

      /* Header */
      .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; margin-bottom: 8px; }
      .header-left { display: flex; align-items: baseline; gap: 10px; }
      .header h1 { font-size: 16px; font-weight: 800; letter-spacing: 1.5px; }
      .header-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
      .header-meta .score { font-weight: 700; color: var(--text); font-size: 14px; }

      /* Progress bar */
      .progress-wrap { height: 4px; background: var(--surface2); border-radius: 2px; margin-bottom: 14px; overflow: hidden; }
      .progress-bar { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.4s ease; }

      /* Day selector */
      .day-strip { display: flex; align-items: center; gap: 4px; margin-bottom: 14px; }
      .day-strip .arrow { background: none; border: 1px solid var(--line); color: var(--muted); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
      .day-strip .arrow:hover { background: var(--surface2); color: var(--text); }
      .day-strip .days { display: flex; gap: 3px; flex: 1; justify-content: center; }
      .day-strip .day-btn { flex: 1; max-width: 52px; background: var(--surface); border: 1px solid transparent; color: var(--muted); border-radius: 8px; padding: 6px 2px; cursor: pointer; text-align: center; font-size: 11px; line-height: 1.3; }
      .day-strip .day-btn:hover { background: var(--surface2); }
      .day-strip .day-btn.active { border-color: rgba(255,255,255,0.25); color: var(--text); background: var(--surface2); font-weight: 700; }
      .day-strip .day-btn.today { border-color: rgba(99,102,241,0.5); }
      .day-btn .day-name { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
      .day-btn .day-num { font-size: 13px; font-weight: 700; margin-top: 1px; }

      /* Domain cards 2x2 */
      .domains { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
      .domain-card { border: 1px solid var(--line); border-radius: var(--radius); padding: 10px; position: relative; overflow: hidden; }
      .domain-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
      .domain-card.body { background: var(--body-bg); }
      .domain-card.body::before { background: var(--body); }
      .domain-card.being { background: var(--being-bg); }
      .domain-card.being::before { background: var(--being); }
      .domain-card.balance { background: var(--balance-bg); }
      .domain-card.balance::before { background: var(--balance); }
      .domain-card.business { background: var(--business-bg); }
      .domain-card.business::before { background: var(--business); }

      .domain-head { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 8px; }
      .domain-name { font-size: 11px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
      .domain-score { font-size: 11px; color: var(--muted); }

      .habit-row { display: flex; gap: 6px; }
      .habit-btn { flex: 1; display: flex; align-items: center; gap: 6px; padding: 7px 8px; border-radius: 8px; border: 1px solid var(--line); background: rgba(0,0,0,0.2); cursor: pointer; color: var(--text); font-size: 12px; font-weight: 600; transition: all 0.15s; }
      .habit-btn:hover { background: rgba(0,0,0,0.35); }
      .habit-btn.done { border-color: rgba(255,255,255,0.2); background: var(--done); }
      .habit-btn .check { width: 14px; height: 14px; border-radius: 4px; border: 1.5px solid var(--muted); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; }
      .habit-btn.done .check { border-color: currentColor; background: currentColor; }
      .habit-btn.done .check::after { content: 'âœ“'; color: var(--bg); font-weight: 900; font-size: 9px; }
      .domain-card.body .habit-btn.done .check { background: var(--body); border-color: var(--body); }
      .domain-card.being .habit-btn.done .check { background: var(--being); border-color: var(--being); }
      .domain-card.balance .habit-btn.done .check { background: var(--balance); border-color: var(--balance); }
      .domain-card.business .habit-btn.done .check { background: var(--business); border-color: var(--business); }

      /* Heatmap */
      .heatmap { display: flex; gap: 4px; margin-bottom: 14px; }
      .heat-day { flex: 1; text-align: center; }
      .heat-label { font-size: 10px; color: var(--muted); margin-bottom: 3px; text-transform: uppercase; }
      .heat-bar { height: 6px; border-radius: 3px; background: var(--surface2); overflow: hidden; }
      .heat-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
      .heat-fill.q0 { width: 0%; }
      .heat-fill.q1 { width: 25%; background: #f87171; }
      .heat-fill.q2 { width: 50%; background: #fb923c; }
      .heat-fill.q3 { width: 75%; background: #a3e635; }
      .heat-fill.q4 { width: 100%; background: #4ade80; }

      /* Journal */
      .journal-section { border: 1px solid var(--line); border-radius: var(--radius); padding: 12px; background: var(--surface); margin-bottom: 14px; }
      .journal-section h3 { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 8px; }
      .journal-controls { display: flex; gap: 6px; margin-bottom: 8px; }
      .journal-select { flex: 1; padding: 7px 8px; border-radius: 8px; border: 1px solid var(--line); background: rgba(0,0,0,0.25); color: var(--text); font-size: 12px; }
      .journal-textarea { width: 100%; min-height: 72px; padding: 8px; border-radius: 8px; border: 1px solid var(--line); background: rgba(0,0,0,0.25); color: var(--text); font-size: 13px; resize: vertical; font-family: inherit; margin-bottom: 6px; }
      .journal-textarea:focus { outline: none; border-color: rgba(99,102,241,0.5); }
      .btn-save { padding: 7px 14px; border-radius: 8px; border: 1px solid rgba(99,102,241,0.4); background: rgba(99,102,241,0.2); color: var(--text); font-size: 12px; font-weight: 700; cursor: pointer; }
      .btn-save:hover { background: rgba(99,102,241,0.3); }
      .btn-save:disabled { opacity: 0.4; cursor: default; }
      .journal-entries { margin-top: 8px; }
      .journal-entry { padding: 6px 0; border-bottom: 1px solid var(--line); font-size: 12px; color: var(--muted); }
      .journal-entry:last-child { border-bottom: none; }
      .journal-entry .je-label { font-weight: 700; color: var(--text); }

      /* Actions bar */
      .actions { display: flex; gap: 6px; flex-wrap: wrap; }
      .act-btn { padding: 7px 12px; border-radius: 8px; border: 1px solid var(--line); background: var(--surface); color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer; }
      .act-btn:hover { background: var(--surface2); color: var(--text); }

      /* Toast */
      .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px); opacity: 0; padding: 8px 16px; border-radius: 8px; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); border: 1px solid var(--line); font-size: 12px; z-index: 999; transition: all 0.2s; pointer-events: none; white-space: nowrap; }
      .toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* Loading */
      .loading { text-align: center; padding: 20px; color: var(--muted); font-size: 12px; }

      @media (max-width: 380px) {
        .domains { grid-template-columns: 1fr; }
        .day-strip .day-btn { max-width: none; }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="header-left">
          <h1>CORE4</h1>
        </div>
        <div class="header-meta">
          <span id="weekLabel">W--</span>
          <span id="weekScore" class="score">--/28</span>
          <span id="weekPct">(--)</span>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar" id="progressBar" style="width:0%"></div>
      </div>

      <div class="day-strip">
        <button class="arrow" onclick="shiftWeek(-1)">&larr;</button>
        <div class="days" id="dayStrip"></div>
        <button class="arrow" onclick="shiftWeek(1)">&rarr;</button>
      </div>

      <div class="domains" id="domainGrid">
        <div class="domain-card body">
          <div class="domain-head"><span class="domain-name">Body</span><span class="domain-score" id="sc-body">0/1</span></div>
          <div class="habit-row">
            <button class="habit-btn" id="hb-body-fitness" onclick="toggle('body','fitness')"><span class="check"></span>Fitness</button>
            <button class="habit-btn" id="hb-body-fuel" onclick="toggle('body','fuel')"><span class="check"></span>Fuel</button>
          </div>
        </div>
        <div class="domain-card being">
          <div class="domain-head"><span class="domain-name">Being</span><span class="domain-score" id="sc-being">0/1</span></div>
          <div class="habit-row">
            <button class="habit-btn" id="hb-being-meditation" onclick="toggle('being','meditation')"><span class="check"></span>Meditation</button>
            <button class="habit-btn" id="hb-being-memoirs" onclick="toggle('being','memoirs')"><span class="check"></span>Memoirs</button>
          </div>
        </div>
        <div class="domain-card balance">
          <div class="domain-head"><span class="domain-name">Balance</span><span class="domain-score" id="sc-balance">0/1</span></div>
          <div class="habit-row">
            <button class="habit-btn" id="hb-balance-person1" onclick="toggle('balance','person1')"><span class="check"></span>Person 1</button>
            <button class="habit-btn" id="hb-balance-person2" onclick="toggle('balance','person2')"><span class="check"></span>Person 2</button>
          </div>
        </div>
        <div class="domain-card business">
          <div class="domain-head"><span class="domain-name">Business</span><span class="domain-score" id="sc-business">0/1</span></div>
          <div class="habit-row">
            <button class="habit-btn" id="hb-business-discover" onclick="toggle('business','discover')"><span class="check"></span>Discover</button>
            <button class="habit-btn" id="hb-business-declare" onclick="toggle('business','declare')"><span class="check"></span>Declare</button>
          </div>
        </div>
      </div>

      <div class="heatmap" id="heatmap"></div>

      <div class="journal-section">
        <h3>JOURNAL</h3>
        <div class="journal-controls">
          <select class="journal-select" id="journalHabit">
            <option value="body:fitness">Fitness</option>
            <option value="body:fuel">Fuel</option>
            <option value="being:meditation">Meditation</option>
            <option value="being:memoirs">Memoirs</option>
            <option value="balance:person1">Person 1</option>
            <option value="balance:person2">Person 2</option>
            <option value="business:discover">Discover</option>
            <option value="business:declare">Declare</option>
          </select>
          <button class="btn-save" id="btnSaveJournal" onclick="saveJournal()">Save</button>
        </div>
        <textarea class="journal-textarea" id="journalText" placeholder="Write your journal entry..."></textarea>
        <div class="journal-entries" id="journalEntries"></div>
      </div>

      <div class="actions">
        <button class="act-btn" onclick="showWeekSummary()">Week Summary</button>
        <button class="act-btn" onclick="exportWeek()">Export &rarr; Drive</button>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      /* ---- State ---- */
      var selectedDate = '';
      var weekDates = [];
      var weekOffset = 0;
      var dayHabits = {}; // { "body:fitness": true, ... }
      var weekTotals = {}; // { "2026-02-10": 2.5, ... }

      var DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

      /* ---- Helpers ---- */
      function pad2(n) { return String(n).padStart(2,'0'); }
      function isoLocal(d) { return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
      function parseDate(s) { var p=s.split('-'); return new Date(+p[0],+p[1]-1,+p[2]); }

      function getMonday(d) {
        var dt = new Date(d);
        var day = dt.getDay() || 7;
        dt.setDate(dt.getDate() - (day - 1));
        return dt;
      }

      function buildWeekDates(refDate) {
        var mon = getMonday(refDate);
        var out = [];
        for (var i=0; i<7; i++) {
          var d = new Date(mon);
          d.setDate(mon.getDate()+i);
          out.push(isoLocal(d));
        }
        return out;
      }

      function showToast(msg) {
        var el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('on');
        clearTimeout(el._t);
        el._t = setTimeout(function(){ el.classList.remove('on'); }, 1600);
      }

      function isGAS() {
        return typeof google !== 'undefined' && google.script && google.script.run;
      }

      /* ---- Navigation ---- */
      function initWeek() {
        var today = new Date();
        today.setDate(today.getDate() + weekOffset * 7);
        weekDates = buildWeekDates(today);
        if (!selectedDate || weekDates.indexOf(selectedDate) === -1) {
          var todayStr = isoLocal(new Date());
          selectedDate = weekDates.indexOf(todayStr) >= 0 ? todayStr : weekDates[0];
        }
        renderDayStrip();
        loadDay(selectedDate);
        loadWeekData();
      }

      function shiftWeek(dir) {
        weekOffset += dir;
        selectedDate = '';
        initWeek();
      }

      function selectDay(dateKey) {
        selectedDate = dateKey;
        renderDayStrip();
        loadDay(dateKey);
        loadJournal(dateKey);
      }

      function renderDayStrip() {
        var todayStr = isoLocal(new Date());
        var html = '';
        for (var i=0; i<weekDates.length; i++) {
          var dk = weekDates[i];
          var dt = parseDate(dk);
          var cls = 'day-btn';
          if (dk === selectedDate) cls += ' active';
          if (dk === todayStr) cls += ' today';
          html += '<button class="'+cls+'" onclick="selectDay(\''+dk+'\')">';
          html += '<div class="day-name">'+DAY_NAMES[i]+'</div>';
          html += '<div class="day-num">'+dt.getDate()+'</div>';
          html += '</button>';
        }
        document.getElementById('dayStrip').innerHTML = html;
      }

      /* ---- Data loading ---- */
      function loadDay(dateKey) {
        if (!isGAS()) return;
        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || !res.ok) return;
            renderDayState(res);
          })
          .withFailureHandler(function(e){ showToast('Load error'); })
          .core4_getDayState(dateKey);
        loadJournal(dateKey);
      }

      function loadWeekData() {
        if (!isGAS()) { renderHeatmap(); return; }
        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || !res.ok) return;
            weekTotals = (res.totals && res.totals.by_day) || {};
            var wt = (res.totals && res.totals.week_total) || 0;
            document.getElementById('weekLabel').textContent = res.week || 'W--';
            document.getElementById('weekScore').textContent = wt + '/28';
            var pct = Math.round((wt/28)*100);
            document.getElementById('weekPct').textContent = '(' + pct + '%)';
            document.getElementById('progressBar').style.width = Math.min(pct, 100) + '%';
            renderHeatmap();
          })
          .withFailureHandler(function(){})
          .core4_getWeekSummaryForDate(selectedDate || weekDates[0]);
      }

      function renderDayState(state) {
        // Reset all habits
        dayHabits = {};
        var domainPoints = { body:0, being:0, balance:0, business:0 };
        var entries = state.entries || [];
        for (var i=0; i<entries.length; i++) {
          var e = entries[i];
          var key = e.domain + ':' + e.task;
          dayHabits[key] = true;
          domainPoints[e.domain] = (domainPoints[e.domain]||0) + (e.points||0.5);
        }

        // Update buttons
        var domains = ['body','being','balance','business'];
        var habits = {
          body: ['fitness','fuel'],
          being: ['meditation','memoirs'],
          balance: ['person1','person2'],
          business: ['discover','declare']
        };
        for (var d=0; d<domains.length; d++) {
          var dom = domains[d];
          var sc = document.getElementById('sc-'+dom);
          if (sc) sc.textContent = (domainPoints[dom]||0).toFixed(1) + '/1';
          var hs = habits[dom];
          for (var h=0; h<hs.length; h++) {
            var btn = document.getElementById('hb-'+dom+'-'+hs[h]);
            if (btn) {
              if (dayHabits[dom+':'+hs[h]]) btn.classList.add('done');
              else btn.classList.remove('done');
            }
          }
        }
      }

      /* ---- Heatmap ---- */
      function renderHeatmap() {
        var html = '';
        for (var i=0; i<weekDates.length; i++) {
          var dk = weekDates[i];
          var pts = weekTotals[dk] || 0;
          var q = pts === 0 ? 0 : pts <= 1 ? 1 : pts <= 2 ? 2 : pts <= 3 ? 3 : 4;
          html += '<div class="heat-day">';
          html += '<div class="heat-label">'+DAY_NAMES[i]+'</div>';
          html += '<div class="heat-bar"><div class="heat-fill q'+q+'"></div></div>';
          html += '</div>';
        }
        document.getElementById('heatmap').innerHTML = html;
      }

      /* ---- Toggle habit ---- */
      function toggle(domain, task) {
        if (!selectedDate) return showToast('Select a day');
        if (!isGAS()) return showToast('Not in GAS');
        var key = domain+':'+task;
        if (dayHabits[key]) return showToast('Already logged');
        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || !res.ok) return showToast(res && res.error || 'Failed');
            showToast('Logged');
            loadDay(selectedDate);
            loadWeekData();
          })
          .withFailureHandler(function(e){ showToast('Error'); })
          .core4_logForDate(domain, task, selectedDate);
      }

      /* ---- Journal ---- */
      function loadJournal(dateKey) {
        if (!isGAS()) return;
        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || !res.ok) { document.getElementById('journalEntries').innerHTML = ''; return; }
            renderJournalEntries(res.entries || []);
          })
          .withFailureHandler(function(){})
          .core4_getJournalForDate(dateKey);
      }

      function renderJournalEntries(entries) {
        var el = document.getElementById('journalEntries');
        if (!entries.length) { el.innerHTML = '<div style="font-size:11px;color:var(--muted);padding:4px 0;">No journal entries for this day.</div>'; return; }
        var html = '';
        for (var i=0; i<entries.length; i++) {
          var e = entries[i];
          // Show first ~120 chars of text
          var preview = (e.text||'').replace(/^##[^\n]*\n+/g,'').replace(/\n---\n?$/g,'').trim();
          if (preview.length > 120) preview = preview.substring(0,120) + '...';
          html += '<div class="journal-entry"><span class="je-label">'+e.label+':</span> '+preview+'</div>';
        }
        el.innerHTML = html;
      }

      function saveJournal() {
        var text = document.getElementById('journalText').value.trim();
        if (!text) return showToast('Write something first');
        if (!selectedDate) return showToast('Select a day');
        if (!isGAS()) return showToast('Not in GAS');
        var sel = document.getElementById('journalHabit').value.split(':');
        var domain = sel[0], habit = sel[1];
        var btn = document.getElementById('btnSaveJournal');
        btn.disabled = true;
        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false;
            if (!res || !res.ok) return showToast(res && res.error || 'Failed');
            showToast('Journal saved');
            document.getElementById('journalText').value = '';
            loadJournal(selectedDate);
          })
          .withFailureHandler(function(e){ btn.disabled = false; showToast('Error'); })
          .core4_saveJournalWeb(domain, habit, text, selectedDate);
      }

      /* ---- Actions ---- */
      function showWeekSummary() {
        if (!selectedDate || !isGAS()) return;
        google.script.run
          .withSuccessHandler(function(res) {
            if (!res || !res.ok) return showToast('Failed');
            var t = res.totals || {};
            showToast('Week: ' + (t.week_total||0) + '/28');
          })
          .withFailureHandler(function(){ showToast('Error'); })
          .core4_getWeekSummaryForDate(selectedDate);
      }

      function exportWeek() {
        if (!selectedDate || !isGAS()) return;
        google.script.run
          .withSuccessHandler(function(res) {
            showToast(res && res.ok ? 'Exported to Drive' : 'Failed');
          })
          .withFailureHandler(function(){ showToast('Error'); })
          .core4_exportWeekSummaryForDate(selectedDate);
      }

      /* ---- Init ---- */
      initWeek();
    </script>
  </body>
</html>
