
<script>
let currentMonth = 'current';
let currentDomain = 'BODY';
let autoSaveTimer = null;
let focusStates = {}; // Store all domain states

function updateActiveStates() {
  // Month-Cards (rechte Säule)
  document.querySelectorAll('.month-card').forEach(c =>
    c.classList.toggle('active', c.dataset.month === currentMonth));

  // Domain-Tabs im Header
  document.querySelectorAll('nav .domain-tab').forEach(b =>
    b.classList.toggle('active', b.dataset.domain === currentDomain));
}

function updateMissionTitle() {
  const label = currentMonth === 'current' ? 'CURRENT MONTH' : currentMonth.toUpperCase() + ' MISSION';
  const titleEl = document.getElementById('missionTitle');
  if (titleEl) titleEl.textContent = `${currentDomain} – ${label}`;
}

function selectMonth(month) {
  if (currentMonth === month) return;
  saveCurrentDomainState(); // Save before switching
  currentMonth = month;
  updateActiveStates();
  updateMissionTitle();
  loadCurrentDomainState(); // Load new month state
}

function selectDomain(domain) {
  if (currentDomain === domain) return;
  saveCurrentDomainState(); // Save before switching
  currentDomain = domain;
  updateActiveStates();
  updateMissionTitle();
  loadCurrentDomainState(); // Load new domain state
}

// Auto-save current domain state
function saveCurrentDomainState() {
  const state = {
    domain: currentDomain,
    month: currentMonth,
    habits: document.getElementById('habitsText')?.value || '',
    routines: document.getElementById('routinesText')?.value || '',
    additions: document.getElementById('additionsText')?.value || '',
    eliminations: document.getElementById('eliminationsText')?.value || ''
  };

  // Store locally
  focusStates[currentDomain] = state;

  // Debounced save to server
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    google.script.run
      .withSuccessHandler(() => console.log('Auto-saved', currentDomain))
      .withFailureHandler(err => console.error('Auto-save failed:', err))
      .saveFocusState(state.domain, state.month, state.habits, state.routines, state.additions, state.eliminations);
  }, 2000); // Save 2 seconds after last change (GAS is slower)
}

// Load current domain state
function loadCurrentDomainState() {
  const state = focusStates[currentDomain];
  if (state) {
    document.getElementById('habitsText').value = state.habits || '';
    document.getElementById('routinesText').value = state.routines || '';
    document.getElementById('additionsText').value = state.additions || '';
    document.getElementById('eliminationsText').value = state.eliminations || '';
  } else {
    // Clear fields if no state
    document.getElementById('habitsText').value = '';
    document.getElementById('routinesText').value = '';
    document.getElementById('additionsText').value = '';
    document.getElementById('eliminationsText').value = '';
  }
}

// Load all states from server on init
function loadAllStates() {
  google.script.run
    .withSuccessHandler(data => {
      if (data.ok && data.states) {
        focusStates = data.states;
        loadCurrentDomainState(); // Load current domain
      }
    })
    .withFailureHandler(err => console.error('Failed to load states:', err))
    .getFocusState();
}

function saveMission() {
  const h = document.getElementById('habitsText')?.value.trim() || '';
  const r = document.getElementById('routinesText')?.value.trim() || '';
  const a = document.getElementById('additionsText')?.value.trim() || '';
  const e = document.getElementById('eliminationsText')?.value.trim() || '';

  if (!h || !r || !a || !e) {
    alert('ALLE VIER PFEILER MÜSSEN GEFÜLLT SEIN – KEINE SCHWÄCHE.');
    return;
  }

  const monthName = currentMonth === 'current'
    ? new Date().toLocaleString('default', { month: 'long', year: 'numeric' })
    : currentMonth.toUpperCase();

  google.script.run
    .withSuccessHandler(res => {
      if (res.ok) {
        alert(`${currentDomain} ${monthName} → LOCKED\n${res.file.url}`);
        document.querySelectorAll('textarea').forEach(t => t.value = '');
        loadSavedMaps(); // Reload saved maps after saving
      }
    })
    .saveFocusEntry(currentDomain, {habits: h, routines: r, additions: a, eliminations: e}, monthName, currentMonth);
}

function loadSavedMaps() {
  const statusEl = document.getElementById('loadStatus');
  const gridEl = document.getElementById('savedMapsGrid');

  if (!statusEl || !gridEl) return;

  statusEl.textContent = 'Loading saved maps...';
  gridEl.innerHTML = '';

  google.script.run
    .withSuccessHandler(data => {
      if (!data.ok || !data.maps || data.maps.length === 0) {
        statusEl.textContent = `No saved maps found for ${currentDomain} / ${currentMonth}.`;
        gridEl.innerHTML = '';
        return;
      }

      statusEl.textContent = '';
      gridEl.innerHTML = data.maps.map(map => `
        <div class="saved-map-card" data-filename="${map.filename}" data-fileid="${map.fileId}">
          <h4>${map.domain} – ${map.phase}</h4>
          <p>Saved: ${new Date(map.modified).toLocaleDateString('de-DE')}</p>
          <p>${map.filename}</p>
        </div>
      `).join('');

      // Add click handlers
      document.querySelectorAll('.saved-map-card').forEach(card => {
        card.addEventListener('click', () => loadMapContent(card.dataset.fileid, card.dataset.filename));
      });
    })
    .withFailureHandler(err => {
      statusEl.textContent = 'Error loading maps: ' + err.message;
      gridEl.innerHTML = '';
    })
    .listFocusEntries(currentDomain, currentMonth);
}

function loadMapContent(fileId, filename) {
  if (!fileId) {
    alert('No file ID provided');
    return;
  }

  google.script.run
    .withSuccessHandler(data => {
      if (!data.ok || !data.content) {
        alert('Failed to load map: ' + (data.error || 'unknown error'));
        return;
      }

      // Parse markdown and extract fields
      const content = data.content;

      // Try new format (## HABITS) first
      let habitsMatch = content.match(/##\s*HABITS\s*\n([^#]+)/i);
      let routinesMatch = content.match(/##\s*ROUTINES\s*\n([^#]+)/i);
      let additionsMatch = content.match(/##\s*ADDITIONS\s*\n([^#]+)/i);
      let eliminationsMatch = content.match(/##\s*ELIMINATIONS\s*\n([^#]+)/i);

      // Fallback to old format (### HABITS) for backwards compatibility
      if (!habitsMatch) habitsMatch = content.match(/###\s*HABITS\s*\n([^#]+)/i);
      if (!routinesMatch) routinesMatch = content.match(/###\s*ROUTINES\s*\n([^#]+)/i);
      if (!additionsMatch) additionsMatch = content.match(/###\s*ADDITIONS\s*\n([^#]+)/i);
      if (!eliminationsMatch) eliminationsMatch = content.match(/###\s*ELIMINATIONS\s*\n([^#]+)/i);

      if (habitsMatch) document.getElementById('habitsText').value = habitsMatch[1].trim();
      if (routinesMatch) document.getElementById('routinesText').value = routinesMatch[1].trim();
      if (additionsMatch) document.getElementById('additionsText').value = additionsMatch[1].trim();
      if (eliminationsMatch) document.getElementById('eliminationsText').value = eliminationsMatch[1].trim();

      alert(`Focus Map loaded: ${filename}`);
    })
    .withFailureHandler(err => {
      alert('Error loading map content: ' + err.message);
    })
    .loadFocusEntry(fileId);
}

// HOTKEYS – UNVERWÜSTBAR
function onFocusKeydown(e) {
  if (window.AOS_ACTIVE_MAP !== 'focus') return;
  if (e.target.tagName === 'TEXTAREA') return;

  // Zeitphasen
  if (e.key === '^') selectMonth('current');
  if (e.key === '1') selectMonth('q1');
  if (e.key === '2') selectMonth('q2');
  if (e.key === '3') selectMonth('q3');
  if (e.key === '4') selectMonth('q4');

  // Domains
  const map = {
    q:'BODY', w:'BEING', e:'BALANCE', r:'BUSINESS',
    t:'BODY', z:'BEING', u:'BALANCE', i:'BUSINESS',
    a:'BODY', s:'BEING', d:'BALANCE', f:'BUSINESS',
    g:'BODY', h:'BEING', j:'BALANCE', k:'BUSINESS'
  };
  const domain = map[e.key.toLowerCase()];
  if (domain) selectDomain(domain);

  // ENTER = LOCK
  if (e.key === 'Enter') {
    e.preventDefault();
    const lockBtn = document.getElementById('lockBtn');
    if (lockBtn) lockBtn.click();
  }
}

// INIT – ROBUST & SICHER
function initFocusCentre() {
  // Month-Cards rechts
  document.querySelectorAll('.month-card').forEach(card => {
    card.addEventListener('click', () => {
      selectMonth(card.dataset.month);
      loadSavedMaps(); // Reload maps when month changes
    });
  });

  // Domain-Tabs im Header
  document.querySelectorAll('nav .domain-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      selectDomain(tab.dataset.domain);
      loadSavedMaps(); // Reload maps when domain changes
    });
  });

  // Lock-Button
  const lockBtn = document.getElementById('lockBtn');
  if (lockBtn) lockBtn.addEventListener('click', saveMission);

  // Auto-save on textarea changes
  document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', () => saveCurrentDomainState());
  });

  // Initialer Zustand
  updateActiveStates();
  updateMissionTitle();
  loadAllStates(); // Load all states from server
  loadSavedMaps(); // Load saved maps on init

  if (!window.__AOS_FOCUS_KEYDOWN_BOUND) {
    document.addEventListener('keydown', onFocusKeydown);
    window.__AOS_FOCUS_KEYDOWN_BOUND = true;
  }
}

if (document.readyState === 'loading') {
  window.addEventListener('DOMContentLoaded', initFocusCentre);
} else {
  initFocusCentre();
}
</script>
