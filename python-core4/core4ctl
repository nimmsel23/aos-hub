#!/usr/bin/env bash
set -euo pipefail

# core4ctl â€” thin dispatcher
# Keep this file small; real logic lives in:
#   - core4-trackctl  (tracker + taskwarrior wrappers)
#   - core4-syncctl   (rclone/vault sync)
#   - core4-servicectl (systemd mount/timers)
#   - core4-clinctl   (install/doctor)
#   - core4-menuctl   (interactive menu)

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"

trackctl() { exec "$APP_DIR/core4-trackctl" "$@"; }
syncctl() { exec "$APP_DIR/core4-syncctl" "$@"; }
servicectl() { exec "$APP_DIR/core4-servicectl" "$@"; }
clinctl() { exec "$APP_DIR/core4-clinctl" "$@"; }
menuctl() { exec "$APP_DIR/core4-menuctl" "$@"; }

usage() {
  cat <<EOF
Usage: core4ctl <command>

Core:
  core4ctl menu
  core4ctl doctor
  core4ctl install-cli [TARGET]

Tracker:
  core4ctl status
  core4ctl sources
  core4ctl build
  core4ctl seed-week [args...]
  core4ctl export-daily [args...]
  core4ctl prune-events [args...]
  core4ctl finalize-month [args...]
  core4ctl finalize-week [args...]

Habits:
  core4ctl edit-habit [habit-name]   # Edit per-habit config

Taskwarrior:
  core4ctl list|today|week|done [task-args...]

Sync:
  core4ctl sync        # vaultctl sync (whole vault)
  core4ctl pull-core4  # pull .core4/** from Drive + rebuild
  core4ctl sync-core4  # push .core4/** to Drive

Systemd:
  core4ctl mount-status|mount-enable|mount-disable|mount-restart|mount-logs
  core4ctl install-timers
EOF
}

cmd="${1:-}"
if [[ -z "${cmd:-}" ]]; then
  if [[ -t 0 && -t 1 ]]; then
    cmd="menu"
  else
    cmd="help"
  fi
else
  shift || true
fi

case "$cmd" in
  -h|--help|help) usage ;;
  help) usage ;;
  menu) menuctl menu ;;

  doctor) clinctl doctor ;;
  install-cli) clinctl install-cli "${1:-}" ;;

  status|sources|build|seed-week|export-daily|prune|prune-events|finalize-month|seal-month|month-close|finalize-week|seal-week|edit-habit|edit|list|ls|today|week|done|completed)
    trackctl "$cmd" "$@"
    ;;

  sync|sync-core4|push|push-core4|pull|pull-core4)
    syncctl "$cmd" "$@"
    ;;

  mount-status|mount-enable|mount-disable|mount-restart|mount-logs|install-timers)
    servicectl "$cmd" "$@"
    ;;

  *)
    usage
    exit 1
    ;;
esac
