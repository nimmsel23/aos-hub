<script>
const USER_KEY = "<?= userKey ?>";

function doorGetUserKey_() {
  try {
    if (USER_KEY && String(USER_KEY).trim()) return String(USER_KEY).trim();
  } catch (_) {}
  try {
    return String(localStorage.getItem('aos_door_user_key') || '').trim();
  } catch (_) {
    return '';
  }
}

function doorRedirectToKey_(key) {
  const k = String(key || '').trim();
  if (!k) return false;
  try { localStorage.setItem('aos_door_user_key', k); } catch (_) {}
  try {
    const url = new URL(window.location.href);
    url.searchParams.set('k', k);
    window.location.replace(url.toString());
    return true;
  } catch (_) {
    return false;
  }
}

function doorEnsureUserKey_(onReady) {
  const current = doorGetUserKey_();
  if (current && String(USER_KEY || '').trim()) {
    try { localStorage.setItem('aos_door_user_key', current); } catch (_) {}
    if (typeof onReady === 'function') onReady();
    return;
  }
  if (current && !String(USER_KEY || '').trim()) {
    if (doorRedirectToKey_(current)) return;
  }

  if (!(window.google && google.script && google.script.run)) {
    if (typeof onReady === 'function') onReady();
    return;
  }

  google.script.run
    .withSuccessHandler((res) => {
      const key = res && res.userKey ? String(res.userKey || '').trim() : '';
      if (!key) {
        if (typeof onReady === 'function') onReady();
        return;
      }
      doorRedirectToKey_(key);
    })
    .withFailureHandler(() => {
      if (typeof onReady === 'function') onReady();
    })
    .door_registerAnonUser();
}

// Globaler Cache fÃ¼r Hot-Ideen aus 1-Potential
let DOOR_HOT_CACHE = [];
let DOOR_HIT_CACHE = [];

function isDoorActive() {
  return window.AOS_ACTIVE_MAP === 'door';
}

// ------------- 1) Door Chapters Markdown -------------
// Kapitel-Rendering passiert direkt im Door_Index.

// ------------- 3) Session-ID & Drive-Sync -------------
function getDoorSessionId() {
  try {
    if (window.localStorage) {
      let id = localStorage.getItem('door_session_id');
      if (!id) {
        id = 'door-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        localStorage.setItem('door_session_id', id);
      }
      return id;
    }
  } catch (e) {}
  return 'door-' + Date.now();
}

function setDoorStatus(msg) {
  const el = document.getElementById('door-status');
  if (!el) return;
  el.textContent = msg || '';
}

function syncDoorToDrive(tool, markdown, meta) {
  if (!markdown || !markdown.trim) return;

  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    console.log('[DoorCentre] Offline â€“ kein Drive Sync', { tool });
    setDoorStatus('Offline â€“ lokal generiert, kein Drive-Sync.');
    return;
  }

  const payload = {
    sessionId: getDoorSessionId(),
    tool: tool,
    meta: meta || '',
    markdown: markdown,
    userKey: doorGetUserKey_()
  };

  setDoorStatus('Speichere ' + tool + ' â€¦');

  google.script.run
    .withSuccessHandler((res) => {
      setDoorStatus(tool + ' gespeichert.');
      if (String(tool || '').toLowerCase() === 'warstack') {
        if (res && res.telegram && res.telegram.ok) {
          logDoorTerminal_('Telegram: War Stack gesendet');
        } else if (res && res.telegram && res.telegram.skipped) {
          logDoorTerminal_('Telegram: War Stack skip (WARSTACK_TELEGRAM=0)');
        } else if (res && res.telegram && res.telegram.error) {
          logDoorTerminal_('Telegram: Fehler ' + res.telegram.error);
        }
        try {
          if (window.localStorage) {
            localStorage.removeItem('door_warstack_draft');
          }
        } catch (_) {}
        google.script.run
          .withFailureHandler(() => {})
          .door_clearWarStackDraft_(getDoorSessionId(), payload.userKey);
      }
    })
    .withFailureHandler(err => {
      console.error('Drive-Fehler', err);
      setDoorStatus('Fehler beim Speichern: ' + err.message);
    })
    .saveDoorEntry(payload, payload.userKey);
}

function logDoorTerminal_(message) {
  const msg = String(message || '').trim();
  if (!msg) return;
  if (typeof addToTerminal === 'function') {
    addToTerminal('door:warstack', msg);
    return;
  }
  if (typeof window.aosTerminalLog === 'function') {
    window.aosTerminalLog('door:warstack', msg);
  }
}

// ------------- 4) Keyboard-Shortcuts: 1â€“6 â†’ Tabs -------------
if (!window.__AOS_DOOR_KEYDOWN_BOUND) {
  document.addEventListener('keydown', (e) => {
    if (!isDoorActive()) return;
    if (e.altKey || e.metaKey || e.ctrlKey) return;
    if (typeof openTab !== 'function') return;
    switch (e.key) {
      case '1': return openTab('hotlist');
      case '2': return openTab('doorwar');
      case '3': return openTab('warstack');
      case '4': return openTab('hitlist');
      case '5': return openTab('profit');
      case '6': return openTab('chapters');
    }
  });
  window.__AOS_DOOR_KEYDOWN_BOUND = true;
}
// Beim Start einmal versuchen, Hot-Ideen automatisch zu laden
(function initDoorCentre() {
  doorEnsureUserKey_(() => {
    // Seed from HQ Home (Door War â†’ War Stack)
    try {
      if (window.localStorage) {
        const raw = localStorage.getItem('aos_hq_doorwar_seed');
        if (raw) {
          window.__AOS_HQ_DOORWAR_SEED = JSON.parse(raw);
        }
      }
    } catch (_) {}

    loadHotList(true);

    // sicherstellen, dass Matrix existiert wenn der Tab geÃ¶ffnet wird
    if (document.getElementById('panel-doorwar')) {
      if (DOOR_HOT_CACHE.length) {
        renderDoorWarFromIdeas(DOOR_HOT_CACHE);
      }
    }

    bindWarStackDraftAutosave_();
    loadWarStackDraft_();
    initWarStackRooms_();
  });
})();

function doorConsumeHqDoorWarSeed_() {
  let seed = null;
  try {
    seed = window.__AOS_HQ_DOORWAR_SEED || null;
  } catch (_) {}
  if (!seed) return;

  try {
    if (window.localStorage) localStorage.removeItem('aos_hq_doorwar_seed');
  } catch (_) {}
  window.__AOS_HQ_DOORWAR_SEED = null;

  const door = String(seed.door || '').trim();
  const fileId = String(seed.fileId || '').trim();
  if (!door && !fileId) return;

  // Try to select matching card
  if (fileId) {
    const cards = Array.from(document.querySelectorAll('.doorwar-card'));
    const card = cards.find(c => c && c.dataset && c.dataset.fileId === fileId);
    if (card) {
      selectDoorWarCard(card);
    }
  }

  // Fallback: set door choice directly
  const choice = document.getElementById('doorwarchoice');
  if (choice && door && !choice.value.trim()) choice.value = door;

  if (String(seed.action || '').toLowerCase() === 'warstack') {
    try {
      doorWarToWarStack();
    } catch (_) {}
  }
}


// ------------- 5) Hot List -------------
function saveHotList() {
  const input = document.getElementById('hotlistinput').value.trim();
  const out   = document.getElementById('hotlistoutput');

  if (!input) {
    out.textContent = 'Keine EintrÃ¤ge. Sammle zuerst deine Ideen.';
    return;
  }

  const lines = input
    .split('\n')
    .map(l => l.trim())
    .filter(l => l.length > 0);

  if (!lines.length) {
    out.textContent = 'Keine Ideen gefunden.';
    return;
  }

  // Each line = separate Door file (not aggregated list)
  setDoorStatus(`Speichere ${lines.length} Ideas...`);
  let savedCount = 0;

  const user = getWebUser();
  const userKey = doorGetUserKey_();

  lines.forEach((idea, idx) => {
    try {
      google.script.run
        .withSuccessHandler(() => {
          savedCount++;
          if (savedCount === lines.length) {
            setDoorStatus(`âœ“ ${lines.length} Ideas als separate Files gespeichert.`);
            out.textContent = `Gespeichert:\n${lines.map((l, i) => `${i + 1}. ${l}`).join('\n')}`;
            document.getElementById('hotlistinput').value = '';
            loadHotList(true); // Reload to show new files
          }
        })
        .withFailureHandler((err) => {
          setDoorStatus(`Fehler bei Idee ${idx + 1}: ${err.message || err}`);
        })
        .hotlist_addWeb(idea, user, userKey);
    } catch (e) {
      console.error('Save Hot List error:', e);
    }
  });
}

// ------------- 6) Door War -------------
function doorWarToWarStack() {
  const choice = document.getElementById('doorwarchoice').value.trim();
  if (!choice) {
    alert('WÃ¤hle zuerst eine Domino Door aus (Feld unter dem Door War Output).');
    return;
  }

  const wtitle = document.getElementById('wtitle');
  const wdoor  = document.getElementById('wdoor');

  if (wtitle && !wtitle.value.trim()) {
    wtitle.value = choice;
  }
  if (wdoor && !wdoor.value.trim()) {
    wdoor.value = choice;
  }

  openTab('warstack');
}

function selectDoorWarCard(card) {
  if (!card) return;
  const choice = document.getElementById('doorwarchoice');
  const fileId = document.getElementById('doorwarfileid');
  const quadEl = document.getElementById('doorwarquad');
  const title = card.dataset.title || card.textContent || '';
  if (choice) choice.value = title.trim();
  if (fileId) fileId.value = (card.dataset.fileId || '').trim();
  if (quadEl) quadEl.value = doorWarGetCardQuad_(card) || '';

  document.querySelectorAll('.doorwar-card.selected').forEach(el => {
    el.classList.remove('selected');
  });
  card.classList.add('selected');
}

function doorWarGetCardQuad_(card) {
  if (!card) return '';
  const zone = card.closest('.doorwar-dropzone');
  if (!zone) return '';
  return (zone.dataset && zone.dataset.quad) ? zone.dataset.quad : '';
}

function getDoorWarSelectedCard_() {
  const selected = document.querySelector('.doorwar-card.selected');
  if (selected) return selected;
  const q2 = document.querySelector('.doorwar-dropzone[data-quad="q2"] .doorwar-card');
  return q2 || null;
}

function generateDoorWarFromMatrix() {
  const backlog = getDoorWarTitles_('backlog');
  const q1 = getDoorWarTitles_('q1');
  const q2 = getDoorWarTitles_('q2');
  const q3 = getDoorWarTitles_('q3');
  const q4 = getDoorWarTitles_('q4');

  const choice = document.getElementById('doorwarchoice');
  const fileIdEl = document.getElementById('doorwarfileid');
  const quadEl = document.getElementById('doorwarquad');
  let door = choice ? choice.value.trim() : '';
  let fileId = fileIdEl ? fileIdEl.value.trim() : '';
  let quad = quadEl ? quadEl.value.trim() : '';
  if (!door && q2.length) {
    door = q2[0];
    if (choice) choice.value = door;
    if (!fileIdEl || !fileId) {
      const card = getDoorWarSelectedCard_();
      if (card && card.dataset) {
        fileId = card.dataset.fileId || '';
        if (fileIdEl) fileIdEl.value = fileId;
      }
    }
    if (!quadEl || !quad) {
      const card = getDoorWarSelectedCard_();
      quad = doorWarGetCardQuad_(card) || 'q2';
      if (quadEl) quadEl.value = quad;
    }
  }

  const lines = [];
  lines.push('# Door War â€“ Eisenhower Matrix');
  lines.push('');
  lines.push('## Backlog');
  lines.push(backlog.length ? backlog.map(i => `- ${i}`).join('\n') : '- (leer)');
  lines.push('');
  lines.push('## Q1 â€“ Urgent & Important');
  lines.push(q1.length ? q1.map(i => `- ${i}`).join('\n') : '- (leer)');
  lines.push('');
  lines.push('## Q2 â€“ Not Urgent & Important');
  lines.push(q2.length ? q2.map(i => `- ${i}`).join('\n') : '- (leer)');
  lines.push('');
  lines.push('## Q3 â€“ Urgent & Not Important');
  lines.push(q3.length ? q3.map(i => `- ${i}`).join('\n') : '- (leer)');
  lines.push('');
  lines.push('## Q4 â€“ Not Urgent & Not Important');
  lines.push(q4.length ? q4.map(i => `- ${i}`).join('\n') : '- (leer)');
  lines.push('');
  lines.push('---');
  lines.push('');
  lines.push('## Domino Door');
  lines.push('');
  lines.push(`**Door:** ${door || '_'}`);
  lines.push('');

  const md = lines.join('\n');
  const out = document.getElementById('doorwaroutput');
  if (out) out.textContent = md;

  const meta = `q1:${q1.length};q2:${q2.length};q3:${q3.length};q4:${q4.length};door:${door || ''};hotlist_file_id:${fileId || ''};quad:${quad || ''}`;
  syncDoorToDrive('DoorWar', md, meta);
}

function getDoorWarTitles_(quad) {
  const zone = document.querySelector(`.doorwar-dropzone[data-quad="${quad}"]`);
  if (!zone) return [];
  return Array.from(zone.querySelectorAll('.doorwar-card'))
    .map(card => (card.dataset.title || card.textContent || '').trim())
    .filter(Boolean);
}

function renderDoorWarFromIdeas(ideas) {
  const backlog = document.querySelector('.doorwar-dropzone[data-quad="backlog"]');
  if (!backlog) return;
  backlog.innerHTML = '';

  if (!ideas || !ideas.length) {
    backlog.innerHTML = '<em>Keine Hot-Ideen gefunden.</em>';
    return;
  }

  ideas.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'doorwar-card';
    card.id = `doorwar-card-${idx}`;
    card.dataset.fileId = item.id || '';
    card.dataset.title = item.title || item.name || '';
    card.textContent = item.title || item.name || '';
    card.addEventListener('click', () => selectDoorWarCard(card));
    backlog.appendChild(card);
  });

  initDoorWarDragDrop();
  doorConsumeHqDoorWarSeed_();
}

// ------------- 7) War Stack -------------
let WARSTACK_DRAFT_TIMER = null;

function collectWarStackDraft_() {
  const getVal = (id) => {
    const el = document.getElementById(id);
    return el ? String(el.value || '').trim() : '';
  };

  const hits = [1, 2, 3, 4].map((n) => ({
    fact: getVal(`h${n}f`),
    obstacle: getVal(`h${n}o`),
    strike: getVal(`h${n}s`),
    responsibility: getVal(`h${n}r`)
  }));

  return {
    title: getVal('wtitle'),
    domain: getVal('wdomain'),
    subdomain: getVal('wsub'),
    door: getVal('wdoor'),
    trigger: getVal('wtrigger'),
    narrative: getVal('wnarr'),
    validation: getVal('wval'),
    impact: getVal('wimpact'),
    consequences: getVal('wcons'),
    insights: getVal('wins'),
    lessons: getVal('wless'),
    hits: hits
  };
}

function draftHasContent_(draft) {
  if (!draft) return false;
  if (draft.title || draft.domain || draft.subdomain || draft.door || draft.trigger) return true;
  if (draft.narrative || draft.validation || draft.impact || draft.consequences) return true;
  if (draft.insights || draft.lessons) return true;
  return (draft.hits || []).some(h => h && (h.fact || h.obstacle || h.strike || h.responsibility));
}

function applyWarStackDraft_(draft) {
  if (!draft) return;
  const setVal = (id, value) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.value && String(el.value).trim()) return;
    el.value = value || '';
  };

  setVal('wtitle', draft.title);
  setVal('wdomain', draft.domain);
  setVal('wsub', draft.subdomain);
  setVal('wdoor', draft.door);
  setVal('wtrigger', draft.trigger);
  setVal('wnarr', draft.narrative);
  setVal('wval', draft.validation);
  setVal('wimpact', draft.impact);
  setVal('wcons', draft.consequences);
  setVal('wins', draft.insights);
  setVal('wless', draft.lessons);

  (draft.hits || []).forEach((hit, idx) => {
    const n = idx + 1;
    if (!hit) return;
    setVal(`h${n}f`, hit.fact);
    setVal(`h${n}o`, hit.obstacle);
    setVal(`h${n}s`, hit.strike);
    setVal(`h${n}r`, hit.responsibility);
  });
}

function saveWarStackDraft_(reason) {
  const draft = collectWarStackDraft_();
  if (!draftHasContent_(draft)) return;

  try {
    if (window.localStorage) {
      localStorage.setItem('door_warstack_draft', JSON.stringify({
        session_id: getDoorSessionId(),
        updated_at: new Date().toISOString(),
        draft: draft
      }));
    }
  } catch (_) {}

  if (typeof google === 'undefined' || !google.script || !google.script.run) return;

  const payload = {
    sessionId: getDoorSessionId(),
    draft: draft,
    reason: reason || 'auto',
    userKey: doorGetUserKey_()
  };

  google.script.run
    .withSuccessHandler(() => {
      setDoorStatus('War Stack Draft gespeichert.');
      logDoorTerminal_('Draft: gespeichert');
    })
    .withFailureHandler(() => {
      setDoorStatus('Draft Save fehlgeschlagen.');
      logDoorTerminal_('Draft: Fehler beim Speichern');
    })
    .door_saveWarStackDraft_(payload, payload.userKey);
}

function scheduleWarStackDraftSave(reason) {
  if (WARSTACK_DRAFT_TIMER) clearTimeout(WARSTACK_DRAFT_TIMER);
  WARSTACK_DRAFT_TIMER = setTimeout(() => saveWarStackDraft_(reason), 900);
}

function loadWarStackDraft_() {
  const sessionId = getDoorSessionId();
  let localDraft = null;

  try {
    if (window.localStorage) {
      const raw = localStorage.getItem('door_warstack_draft');
      if (raw) {
        const data = JSON.parse(raw);
        if (data && data.draft) {
          localDraft = data.draft;
        }
      }
    }
  } catch (_) {}

  if (localDraft) applyWarStackDraft_(localDraft);

  if (typeof google === 'undefined' || !google.script || !google.script.run) return;
  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok && res.draft) {
        applyWarStackDraft_(res.draft);
      }
    })
    .withFailureHandler(() => {})
    .door_loadWarStackDraft_(sessionId, doorGetUserKey_());
}

function bindWarStackDraftAutosave_() {
  const form = document.getElementById('warform');
  if (!form) return;
  const fields = form.querySelectorAll('input, textarea, select');
  fields.forEach((el) => {
    el.addEventListener('input', () => scheduleWarStackDraftSave('input'));
    el.addEventListener('change', () => scheduleWarStackDraftSave('change'));
    el.addEventListener('blur', () => saveWarStackDraft_('blur'));
  });
}

const WARSTACK_STEP_LABELS = {
  1: 'Door',
  2: 'Trigger & Narrative',
  3: 'Hits',
  4: 'Insights & Lessons',
  5: 'Commit'
};
let WARSTACK_STEP = 1;

function warstack_showStep_(step) {
  const rooms = document.querySelectorAll('#panel-warstack .war-room');
  rooms.forEach((room) => {
    const s = parseInt(room.getAttribute('data-step'), 10);
    room.classList.toggle('is-active', s === step);
  });
  const indicator = document.getElementById('warstack-step-indicator');
  if (indicator) {
    indicator.textContent = `Room ${step}/5: ${WARSTACK_STEP_LABELS[step] || ''}`;
  }
  const prev = document.getElementById('war-prev');
  const next = document.getElementById('war-next');
  const submit = document.getElementById('war-submit');
  if (prev) prev.style.display = step > 1 ? 'inline-block' : 'none';
  if (next) next.style.display = step < 5 ? 'inline-block' : 'none';
  if (submit) submit.style.display = step === 5 ? 'inline-block' : 'none';
}

function warstack_focusFirstMissing_(ids) {
  for (let i = 0; i < ids.length; i += 1) {
    const el = document.getElementById(ids[i]);
    if (el && !String(el.value || '').trim()) {
      el.focus();
      return;
    }
  }
}

function warstack_validateStep_(step) {
  const missing = [];
  if (step === 1) {
    ['wtitle', 'wdomain', 'wdoor'].forEach(id => {
      const el = document.getElementById(id);
      if (!el || !String(el.value || '').trim()) missing.push(id);
    });
  } else if (step === 2) {
    ['wtrigger', 'wnarr', 'wval', 'wimpact', 'wcons'].forEach(id => {
      const el = document.getElementById(id);
      if (!el || !String(el.value || '').trim()) missing.push(id);
    });
  } else if (step === 3) {
    for (let n = 1; n <= 4; n += 1) {
      ['f', 'o', 's', 'r'].forEach(key => {
        const id = `h${n}${key}`;
        const el = document.getElementById(id);
        if (!el || !String(el.value || '').trim()) missing.push(id);
      });
    }
  } else if (step === 4) {
    ['wins', 'wless'].forEach(id => {
      const el = document.getElementById(id);
      if (!el || !String(el.value || '').trim()) missing.push(id);
    });
  }
  if (missing.length) {
    setDoorStatus('Bitte alle Felder in diesem Raum ausfÃ¼llen.');
    warstack_focusFirstMissing_(missing);
    return false;
  }
  return true;
}

function warstack_validateAll_() {
  for (let s = 1; s <= 4; s += 1) {
    if (!warstack_validateStep_(s)) return false;
  }
  return true;
}

function initWarStackRooms_() {
  const panel = document.getElementById('panel-warstack');
  if (!panel) return;
  const prev = document.getElementById('war-prev');
  const next = document.getElementById('war-next');
  if (prev) {
    prev.addEventListener('click', () => {
      if (WARSTACK_STEP > 1) {
        WARSTACK_STEP -= 1;
        warstack_showStep_(WARSTACK_STEP);
        saveWarStackDraft_('step');
      }
    });
  }
  if (next) {
    next.addEventListener('click', () => {
      if (!warstack_validateStep_(WARSTACK_STEP)) return;
      if (WARSTACK_STEP < 5) {
        WARSTACK_STEP += 1;
        warstack_showStep_(WARSTACK_STEP);
        saveWarStackDraft_('step');
      }
    });
  }
  warstack_showStep_(WARSTACK_STEP);
}

const doorWarForm = document.getElementById('warform');
if (doorWarForm) {
  doorWarForm.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!warstack_validateAll_()) return;

    const title   = document.getElementById('wtitle').value.trim();
    const domain  = document.getElementById('wdomain').value.trim();
    const sub     = document.getElementById('wsub').value.trim();
    const door    = document.getElementById('wdoor').value.trim();
    const trigger = document.getElementById('wtrigger').value.trim();
    const narr    = document.getElementById('wnarr').value.trim();
    const val     = document.getElementById('wval').value.trim();
    const impact  = document.getElementById('wimpact').value.trim();
    const cons    = document.getElementById('wcons').value.trim();
    const ins     = document.getElementById('wins').value.trim();
    const less    = document.getElementById('wless').value.trim();

    function hit(n) {
      return {
        f: document.getElementById(`h${n}f`).value.trim(),
        o: document.getElementById(`h${n}o`).value.trim(),
        s: document.getElementById(`h${n}s`).value.trim(),
        r: document.getElementById(`h${n}r`).value.trim()
      };
    }
    const hits = [1,2,3,4].map(hit);

    const lines = [];
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10);

    function isoWeek(d) {
      const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const day = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const week = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      return `${tmp.getUTCFullYear()}-W${String(week).padStart(2, '0')}`;
    }

    const weekStr = isoWeek(date);
    const domainTag = domain ? domain.toLowerCase() : '';

    lines.push('---');
    lines.push(`date: ${dateStr}`);
    lines.push(`week: ${weekStr}`);
    lines.push(`title: "${door || ''}"`);
    lines.push(`domain: ${domain || ''}`);
    lines.push(`subdomain: ${sub || ''}`);
    lines.push(`door: "${door || ''}"`);
    lines.push('door_uuid: ""');
    lines.push('profit_uuid: ""');
    lines.push('hit_uuids: ["", "", "", ""]');
    lines.push(`tags: [war-stack, door, production${domainTag ? ', ' + domainTag : ''}]`);
    lines.push('---');
    lines.push('');
    lines.push(`# War Stack - ${door || ''}`);
    lines.push('');
    lines.push('## Domain & Sub-domain');
    lines.push(`- Domain: ${domain || ''}`);
    lines.push(`- Sub-domain: ${sub || ''}`);
    lines.push('');
    lines.push('## Domino Door');
    lines.push(door || '');
    lines.push('');
    lines.push('## Trigger');
    lines.push(trigger || '');
    lines.push('');
    lines.push('## Narrative');
    lines.push(narr || '');
    lines.push('');
    lines.push('## Validation');
    lines.push(val || '');
    lines.push('');
    lines.push('## Impact of opening');
    lines.push(impact || '');
    lines.push('');
    lines.push('## Consequences of not opening');
    lines.push(cons || '');
    lines.push('');
    lines.push('---');
    lines.push('');
    lines.push('## The Four Hits');
    lines.push('');

    hits.forEach((h, idx) => {
      lines.push(`### Hit ${idx + 1}`);
      lines.push(`- Fact: ${h.f || ''}`);
      lines.push(`- Obstacle: ${h.o || ''}`);
      lines.push(`- Strike: ${h.s || ''}`);
      lines.push(`- Responsibility: ${h.r || 'Me'}`);
      lines.push('');
    });

    lines.push('---');
    lines.push('');
    lines.push('## Insights');
    lines.push(ins || '');
    lines.push('');
    lines.push('## Lessons');
    lines.push(less || '');
    lines.push('');
    lines.push('---');
    lines.push('');
    lines.push('## Taskwarrior UUIDs (Bridge/Taskwarrior)');
    lines.push('');
    lines.push('- Door UUID:');
    lines.push('- Profit UUID:');
    lines.push('- Hit 1 UUID:');
    lines.push('- Hit 2 UUID:');
    lines.push('- Hit 3 UUID:');
    lines.push('- Hit 4 UUID:');
    lines.push('');

  const md = lines.join('\n');
  const out = document.getElementById('waroutput');
  out.textContent = md;
  out.style.display = 'block';

  saveWarStackDraft_('submit');
  syncDoorToDrive('WarStack', md, title || '');
});
}

// ------------- 8) Hit List -------------
// ------------- Hit List aus War-Stack-Hits + Extras bauen -------------
function generateHitList() {
  const out   = document.getElementById('hitlistoutput');
  const extra = document.getElementById('hitlistextras');

  if (!out) return;

  // 1) Big Rocks = ausgewÃ¤hlte Hits
  const boxes = document.querySelectorAll('.hitselect:checked');
  const big   = [];

  boxes.forEach(b => {
    const idx = parseInt(b.getAttribute('data-idx'), 10);
    if (!isNaN(idx) && DOOR_HIT_CACHE[idx]) {
      big.push(DOOR_HIT_CACHE[idx]);
    }
  });

  // 2) Little Rocks & Sand aus Textarea
  const lines = (extra && extra.value)
    ? extra.value.split('\n').map(l => l.trim()).filter(Boolean)
    : [];

  const little = [];
  const sand   = [];

  lines.forEach(line => {
    let t = line;
    if (/^lr:/i.test(t)) {
      little.push(t.replace(/^lr:\s*/i, '').trim());
      return;
    }
    if (/^s:/i.test(t)) {
      sand.push(t.replace(/^s:\s*/i, '').trim());
      return;
    }
    // default: Little Rock
    little.push(t);
  });

  // 3) Markdown bauen
  const md = buildHitListMarkdown(big, little, sand);

  out.textContent = md;

  const meta = [
    'frame:Production',
    `big:${big.length}`,
    `little:${little.length}`,
    `sand:${sand.length}`,
    `total:${big.length + little.length + sand.length}`
  ].join(';');

  syncDoorToDrive('HitList', md, meta);
}

function buildHitListMarkdown(big, little, sand) {
  const lines = [];

  lines.push('# Weekly Jar â€“ Hit List');
  lines.push('');

  // Big Rocks aus War Stacks
  lines.push('## Big Rocks (aus War Stacks)');
  lines.push('');
  if (big && big.length) {
    big.forEach((h, i) => {
      const base = `${
        h.door ? h.door + ' â€“ ' : ''
      }${h.fact || ''}`.trim() || '(ohne Titel)';
      const strikePart = h.strike
        ? ` _(Strike: ${h.strike})_`
        : '';
      lines.push(`- [ ] Hit ${i + 1}: ${base}${strikePart}`);
    });
  } else {
    lines.push('(keine Big Rocks ausgewÃ¤hlt)');
  }
  lines.push('');

  // Little Rocks
  lines.push('## Little Rocks');
  lines.push('');
  if (little && little.length) {
    little.forEach((l, i) => {
      lines.push(`- [ ] LR${i + 1}: ${l}`);
    });
  } else {
    lines.push('(keine Little Rocks gesetzt)');
  }
  lines.push('');

  // Sand
  lines.push('## Sand (unvermeidbare Tasks)');
  lines.push('');
  if (sand && sand.length) {
    sand.forEach((s, i) => {
      lines.push(`- [ ] Sand ${i + 1}: ${s}`);
    });
  } else {
    lines.push('(kein Sand angegeben â€“ aber er wird kommen)');
  }
  lines.push('');
  lines.push('> Das Jar wird voll. Entscheide, womit.');

  return lines.join('\n');
}


// ------------- 9) Profit Review -------------
function collectProfitData_() {
  const val = (id) => {
    const el = document.getElementById(id);
    return el ? String(el.value || '').trim() : '';
  };

  const hits = [1, 2, 3, 4]
    .map(n => val(`profit-hit-${n}`))
    .filter(Boolean);

  const done = val('profit-done')
    .split('\n')
    .map(line => line.trim())
    .filter(Boolean);

  return {
    date: new Date().toISOString().slice(0, 10),
    door_opened: val('profit-door-opened'),
    door_obstacle: val('profit-door-obstacle'),
    profit_uuid: val('profit-uuid'),
    hits: hits,
    done: done,
    insight: val('profit-insight'),
    lesson: val('profit-lesson')
  };
}

function hasProfitContent_(data) {
  if (!data) return false;
  return Boolean(
    data.door_opened ||
    data.door_obstacle ||
    (data.hits && data.hits.length) ||
    (data.done && data.done.length) ||
    data.insight ||
    data.lesson
  );
}

function buildProfitMarkdown_(data) {
  const yesNo = data.door_opened || '-';
  const hits = data.hits && data.hits.length ? data.hits : [];
  const done = data.done && data.done.length ? data.done : [];

  const lines = [
    '---',
    `date: ${data.date}`,
    'tags: [door, profit, weekly]',
    '---',
    '',
    `# ðŸ DOOR PROFIT â€“ Weekly Wrap-Up (${data.date})`,
    '',
    '## ðŸšª Did you open the Door?',
    `**${yesNo}**`,
    ''
  ];

  if (yesNo === 'no' && data.door_obstacle) {
    lines.push('**Obstacle:**', data.door_obstacle, '');
  }

  lines.push('## âœ… Achieved Big Hits');
  if (hits.length) {
    hits.forEach((hit, idx) => lines.push(`- Hit ${idx + 1}: ${hit}`));
  } else {
    lines.push('- (keine Hits eingetragen)');
  }
  lines.push('');

  lines.push('## ðŸ“ Done List');
  if (done.length) {
    done.forEach(item => lines.push(`- ${item}`));
  } else {
    lines.push('- (keine Done Items eingetragen)');
  }
  lines.push('');

  lines.push('## ðŸ” Insight of the Week');
  lines.push(data.insight || '-');
  lines.push('');

  lines.push('## ðŸ“œ Lesson of the Week');
  lines.push(data.lesson || '-');
  lines.push('');

  return lines.join('\n');
}

function generateProfit() {
  const out = document.getElementById('profitoutput');
  const data = collectProfitData_();

  if (!hasProfitContent_(data)) {
    out.textContent = 'Bitte fÃ¼lle zumindest ein Feld aus.';
    out.style.display = 'block';
    return;
  }

  const md = buildProfitMarkdown_(data);
  out.textContent = md;
  out.style.display = 'block';

  syncDoorToDrive('Profit', md, data.date);

  if (typeof google !== 'undefined' && google.script && google.script.run) {
    data.userKey = doorGetUserKey_();
    google.script.run
      .withSuccessHandler(() => {
        setDoorStatus('Profit gespeichert (MD + JSON).');
        logDoorTerminal_('Profit: MD + JSON gespeichert');
      })
      .withFailureHandler(() => {
        setDoorStatus('Profit JSON speichern fehlgeschlagen.');
        logDoorTerminal_('Profit: JSON Fehler');
      })
      .door_saveProfitJson_(data, data.userKey);
  }
}

// LÃ¤dt Hot-Ideen aus /1-Potential/ (Code.gs â†’ getPotentialHotIdeas)
// und verteilt sie auf Hot-List-Panel + Door-War-Panel
function loadHotList(auto) {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    if (!auto) {
      setDoorStatus('Keine Verbindung zu Google Script â€“ nur online im GAS mÃ¶glich.');
    }
    return;
  }

  if (!auto) {
    setDoorStatus('Lade Hot-Ideen aus 1-Potential â€¦');
  }

  google.script.run
    .withSuccessHandler(function(res) {
      if (!res || !res.ok || !res.ideas || !res.ideas.length) {
        if (!auto) {
          setDoorStatus(res && res.error ? res.error : 'Keine Hot-Ideen im Drive gefunden.');
        }
        return;
      }

      DOOR_HOT_CACHE = res.ideas || [];

      // 1) Hot List Panel (Textarea + Ãœbersicht)
      renderHotListPanel(res);

      // 2) Door War Panel (Matrix Backlog)
      renderDoorWarFromIdeas(res.ideas || []);

      if (!auto) {
        setDoorStatus(res.count + ' Hot-Ideen aus 1-Potential geladen.');
      }
    })
    .withFailureHandler(function(err) {
      console.error('getPotentialHotIdeas-Fehler', err);
      if (!auto) {
        setDoorStatus('Fehler beim Laden der Hot List: ' + (err && err.message ? err.message : err));
      }
    })
    .getPotentialHotIdeas(doorGetUserKey_());
}
function renderHotListPanel(res) {
  const ideas = res.ideas || [];
  const ta = document.getElementById('hotlistinput');
  const container = document.getElementById('hotlist-import');

  // 1) Eine Idee pro Zeile im Textarea
  if (ta) {
    const lines = ideas.map(item => item.title);
    ta.value = lines.join('\n');
  }

  // 2) Ãœbersicht im Panel
  if (container) {
    if (!ideas.length) {
      container.innerHTML = '<i>Keine Hot-Ideen gefunden.</i>';
      return;
    }

    container.innerHTML = ideas.map(item => `
      <div style="margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #222;">
        <strong>${escapeHtml(item.title)}</strong><br>
        <small>
          <code>${escapeHtml(item.name)}</code><br>
          <a href="${item.url}" target="_blank" rel="noopener">im Drive Ã¶ffnen</a>
        </small>
      </div>
    `).join('');
  }
}
// ------------- X) Hits aus War Stacks laden -------------
function loadHitsFromWarStacks(auto) {
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    if (!auto) {
      setDoorStatus('Keine Verbindung zu Google Script â€“ nur online im GAS mÃ¶glich.');
    }
    return;
  }

  if (!auto) {
    setDoorStatus('Lade Hits aus War Stacks â€¦');
  }

  google.script.run
    .withSuccessHandler(function(res) {
      if (!res || !res.ok || !res.hits || !res.hits.length) {
        if (!auto) {
          setDoorStatus(
            (res && res.error)
              ? res.error
              : 'Keine War-Stack-Hits im Drive gefunden.'
          );
        }
        renderHitSelection([]); // Panel leeren
        return;
      }

      // Cache + Index
      DOOR_HIT_CACHE = (res.hits || []).map((h, i) => {
        h._idx = i;
        return h;
      });

      renderHitSelection(DOOR_HIT_CACHE);

      if (!auto) {
        setDoorStatus(res.hits.length + ' Hits aus War Stacks geladen.');
      }
    })
    .withFailureHandler(function(err) {
      console.error('listWarStackHits-Fehler', err);
      if (!auto) {
        setDoorStatus(
          'Fehler beim Laden der War-Stack-Hits: ' +
          (err && err.message ? err.message : err)
        );
      }
    })
    .listWarStackHits(doorGetUserKey_());
}

function renderHitSelection(hits) {
  const container = document.getElementById('hitlist-hits');
  if (!container) return;

  if (!hits || !hits.length) {
    container.innerHTML = '<i>Keine Hits gefunden.</i>';
    return;
  }

  // Gruppieren nach War-Stack-Titel
  const byStack = {};
  hits.forEach(h => {
    const key = h.title || 'Ohne Titel';
    if (!byStack[key]) byStack[key] = [];
    byStack[key].push(h);
  });

  let html = '';
  Object.keys(byStack).forEach(title => {
    html += `
      <div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #222;">
        <strong>${escapeHtml(title)}</strong><br>
    `;

    byStack[title].forEach(h => {
      const label = `${
        h.door ? h.door + ' â€“ ' : ''
      }${h.fact || '(kein Fact gesetzt)'}`;

      html += `
        <label style="display:block;font-size:12px;cursor:pointer;margin-top:4px;">
          <input type="checkbox"
                 class="hitselect"
                 data-idx="${h._idx}"
                 checked>
          <span>${escapeHtml(label)}</span>
        </label>
      `;
    });

    html += '</div>';
  });

  container.innerHTML = html;
}

// kleiner Helper (falls nicht schon vorhanden)
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}


// ------------- 10) Copy Helper -------------
function copyFromPre(id) {
  const pre = document.getElementById(id);
  if (!pre || !pre.textContent.trim()) {
    alert('Nichts zum Kopieren gefunden.');
    return;
  }

  const text = pre.textContent;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => setDoorStatus('In Zwischenablage kopiert.'))
      .catch(err => {
        console.error('Clipboard-Fehler', err);
        alert('Konnte nicht in die Zwischenablage kopieren.');
      });
  } else {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      setDoorStatus('In Zwischenablage kopiert.');
    } catch (e) {
      alert('Konnte nicht in die Zwischenablage kopieren.');
    }
    document.body.removeChild(ta);
  }
}
// Drag & Drop fÃ¼r Door War Matrix
function initDoorWarDragDrop() {
  const cards = document.querySelectorAll('.doorwar-card');
  const dropzones = document.querySelectorAll('.doorwar-dropzone');

  cards.forEach(card => {
    if (card.dataset.dragReady === '1') return;
    card.dataset.dragReady = '1';
    card.draggable = true;
    card.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', card.id);
    });
  });

  dropzones.forEach(zone => {
    if (zone.dataset.dropReady === '1') return;
    zone.dataset.dropReady = '1';
    zone.addEventListener('dragover', e => {
      e.preventDefault();
    });
    zone.addEventListener('drop', e => {
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const card = document.getElementById(id);
      if (card) {
        zone.appendChild(card);
        maybeMoveDoorCardToPlan_(card, zone.dataset.quad);
      }
    });
  });
}

function maybeMoveDoorCardToPlan_(card, quad) {
  if (!card || card.dataset.moved === '1') return;
  if (quad !== 'q1' && quad !== 'q2') return;
  const fileId = card.dataset.fileId;
  if (!fileId) return;
  if (typeof google === 'undefined' || !google.script || !google.script.run) return;

  google.script.run
    .withSuccessHandler(() => {
      card.dataset.moved = '1';
      setDoorStatus('In 2-Plan verschoben: ' + (card.dataset.title || ''));
    })
    .withFailureHandler(() => {
      setDoorStatus('Verschieben fehlgeschlagen.');
    })
    .doorMovePotentialToPlan([fileId], doorGetUserKey_());
}
// Call on Load
function initDoorWarDragDropOnReady() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDoorWarDragDrop);
  } else {
    initDoorWarDragDrop();
  }
}

initDoorWarDragDropOnReady();

</script>
