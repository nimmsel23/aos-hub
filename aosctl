#!/usr/bin/env bash
# aosctl - AOS Unified Control Interface
# ========================================
# Unified dispatcher for aos-hub components (index/router/bridge/sync/fire/centre/env/alias)

set -euo pipefail

APP="aosctl"
AOSCTL_VERSION="1.1.3"
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"

# If called via symlink from dotfiles, normalize to aos-hub
if [[ "$SCRIPT_DIR" == *".dotfiles"* ]]; then
  SCRIPT_DIR="$HOME/aos-hub"
fi
# If called via non-repo paths, prefer the repo checkout
if [[ "$SCRIPT_DIR" != "$HOME/aos-hub" && -d "$HOME/aos-hub/scripts" ]]; then
  SCRIPT_DIR="$HOME/aos-hub"
fi

# shellcheck disable=SC1090
source "$SCRIPT_DIR/scripts/ctl-lib.sh"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/scripts/lib/aos-env.sh"
aos_env_load "" "$SCRIPT_DIR" || true
: "${CTL_CHOOSE_PROMPT:=Œ±OS ‚Äî aosctl}"
: "${CTL_CHOOSE_PREFER:=gum}"
: "${CTL_UI_OK_PREFIX:=‚úî}"
: "${CTL_UI_ERR_PREFIX:=‚úò}"
: "${CTL_UI_WARN_PREFIX:=‚ö†}"

have() { command -v "$1" >/dev/null 2>&1; }

resolve_bin() {
  local primary="$1"; shift
  if [[ -n "$primary" && -x "$primary" ]]; then
    echo "$primary"; return 0
  fi
  for cand in "$@"; do
    if [[ -n "$cand" && -x "$cand" ]]; then
      echo "$cand"; return 0
    fi
  done
  if have "$primary"; then
    command -v "$primary"; return 0
  fi
  return 1
}

ROUTERCTL="$(resolve_bin "$SCRIPT_DIR/routerctl" "$SCRIPT_DIR/router/routerctl" || true)"
BRIDGECTL="$(resolve_bin "$SCRIPT_DIR/bridgectl" "$SCRIPT_DIR/bridge/bridgectl" || true)"
INDEXCTL="$(resolve_bin "$SCRIPT_DIR/scripts/indexctl" || true)"
SYNCVAULTCTL="$(resolve_bin "$SCRIPT_DIR/scripts/syncvaultctl" || true)"
SYNCCTL="$(resolve_bin "$SCRIPT_DIR/scripts/syncctl" "$SCRIPT_DIR/scripts/syncvaultctl" || true)"
AOS_DOCTOR="$(resolve_bin "$SCRIPT_DIR/scripts/aos-doctor" || true)"
ALIASCTL="$(resolve_bin "$SCRIPT_DIR/scripts/aos-aliasctl" || true)"
ENVCTL="$(resolve_bin "envctl" || true)"
FIREMAP_BIN="$(resolve_bin "$SCRIPT_DIR/firemap" || true)"
FIREMAP_SETUP="$(resolve_bin "$SCRIPT_DIR/scripts/setup-fire-map.sh" || true)"
FIRECTL_BIN="$(resolve_bin "$SCRIPT_DIR/scripts/firectl" || true)"
CORE4CTL="$(resolve_bin "core4ctl" "$SCRIPT_DIR/core4/python-core4/core4ctl" || true)"
FIREMAP_BOT_PY="$(resolve_bin "$SCRIPT_DIR/game/python-firemap/firemap_bot.py" || true)"
FRUITS_BIN="$(resolve_bin "${AOS_FRUITS_BIN:-}" "$SCRIPT_DIR/python-fruits/fruits" || true)"
CREATORKING_BIN="$(resolve_bin "${AOS_CREATORKING_BIN:-}" "$SCRIPT_DIR/python-creatorking/creatorking" || true)"
TENTCTL="$(resolve_bin "$SCRIPT_DIR/game/python-tent-bot/tentctl" || true)"
GASCTL="$(resolve_bin "$SCRIPT_DIR/scripts/gasctl" || true)"
BACKUPCTL="$(resolve_bin "$SCRIPT_DIR/scripts/backupctl" || true)"
MOUNTCTL="$(resolve_bin "$SCRIPT_DIR/scripts/mountctl" || true)"
HOOKCTL="$(resolve_bin "$SCRIPT_DIR/scripts/hookctl" || true)"
DOORCTL="$(resolve_bin "$SCRIPT_DIR/scripts/doorctl" || true)"
GAMECTL="$(resolve_bin "$SCRIPT_DIR/scripts/gamectl" || true)"
VOICECTL="$(resolve_bin "$SCRIPT_DIR/scripts/voicectl" || true)"
GITCTL="$(resolve_bin "$SCRIPT_DIR/scripts/gitctl" || true)"
AOS_CENTRES="${AOS_CENTRES_CMD:-$HOME/Œ±OS/bin/aos-centres}"
RCLONE_RC_URL="${AOS_RCLONE_RC_URL:-http://127.0.0.1:5572/}"

env_file_has_key() {
  local file="$1"
  local key="$2"
  [[ -f "$file" ]] || return 1
  awk -F= -v k="$key" '
    $0 !~ /^[[:space:]]*#/ {
      kk=$1
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", kk)
      if (kk == k) { found=1; exit 0 }
    }
    END { exit found ? 0 : 1 }
  ' "$file"
}

env_file_get_value() {
  local file="$1"
  local key="$2"
  [[ -f "$file" ]] || return 1
  awk -F= -v k="$key" '
    $0 !~ /^[[:space:]]*#/ {
      kk=$1
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", kk)
      if (kk == k) {
        vv=substr($0, index($0, "=")+1)
        gsub(/^[[:space:]]+|[[:space:]]+$/, "", vv)
        print vv
        exit 0
      }
    }
  ' "$file"
}

env_example_has_key() {
  local file="$1"
  local key="$2"
  [[ -f "$file" ]] || return 1
  awk -F= -v k="$key" '
    {
      line=$0
      sub(/^[[:space:]]*#?[[:space:]]*/, "", line)
      split(line, parts, "=")
      kk=parts[1]
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", kk)
      if (kk == k) { found=1; exit 0 }
    }
    END { exit found ? 0 : 1 }
  ' "$file"
}

env_var_nonempty() {
  local key="$1"
  [[ -n "${!key:-}" ]]
}

env_contract_rows() {
  cat <<EOF
index|$SCRIPT_DIR/scripts/indexctl||AOS_INDEX_USER_SERVICE AOS_INDEX_ENV_FILE AOS_INDEX_HEALTH_URL AOS_HUB_DOCTOR AOS_UI_BASIC_AUTH AOS_UI_BASIC_USER AOS_UI_BASIC_PASS AOS_UI_BASIC_REALM AOS_UI_BASIC_AUTH_PROTECT_API
router|$SCRIPT_DIR/router/routerctl||AOS_ENV_FILE
bridge|$SCRIPT_DIR/bridge/bridgectl||AOS_BRIDGE_ENV_FILE AOS_BRIDGE_URL AOS_BRIDGE_TOKEN AOS_BRIDGE_TOKEN_HEADER AOS_BRIDGE_HOST AOS_BRIDGE_PORT AOS_BRIDGE_TAILSCALE_PATH AOS_BRIDGE_TAILSCALE_TARGET
sync|$SCRIPT_DIR/scripts/syncctl||AOS_DRY_RUN AOS_COPY_LINKS AOS_SYNC_CONF_DIR AOS_SYNC_LOCK_DIR AOS_RCLONE_CONFIG AOS_RCLONE_REMOTE_NAME AOS_LOG_DIR AOS_LOG_LIMIT
git|$SCRIPT_DIR/scripts/gitctl||AOS_GIT_SILENT AOS_GIT_NOTIFY
backup|$SCRIPT_DIR/scripts/backupctl||AOS_HUB_DIR
mount|$SCRIPT_DIR/scripts/mountctl||AOS_CORE4_MOUNT_SERVICE AOS_VOICE_MOUNT_SERVICE AOS_DOOR_MOUNT_SERVICE AOS_GAME_MOUNT_SERVICE
hook|$SCRIPT_DIR/scripts/hookctl||AOS_HOOK_DIR AOS_HOOK_ENV_DIR AOS_HOOK_ENV_FILE AOS_HOOK_TARGET AOS_HOOK_TELE_BIN AOS_HOOK_TELE_FORMAT AOS_HOOK_TELE_INCLUDE_UUID AOS_HOOK_TELE_SILENT AOS_HOOK_CORE4_TELE_DONE AOS_CORE4_LOG AOS_CORE4_POINTS AOS_TASK_EXPORT_FILTER AOS_TASK_EXPORT_PATH AOS_TASK_EXPORT_VAULT_PATH AOS_TASK_EXPORT_COPY_TO_VAULT AOS_TASK_EXPORT_MIN_INTERVAL_SEC AOS_BRIDGE_URL
door|$SCRIPT_DIR/scripts/doorctl||AOS_VAULT_DIR AOS_DOOR_STALLED_DAYS
game|$SCRIPT_DIR/scripts/gamectl||AOS_GAME_MOUNT_SERVICE
voice|$SCRIPT_DIR/scripts/voicectl||AOS_VOICE_MOUNT_SERVICE
firectl|$SCRIPT_DIR/scripts/firectl||AOS_TASK_BIN AOS_PYTHON_BIN AOS_TASKRC AOS_VAULT_DIR AOS_FIRE_DIR AOS_FIREBOT_SCRIPT AOS_FIRE_ENV_FILE AOS_FIRE_GIT_DIR
gas|$SCRIPT_DIR/scripts/gasctl||AOS_GAS_WEBHOOK_URL AOS_GAS_TENT_DIR
EOF
}

env_contract_list() {
  local row component file required recommended
  msg "aosctl env contracts"
  while IFS='|' read -r component file required recommended; do
    [[ -n "$component" ]] || continue
    msg ""
    msg "[$component]"
    msg "  file: $file"
    msg "  required: ${required:-<none>}"
    msg "  recommended: ${recommended:-<none>}"
  done < <(env_contract_rows)
}

env_check_contracts() {
  local quiet="${1:-0}"
  local example_file="$SCRIPT_DIR/scripts/aos.env.example"
  local recommended_enabled="${AOS_ENV_CHECK_RECOMMENDED:-0}"

  local row component file required recommended key
  local required_missing=0
  local recommended_missing=0
  local contracts_checked=0

  declare -A seen_required_missing=()
  declare -A seen_recommended_missing=()
  declare -A seen_example_missing=()

  if [[ "$quiet" != "1" ]]; then
    msg ""
    msg "Env check: wrapped component contracts"
    msg "  aos env : ${AOS_ENV_FILE_EFFECTIVE:-<none loaded>}"
    msg "  example : $example_file"
  fi

  while IFS='|' read -r component file required recommended; do
    [[ -n "$component" ]] || continue
    if [[ ! -f "$file" ]]; then
      env_check_issue "contract file not found for ${component}: ${file}"
      continue
    fi
    contracts_checked=$((contracts_checked + 1))

    for key in $required; do
      [[ -n "$key" ]] || continue
      if ! env_var_nonempty "$key"; then
        if [[ -z "${seen_required_missing[$key]:-}" ]]; then
          env_check_issue "missing ${key} in loaded env (required by ${component})"
          seen_required_missing["$key"]=1
          required_missing=$((required_missing + 1))
        fi
      fi
      if ! env_example_has_key "$example_file" "$key"; then
        if [[ -z "${seen_example_missing[$key]:-}" ]]; then
          env_check_issue "missing ${key} in scripts/aos.env.example (declared by ${component})"
          seen_example_missing["$key"]=1
        fi
      fi
    done

    if [[ "$recommended_enabled" == "1" ]]; then
      for key in $recommended; do
        [[ -n "$key" ]] || continue
        if ! env_var_nonempty "$key"; then
          if [[ -z "${seen_recommended_missing[$key]:-}" ]]; then
            warn "not set ${key} (recommended by ${component})"
            seen_recommended_missing["$key"]=1
            recommended_missing=$((recommended_missing + 1))
          fi
        fi
        if ! env_example_has_key "$example_file" "$key"; then
          if [[ -z "${seen_example_missing[$key]:-}" ]]; then
            env_check_issue "missing ${key} in scripts/aos.env.example (declared by ${component})"
            seen_example_missing["$key"]=1
          fi
        fi
      done
    fi
  done < <(env_contract_rows)

  if [[ "$quiet" != "1" ]]; then
    msg "Contracts checked: ${contracts_checked}"
    msg "Required vars missing: ${required_missing}"
    if [[ "$recommended_enabled" == "1" ]]; then
      msg "Recommended vars missing: ${recommended_missing}"
    else
      msg "Recommended vars check: disabled (AOS_ENV_CHECK_RECOMMENDED=0)"
    fi
  fi
}

env_warn_missing_key() {
  local file="$1"
  local key="$2"
  env_file_has_key "$file" "$key" || env_check_issue "missing ${key} in ${file}"
}

env_check_issue() {
  local text="$1"
  warn "$text"
  ENV_CHECK_ISSUES=$((ENV_CHECK_ISSUES + 1))
}

env_run_check() {
  local quiet="${1:-0}"
  ENV_CHECK_ISSUES=0

  local user_service="${AOS_INDEX_USER_SERVICE:-aos-index-dev.service}"
  local user_unit="$HOME/.config/systemd/user/$user_service"
  local user_env="${AOS_INDEX_USER_ENV_FILE:-$HOME/.env/alphaos-index.env}"

  local sys_unit="/etc/systemd/system/aos-index.service"
  local sys_env="/etc/alphaos-hub/alphaos-index.env"
  local sys_global="/etc/alphaos-hub/aos.env"

  if [[ "$quiet" != "1" ]]; then
    msg "Env check: index user/system configuration"
    msg "  user unit : $user_unit"
    msg "  user env  : $user_env"
    msg "  sys unit  : $sys_unit"
    msg "  sys env   : $sys_env"
    msg "  sys aos   : $sys_global"
    msg ""
  fi

  # User service + user env checks
  if [[ -f "$user_unit" ]]; then
    grep -Fq "EnvironmentFile=-%h/.env/aos.env" "$user_unit" || \
      env_check_issue "missing EnvironmentFile=-%h/.env/aos.env in $user_unit"
    grep -Fq "EnvironmentFile=-%h/.env/alphaos-index.env" "$user_unit" || \
      env_check_issue "missing EnvironmentFile=-%h/.env/alphaos-index.env in $user_unit"
  else
    env_check_issue "user unit not found: $user_unit"
  fi

  if [[ -f "$user_env" ]]; then
    env_warn_missing_key "$user_env" "HOST"
    env_warn_missing_key "$user_env" "PORT"
    local uauth
    uauth="$(env_file_get_value "$user_env" "AOS_UI_BASIC_AUTH" 2>/dev/null || true)"
    if [[ "$uauth" == "1" ]]; then
      env_warn_missing_key "$user_env" "AOS_UI_BASIC_USER"
      env_warn_missing_key "$user_env" "AOS_UI_BASIC_PASS"
    fi
  else
    env_check_issue "user env not found: $user_env"
  fi

  # System service + system env checks (only when readable/installed)
  if [[ -f "$sys_unit" ]]; then
    if [[ -r "$sys_unit" ]]; then
      grep -Fq "EnvironmentFile=-/etc/alphaos-hub/env" "$sys_unit" || \
        env_check_issue "missing EnvironmentFile=-/etc/alphaos-hub/env in $sys_unit"
      grep -Fq "EnvironmentFile=-/etc/alphaos-hub/aos.env" "$sys_unit" || \
        env_check_issue "missing EnvironmentFile=-/etc/alphaos-hub/aos.env in $sys_unit"
      grep -Fq "EnvironmentFile=-/etc/alphaos-hub/alphaos-index.env" "$sys_unit" || \
        env_check_issue "missing EnvironmentFile=-/etc/alphaos-hub/alphaos-index.env in $sys_unit"
    else
      env_check_issue "system unit exists but is not readable: $sys_unit"
    fi
  else
    env_check_issue "system unit not found: $sys_unit"
  fi

  if [[ -f "$sys_global" ]]; then
    if [[ -r "$sys_global" ]]; then
      env_warn_missing_key "$sys_global" "AOS_INDEX_SERVICE"
    else
      env_check_issue "system global env exists but is not readable: $sys_global"
    fi
  else
    env_check_issue "system global env not found: $sys_global"
  fi

  if [[ -f "$sys_env" ]]; then
    if [[ -r "$sys_env" ]]; then
      env_warn_missing_key "$sys_env" "HOST"
      env_warn_missing_key "$sys_env" "PORT"
      local sauth
      sauth="$(env_file_get_value "$sys_env" "AOS_UI_BASIC_AUTH" 2>/dev/null || true)"
      if [[ "$sauth" == "1" ]]; then
        env_warn_missing_key "$sys_env" "AOS_UI_BASIC_USER"
        env_warn_missing_key "$sys_env" "AOS_UI_BASIC_PASS"
      fi
    else
      env_check_issue "system index env exists but is not readable: $sys_env"
    fi
  else
    env_check_issue "system index env not found: $sys_env"
  fi

  env_check_contracts "$quiet"

  if (( ENV_CHECK_ISSUES == 0 )); then
    if [[ "$quiet" != "1" ]]; then
      msg "Env check passed."
    fi
    return 0
  fi

  if [[ "$quiet" != "1" ]]; then
    warn "Env check found ${ENV_CHECK_ISSUES} issue(s)."
  fi
  return 1
}

show_help() {
  cat <<'__HELP__'
aosctl - AOS Unified Control Interface
=======================================

USAGE:
  aosctl <component> <action> [args...]
  aosctl                     # Env check + interactive menu
  aosctl menu                # Interactive menu (gum/fzf if available)
  aosctl status              # Unified status (no logs) + heartbeat ping
  aosctl ping                # Heartbeat ping (routerctl)
  aosctl doctor              # Unified health check
  aosctl version             # Show versions

COMPONENTS:
  hub         Index Node (Node.js server on :8799)
  index       Index Node (alias for hub)
  router      Router Bot (Telegram aiogram bot)
  bridge      Bridge Service (aiohttp on :8080)
  core4       Core4 tooling (scores/exports/timers)
  vault       Vault & Domain Sync (syncvaultctl - rclone)
  sync        Rclone sync control (syncctl)
  git         Git sync control (gitctl)
  fire        Fire Map scheduling + sync
  backup      Backup tooling (backupctl)
  mount       Rclone mounts (mountctl)
  hook        Taskwarrior hooks (hookctl)
  door        Door / War Stack tooling (doorctl)
  game        Game mount tooling (gamectl)
  voice       Voice mount tooling (voicectl)
  firectl     Fire bot wrapper (firectl)
  tentctl     Tent Bot manager (game/python-tent-bot)
  gas         GAS Tent Centre manager (gasctl)
  core4ctl    Core4 tooling (core4ctl)
  fruits      Fruits CLI (JSON store)
  creatorking CreatorKing CLI (JSON store)
  tent        Tent Bot manager (alias for tentctl)
  centre      Desktop centres (menu.yaml routing)
  env         Environment manager (envctl)
  alias       Alias manager (aos-aliasctl)
  bot         Telegram bot debug/test (via Bridge ‚Üí GAS)

COMMON ACTIONS (per component):
  start       Start the service
  stop        Stop the service
  restart     Restart the service
  status      Show service status
  logs        Show service logs
  health      Health check (if supported)

EXAMPLES:
  aosctl menu
  aosctl status
  aosctl hub status
  aosctl core4 status
  aosctl router status
  aosctl bridge logs
  aosctl vault status
  aosctl fire status
  aosctl sync status
  aosctl git status
  aosctl backup status
  aosctl mount status
  aosctl hook status
  aosctl door status
  aosctl game status
  aosctl voice status
  aosctl centre list
  aosctl env check
  aosctl env check --recommended
  aosctl env example
  aosctl env contracts
  aosctl env list
  aosctl alias ui

COMPONENT-SPECIFIC COMMANDS:
  aosctl centre add <title> <link> [cmd]
  aosctl centre open <cmd|url>
  aosctl centre boot
  aosctl fire help
  aosctl fruits           # run Fruits CLI
  aosctl creatorking      # run CreatorKing CLI
  aosctl bot send <bot> <text>    # send test message to GAS webhook via Bridge
__HELP__
}

show_menu() {
  ui_title "Œ±OS ‚Äî aosctl"

  local choices=()
  [[ -n "$INDEXCTL" ]] && choices+=("Index: status")
  [[ -n "$ROUTERCTL" ]] && choices+=("Router: status")
  [[ -n "$BRIDGECTL" ]] && choices+=("Bridge: status")
  [[ -n "$CORE4CTL" ]] && choices+=("Core4: status")
  [[ -n "$SYNCCTL" ]] && choices+=("Sync: status")
  [[ -n "$GITCTL" ]] && choices+=("Git: status")
  [[ -n "$FIREMAP_BIN" ]] && choices+=("Fire: status")
  [[ -n "$BACKUPCTL" ]] && choices+=("Backup: status")
  [[ -n "$MOUNTCTL" ]] && choices+=("Mounts: status")
  [[ -n "$HOOKCTL" ]] && choices+=("Hooks: status")
  [[ -n "$DOORCTL" ]] && choices+=("Door: status")
  [[ -n "$GAMECTL" ]] && choices+=("Game: status")
  [[ -n "$VOICECTL" ]] && choices+=("Voice: status")
  choices+=("Env: check")
  choices+=("Env: contracts")
  choices+=("Env: example")
  [[ -n "$ENVCTL" ]] && choices+=("Env: list")
  [[ -n "$ALIASCTL" ]] && choices+=("Aliases: ui")
  choices+=("Status" "Ping" "Doctor" "Help" "Quit")

  local choice
  choice="$(choose "${choices[@]}")" || return 0

  case "$choice" in
    "Index: status") "$INDEXCTL" status ;;
    "Router: status") "$ROUTERCTL" status ;;
    "Bridge: status") "$BRIDGECTL" status ;;
    "Core4: status") "$CORE4CTL" status ;;
    "Sync: status") "$SYNCCTL" status ;;
    "Git: status") "$GITCTL" status ;;
    "Fire: status") fire_cmd status ;;
    "Backup: status") "$BACKUPCTL" status ;;
    "Mounts: status") "$MOUNTCTL" status ;;
    "Hooks: status") "$HOOKCTL" status ;;
    "Door: status") "$DOORCTL" status ;;
    "Game: status") "$GAMECTL" status ;;
    "Voice: status") "$VOICECTL" status ;;
    "Env: check") env_cmd check ;;
    "Env: contracts") env_cmd contracts ;;
    "Env: example") env_cmd example ;;
    "Env: list") env_cmd list ;;
    "Aliases: ui") alias_cmd ui ;;
    "Status") run_status ;;
    "Ping") run_ping ;;
    "Doctor") run_doctor ;;
    "Help") show_help ;;
    "Quit") return 0 ;;
    *) return 0 ;;
  esac
}

show_version() {
  msg "aosctl version: v${AOSCTL_VERSION}"
  msg ""
  msg "Component versions:"

  if [[ -n "$INDEXCTL" ]]; then
    msg "  index:  $($INDEXCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  index:  not installed"
  fi

  if [[ -n "$ROUTERCTL" ]]; then
    msg "  router: $($ROUTERCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  router: not installed"
  fi

  if [[ -n "$BRIDGECTL" ]]; then
    msg "  bridge: $($BRIDGECTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  bridge: not installed"
  fi

  if [[ -n "$SYNCCTL" ]]; then
    msg "  sync:   $($SYNCCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  sync:   not installed"
  fi

  if [[ -n "$GITCTL" ]]; then
    msg "  git:    $($GITCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  git:    not installed"
  fi

  if [[ -n "$ENVCTL" ]]; then
    msg "  envctl: $($ENVCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  envctl: not installed"
  fi

  if [[ -n "$ALIASCTL" ]]; then
    msg "  alias:  $($ALIASCTL version 2>/dev/null || echo 'unknown')"
  else
    msg "  alias:  not installed"
  fi

  if [[ -n "$CORE4CTL" ]]; then
    msg "  core4:  $CORE4CTL"
  else
    msg "  core4:  not installed"
  fi

  msg ""
}

run_status() {
  msg "Œ±OS status (no logs)"
  msg ""

  if [[ -n "$INDEXCTL" ]]; then
    msg "=== indexctl ==="
    "$INDEXCTL" status || true
    msg ""
  else
    warn "indexctl not found"
  fi

  if [[ -n "$ROUTERCTL" ]]; then
    msg "=== routerctl ==="
    "$ROUTERCTL" status || true
    msg ""
  else
    warn "routerctl not found"
  fi

  if [[ -n "$BRIDGECTL" ]]; then
    msg "=== bridgectl ==="
    "$BRIDGECTL" status || true
    msg ""
  else
    warn "bridgectl not found"
  fi

  if [[ -n "$SYNCCTL" ]]; then
    msg "=== syncctl ==="
    "$SYNCCTL" status || true
    msg ""
  else
    warn "syncctl not found"
  fi

  if [[ -n "$GITCTL" ]]; then
    msg "=== gitctl ==="
    "$GITCTL" status || true
    msg ""
  else
    warn "gitctl not found"
  fi

  msg "=== rclone backend ==="
  if have curl; then
    if curl --max-time 1 -fsS "$RCLONE_RC_URL" >/dev/null 2>&1; then
      msg "Status: rClone Backend is connected and working as expected"
    else
      msg "Status: rClone Backend unreachable"
    fi
    msg "Current IP Address: $RCLONE_RC_URL"
    msg ""
  else
    warn "curl not found (cannot check rclone backend)"
  fi

  if [[ -n "$FIREMAP_BIN" ]]; then
    msg "=== firemap ==="
    "$FIREMAP_BIN" status || true
    msg ""
  else
    warn "firemap not found"
  fi

  if [[ -n "$BACKUPCTL" ]]; then
    msg "=== backupctl ==="
    "$BACKUPCTL" status || true
    msg ""
  else
    warn "backupctl not found"
  fi

  if [[ -n "$MOUNTCTL" ]]; then
    msg "=== mountctl ==="
    "$MOUNTCTL" status || true
    msg ""
  else
    warn "mountctl not found"
  fi

  if [[ -n "$HOOKCTL" ]]; then
    msg "=== hookctl ==="
    "$HOOKCTL" status || true
    msg ""
  else
    warn "hookctl not found"
  fi

  if [[ -n "$DOORCTL" ]]; then
    msg "=== doorctl ==="
    "$DOORCTL" status || true
    msg ""
  else
    warn "doorctl not found"
  fi

  if [[ -n "$GAMECTL" ]]; then
    msg "=== gamectl ==="
    "$GAMECTL" status || true
    msg ""
  else
    warn "gamectl not found"
  fi

  if [[ -n "$VOICECTL" ]]; then
    msg "=== voicectl ==="
    "$VOICECTL" status || true
    msg ""
  else
    warn "voicectl not found"
  fi

  if [[ -n "$ENVCTL" ]]; then
    msg "=== envctl ==="
    "$ENVCTL" list || true
    msg ""
  else
    warn "envctl not found"
  fi

  if [[ -n "$ALIASCTL" ]]; then
    msg "=== aliasctl ==="
    "$ALIASCTL" doctor 2>/dev/null || true
    msg ""
  else
    warn "aos-aliasctl not found"
  fi

  if [[ -n "$CORE4CTL" ]]; then
    msg "=== core4ctl ==="
    "$CORE4CTL" status || true
    msg ""
  fi

  if [[ -n "$ROUTERCTL" ]]; then
    msg "=== heartbeat ==="
    "$ROUTERCTL" heartbeat ping || true
    msg ""
  fi
}

run_ping() {
  if [[ -n "$ROUTERCTL" ]]; then
    "$ROUTERCTL" heartbeat ping || true
  else
    die "routerctl not found"
  fi
}

run_doctor() {
  if [[ -n "$AOS_DOCTOR" ]]; then
    "$AOS_DOCTOR"
    return 0
  fi

  msg "Running basic health checks..."
  msg ""

  if [[ -n "$INDEXCTL" ]]; then
    msg "=== indexctl ==="
    "$INDEXCTL" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "indexctl not found"
  fi

  if [[ -n "$ROUTERCTL" ]]; then
    msg "=== routerctl ==="
    "$ROUTERCTL" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "routerctl not found"
  fi

  if [[ -n "$BRIDGECTL" ]]; then
    msg "=== bridgectl ==="
    "$BRIDGECTL" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "bridgectl not found"
  fi

  if [[ -n "$SYNCCTL" ]]; then
    msg "=== syncctl ==="
    "$SYNCCTL" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "syncctl not found"
  fi

  if [[ -n "$GITCTL" ]]; then
    msg "=== gitctl ==="
    "$GITCTL" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "gitctl not found"
  fi

  if [[ -n "$FIREMAP_BIN" ]]; then
    msg "=== firemap ==="
    "$FIREMAP_BIN" status 2>&1 || msg "  ‚ö†Ô∏è  Not running"
    msg ""
  else
    warn "firemap not found"
  fi

  msg "üí° For detailed diagnostics, install aos-doctor at:"
  msg "   $SCRIPT_DIR/scripts/aos-doctor"
}

route_component() {
  local component="$1"
  shift || true

  case "$component" in
    hub|index)
      [[ -n "$INDEXCTL" ]] || die "indexctl not found"
      "$INDEXCTL" "$@"
      ;;
    core4|core4ctl)
      core4_cmd "$@"
      ;;
    router)
      [[ -n "$ROUTERCTL" ]] || die "routerctl not found"
      "$ROUTERCTL" "$@"
      ;;
    bridge)
      [[ -n "$BRIDGECTL" ]] || die "bridgectl not found"
      "$BRIDGECTL" "$@"
      ;;
    vault)
      [[ -n "$SYNCCTL" ]] || die "syncctl not found"
      "$SYNCCTL" vault "$@"
      ;;
    sync)
      [[ -n "$SYNCCTL" ]] || die "syncctl not found"
      "$SYNCCTL" "$@"
      ;;
    git)
      [[ -n "$GITCTL" ]] || die "gitctl not found"
      "$GITCTL" "$@"
      ;;
    backup)
      [[ -n "$BACKUPCTL" ]] || die "backupctl not found"
      "$BACKUPCTL" "$@"
      ;;
    mount)
      [[ -n "$MOUNTCTL" ]] || die "mountctl not found"
      "$MOUNTCTL" "$@"
      ;;
    hook|hooks)
      [[ -n "$HOOKCTL" ]] || die "hookctl not found"
      "$HOOKCTL" "$@"
      ;;
    door|doorctl)
      [[ -n "$DOORCTL" ]] || die "doorctl not found"
      "$DOORCTL" "$@"
      ;;
    game|gamectl)
      [[ -n "$GAMECTL" ]] || die "gamectl not found"
      "$GAMECTL" "$@"
      ;;
    voice|voicectl)
      [[ -n "$VOICECTL" ]] || die "voicectl not found"
      "$VOICECTL" "$@"
      ;;
    firectl)
      [[ -n "$FIRECTL_BIN" ]] || die "firectl not found"
      "$FIRECTL_BIN" "$@"
      ;;
    tent|tentctl)
      [[ -n "$TENTCTL" ]] || die "tentctl not found at $SCRIPT_DIR/game/python-tent-bot/tentctl"
      "$TENTCTL" "$@"
      ;;
    gas|gasctl)
      [[ -n "$GASCTL" ]] || die "gasctl not found at $SCRIPT_DIR/scripts/gasctl"
      "$GASCTL" "$@"
      ;;
    env)
      env_cmd "$@"
      ;;
    alias)
      alias_cmd "$@"
      ;;
    *)
      ui_err "Unknown component: $component"
      msg ""
      msg "Available components: hub, index, router, bridge, core4, vault, sync, git, fire, backup, mount, hook, door, game, voice, tent, gas, centre, env, alias"
      msg "Run 'aosctl help' for usage"
      exit 1
      ;;
  esac
}

core4_cmd() {
  [[ -n "$CORE4CTL" ]] || die "core4ctl not found (expected at ~/aos-hub/core4/python-core4/core4ctl)"
  local action="${1:-status}"
  shift || true
  case "$action" in
    menu) "$CORE4CTL" menu ;;
    status|build|install-timers) "$CORE4CTL" "$action" "$@" ;;
    export-daily|daily-csv) "$CORE4CTL" export-daily "$@" ;;
    prune|prune-events) "$CORE4CTL" prune "$@" ;;
    finalize-month|seal-month|month-close) "$CORE4CTL" finalize-month "$@" ;;
    finalize-week|seal-week) "$CORE4CTL" finalize-week "$@" ;;
    ""|-h|--help|help) "$CORE4CTL" help ;;
    *) die "Unknown core4 action: $action" ;;
  esac
}

fire_cmd() {
  local sub="${1:-}"
  shift || true

  case "$sub" in
    menu)
      [[ -n "$FIRECTL_BIN" ]] || die "firectl not found"
      "$FIRECTL_BIN" menu
      ;;
    print|build|send)
      [[ -n "$FIRECTL_BIN" ]] || die "firectl not found"
      "$FIRECTL_BIN" "$sub" "$@"
      ;;
    setup-reports|setup-systemd|install-cli|uninstall-cli|doctor)
      [[ -n "$FIRECTL_BIN" ]] || die "firectl not found"
      "$FIRECTL_BIN" "$sub" "$@"
      ;;

    setup)
      [[ -n "$FIREMAP_SETUP" ]] || die "firemap setup script missing"
      "$FIREMAP_SETUP" "$@"
      ;;
    run|sync)
      [[ -n "$FIREMAP_BIN" ]] || die "firemap not found"
      "$FIREMAP_BIN" sync "$@"
      ;;
    status)
      [[ -n "$FIREMAP_BIN" ]] || die "firemap not found"
      "$FIREMAP_BIN" status
      ;;
    list)
      [[ -n "$FIREMAP_BIN" ]] || die "firemap not found"
      "$FIREMAP_BIN" list
      ;;
    enable)
      systemctl --user enable --now alphaos-firemap-weekly.timer
      ;;
    disable)
      systemctl --user disable --now alphaos-firemap-weekly.timer
      ;;
    start)
      systemctl --user start alphaos-firemap-weekly.timer
      ;;
    stop)
      systemctl --user stop alphaos-firemap-weekly.timer
      ;;
    logs)
      journalctl --user -u alphaos-firemap-weekly.service -n 200 -f
      ;;
    bot-test)
      [[ -n "$FIREMAP_BOT_PY" ]] || die "python firemap bot not found"
      python "$FIREMAP_BOT_PY" test --text "${1:-}" ;;
    ""|-h|--help|help)
      cat <<'__FIRE__'
aosctl fire ‚Äî Fire tooling (daily/weekly bot output + Fire Map sync)

Daily/Weekly (Taskwarrior ‚Üí Telegram via `tele`):
  aosctl fire menu
  aosctl fire print daily|weekly
  aosctl fire build daily|weekly
  aosctl fire send  daily|weekly
  aosctl fire setup-reports     # install TaskRC reports fired/firew
  aosctl fire setup-systemd     # install + enable daily/weekly send timers

Fire Map sync (legacy):
  aosctl fire setup        # install Taskwarrior config + weekly timer
  aosctl fire enable       # enable + start weekly timer
  aosctl fire disable      # disable + stop weekly timer
  aosctl fire start|stop   # start/stop weekly timer
  aosctl fire status       # show Fire Map status (current week)
  aosctl fire list         # list Fire Maps
  aosctl fire run|sync     # sync Fire Maps to Taskwarrior now
  aosctl fire logs         # follow weekly sync logs

Firemap Python bot (direct Telegram API / optional tele):
  aosctl fire bot-test "<text>"
__FIRE__
      ;;
    *)
      die "Unknown fire command: $sub"
      ;;
  esac
}

env_cmd() {
  local sub="${1:-check}"
  shift || true
  case "$sub" in
    check|doctor|validate)
      local recommended="${AOS_ENV_CHECK_RECOMMENDED:-0}"
      local arg=""
      for arg in "$@"; do
        case "$arg" in
          --recommended|--all)
            recommended=1
            ;;
          --no-recommended)
            recommended=0
            ;;
          *)
            die "Usage: aosctl env check [--recommended|--all|--no-recommended]"
            ;;
        esac
      done
      AOS_ENV_CHECK_RECOMMENDED="$recommended" env_run_check 0
      ;;
    contracts|spec|vars)
      env_contract_list
      ;;
    example|init-example)
      local template="$SCRIPT_DIR/scripts/aos.env.example"
      [[ -f "$template" ]] || die "missing template: $template"

      local dst="${AOS_ENV_EXAMPLE_FILE:-}"
      local force=0
      local arg=""
      for arg in "$@"; do
        case "$arg" in
          -f|--force)
            force=1
            ;;
          *)
            if [[ -z "$dst" ]]; then
              dst="$arg"
            else
              die "Usage: aosctl env example [dest-file] [--force]"
            fi
            ;;
        esac
      done

      if [[ -z "$dst" ]]; then
        if [[ -d "$SCRIPT_DIR/.env" || -L "$SCRIPT_DIR/.env" ]]; then
          dst="$SCRIPT_DIR/.env/aos.env.example"
        else
          dst="$HOME/.env/aos.env.example"
        fi
      fi

      mkdir -p "$(dirname "$dst")"
      if [[ -e "$dst" && "$force" != "1" ]]; then
        warn "env example exists: $dst (use --force to overwrite)"
        return 0
      fi

      cp "$template" "$dst"
      msg "env example written: $dst"
      ;;
    *)
      [[ -n "$ENVCTL" ]] || die "envctl not found (only 'aosctl env check' is available without envctl)"
      "$ENVCTL" "$sub" "$@"
      ;;
  esac
}

alias_cmd() {
  [[ -n "$ALIASCTL" ]] || die "aos-aliasctl not found"
  "$ALIASCTL" "${@:-ui}"
}

fruits_cmd() {
  [[ -n "$FRUITS_BIN" ]] || die "fruits CLI not found (set AOS_FRUITS_BIN or install $SCRIPT_DIR/python-fruits/fruits)"
  "$FRUITS_BIN" "$@"
}

creatorking_cmd() {
  [[ -n "$CREATORKING_BIN" ]] || die "creatorking CLI not found (set AOS_CREATORKING_BIN or install $SCRIPT_DIR/python-creatorking/creatorking)"
  "$CREATORKING_BIN" "$@"
}

centre_cmd() {
  local action="${1:-}"
  shift || true

  [[ -x "$AOS_CENTRES" ]] || die "aos-centres not found at: $AOS_CENTRES"

  case "$action" in
    add)
      if [[ $# -lt 2 ]]; then
        die "Usage: aosctl centre add <title> <link> [cmd]"
      fi
      "$AOS_CENTRES" add "$@"
      ;;
    open|boot|list|init)
      "$AOS_CENTRES" "$action" "$@"
      ;;
    *)
      die "Unknown centre action: $action"
      ;;
  esac
}

bot_cmd() {
  local action="${1:-}"
  shift || true

  case "$action" in
    send)
      local bot="${1:-}"
      shift || true
      [[ -n "$bot" ]] || die "Usage: aosctl bot send <bot> <text>"
      [[ $# -gt 0 ]] || die "Usage: aosctl bot send <bot> <text>"

      local bot_upper
      bot_upper="$(printf "%s" "$bot" | tr '[:lower:]' '[:upper:]')"

      local webhook=""
      local chat_id=""
      local user_id=""
      if [[ "$bot" == "hq" ]]; then
        webhook="${AOS_GAS_WEBHOOK_URL:-}"
        chat_id="${AOS_GAS_CHAT_ID:-}"
        user_id="${AOS_GAS_USER_ID:-}"
      else
        webhook="$(eval "printf '%s' \"\${AOS_${bot_upper}_WEBHOOK_URL:-}\"")"
        chat_id="$(eval "printf '%s' \"\${AOS_${bot_upper}_CHAT_ID:-}\"")"
        user_id="$(eval "printf '%s' \"\${AOS_${bot_upper}_USER_ID:-}\"")"
      fi

      [[ -n "$webhook" ]] || die "Missing webhook URL for bot '$bot' (set AOS_${bot_upper}_WEBHOOK_URL or AOS_GAS_WEBHOOK_URL for hq)"

      local bridge_url="${AOS_BRIDGE_URL:-http://127.0.0.1:8080/bridge}"
      bridge_url="${bridge_url%/}"
      local endpoint="${bridge_url}/telegram/send"

      local token_header="${AOS_BRIDGE_TOKEN_HEADER:-X-Bridge-Token}"
      local token="${AOS_BRIDGE_TOKEN:-}"

      local text="$*"
      local payload
      payload="$(AOS_TELE_TEXT="$text" AOS_TELE_CHAT_ID="$chat_id" AOS_TELE_USER_ID="$user_id" AOS_TELE_WEBHOOK_URL="$webhook" \
        python3 - <<'PY'
import json
import os

payload = {
    "text": os.environ.get("AOS_TELE_TEXT", ""),
    "chat_id": os.environ.get("AOS_TELE_CHAT_ID", ""),
    "user_id": os.environ.get("AOS_TELE_USER_ID", ""),
    "webhook_url": os.environ.get("AOS_TELE_WEBHOOK_URL", ""),
}
print(json.dumps(payload))
PY
      )"

      if [[ -n "$token" ]]; then
        curl -sS -X POST "$endpoint" \
          -H "Content-Type: application/json" \
          -H "$token_header: $token" \
          -d "$payload"
      else
        curl -sS -X POST "$endpoint" \
          -H "Content-Type: application/json" \
          -d "$payload"
      fi
      echo ""
      ;;
    *)
      die "Usage: aosctl bot send <bot> <text>"
      ;;
  esac
}

main() {
  if [[ $# -eq 0 ]]; then
    env_run_check 0 || true
    show_menu
    exit 0
  fi

  local cmd="$1"
  shift || true

  case "$cmd" in
    menu) env_run_check 0 || true; show_menu ;;
    status) run_status ;;
    ping) run_ping ;;
    help|-h|--help) show_help ;;
    version|-v|--version) show_version ;;
    doctor|doc) run_doctor ;;
    centre|centres|center|centers) centre_cmd "$@" ;;
    hub|index|router|bridge|core4|core4ctl|vault|sync|git|backup|mount|hook|hooks|door|doorctl|game|gamectl|voice|voicectl|firectl|tent|tentctl|gas|gasctl|env|alias) route_component "$cmd" "$@" ;;
    fire) fire_cmd "$@" ;;
    fruits) fruits_cmd "$@" ;;
    creatorking) creatorking_cmd "$@" ;;
    bot) bot_cmd "$@" ;;
    *)
      ui_err "Unknown command: $cmd"
      msg ""
      msg "Run 'aosctl help' for usage"
      exit 1
      ;;
  esac
}

main "$@"
