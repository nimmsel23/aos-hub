#!/usr/bin/env bash
set -euo pipefail

# bridgectl â€” thin dispatcher
# Keep this file small; real logic lives in:
#   - bridge-servicectl (systemd/env)
#   - bridge-apictl     (HTTP endpoints)
#   - bridge-tsctl      (tailscale serve/funnel/status)

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$APP_DIR/.." && pwd)"

# Codex session helper: bridgectl codex [purpose...]
# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/codex-subcmd.sh"
codex_subcmd_maybe "main" "bridgectl" "$@" && exit 0

# shellcheck disable=SC1090
source "$APP_DIR/bridge-lib.sh"

SYNCVAULTCTL_BIN="${SYNCVAULTCTL_BIN:-$ROOT_DIR/scripts/syncvaultctl}"
HEARTBEAT_BIN="${HEARTBEAT_BIN:-$ROOT_DIR/scripts/heartbeat}"
ROUTERCTL_BIN="${ROUTERCTL_BIN:-$ROOT_DIR/router/routerctl}"
SYSTEMSTATUSCTL_BIN="${SYSTEMSTATUSCTL_BIN:-$ROOT_DIR/scripts/systemstatusctl}"
ENV_FILE="${AOS_BRIDGE_ENV_FILE:-$HOME/.env/bridge.env}"

servicectl() { exec "$APP_DIR/bridge-servicectl" "$@"; }
apictl() { exec "$APP_DIR/bridge-apictl" "$@"; }
tsctl() { exec "$APP_DIR/bridge-tsctl" "$@"; }

syncvaultctl_cmd() {
  if [[ -x "$SYNCVAULTCTL_BIN" ]]; then
    echo "$SYNCVAULTCTL_BIN"
    return 0
  fi
  if has_cmd syncvaultctl; then
    echo "syncvaultctl"
    return 0
  fi
  return 1
}

run_syncvaultctl() {
  local cmd
  cmd="$(syncvaultctl_cmd)" || die "syncvaultctl not found"
  exec "$cmd" "$@"
}

routerctl_cmd() {
  if [[ -x "$ROUTERCTL_BIN" ]]; then
    echo "$ROUTERCTL_BIN"
    return 0
  fi
  if has_cmd routerctl; then
    command -v routerctl
    return 0
  fi
  return 1
}

heartbeat_cmd() {
  if [[ -x "$HEARTBEAT_BIN" ]]; then
    echo "$HEARTBEAT_BIN"
    return 0
  fi
  if has_cmd heartbeat; then
    command -v heartbeat
    return 0
  fi
  local bin
  bin="$(routerctl_cmd)" || return 1
  echo "$bin"
  return 0
}

run_heartbeat() {
  local sub="${1:-status}"; shift || true
  local bin
  bin="$(heartbeat_cmd)" || die "heartbeat not available"
  if [[ "$bin" == *routerctl ]]; then
    exec "$bin" heartbeat "$sub" "$@"
  fi
  exec "$bin" "$sub" "$@"
}

systemstatusctl_cmd() {
  if [[ -x "$SYSTEMSTATUSCTL_BIN" ]]; then
    echo "$SYSTEMSTATUSCTL_BIN"
    return 0
  fi
  if has_cmd systemstatusctl; then
    command -v systemstatusctl
    return 0
  fi
  return 1
}

run_systemstatus() {
  local bin
  bin="$(systemstatusctl_cmd)" || die "systemstatusctl not found"
  exec "$bin" trigger "$@"
}

doctor() {
  ui_title "bridgectl doctor"

  local rc=0
  if ! "$APP_DIR/bridge-servicectl" status; then
    rc=1
  fi
  msg ""

  "$APP_DIR/bridge-tsctl" status || true
  msg ""

  "$APP_DIR/bridge-apictl" health || true
  msg ""

  "$APP_DIR/bridge-apictl" debug || true

  return "$rc"
}

menu() {
  ui_title "bridgectl"
  local action
  action="$(choose \
    "service status" "service logs" "service restart" "service enable" "service env" \
    "systemd diagnose" "systemd fix" \
    "api health" "api debug" "api doctor" "api test-rpc" "api flush" \
    "api sync-status" "api sync-pull" "api sync-push" "api sync-pull (dry-run)" "api sync-push (dry-run)" "api sync-abort" \
    "syncvaultctl menu" "syncvaultctl status" "syncvaultctl sync" "syncvaultctl pull" \
    "gas systemstatus" \
    "heartbeat status" "heartbeat ping" "heartbeat logs" \
    "tailscale status" "tailscale serve" "tailscale funnel" \
    "doctor" "quit")"

  case "$action" in
    "service status") servicectl status ;;
    "service logs") servicectl logs ;;
    "service restart") servicectl restart ;;
    "service enable") servicectl enable ;;
    "service env") servicectl env ;;

    "systemd diagnose") servicectl diagnose ;;
    "systemd fix") servicectl fix ;;

    "api health") apictl health ;;
    "api debug") apictl debug ;;
    "api doctor") apictl doctor ;;
    "api test-rpc") apictl test-rpc ;;
    "api flush") apictl flush ;;
    "api sync-status") apictl sync-status ;;
    "api sync-pull") apictl sync-pull ;;
    "api sync-push") apictl sync-push ;;
    "api sync-pull (dry-run)") apictl sync-pull --dry-run ;;
    "api sync-push (dry-run)") apictl sync-push --dry-run ;;
    "api sync-abort") apictl sync-abort ;;

    "syncvaultctl menu") run_syncvaultctl menu ;;
    "syncvaultctl status") run_syncvaultctl status ;;
    "syncvaultctl sync") run_syncvaultctl sync ;;
    "syncvaultctl pull") run_syncvaultctl pull ;;

    "gas systemstatus") run_systemstatus ;;

    "heartbeat status") run_heartbeat status ;;
    "heartbeat ping") run_heartbeat ping ;;
    "heartbeat logs") run_heartbeat logs ;;

    "tailscale status") tsctl status ;;
    "tailscale serve") tsctl serve ;;
    "tailscale funnel") tsctl funnel ;;

    doctor) doctor ;;
    quit) exit 0 ;;
  esac
}

usage() {
  cat <<EOF
Usage: bridgectl <command>

Core:
  bridgectl menu
  bridgectl doctor
  bridgectl diagnose
  bridgectl fix [--yes]

Service:
  bridgectl status|enable|start|stop|restart|logs|env

API:
  bridgectl health|debug|doctor|test-rpc|flush
  bridgectl sync-status|sync-pull|sync-push|sync-abort

Tailscale:
  bridgectl tailscale|serve|funnel

Other:
  bridgectl syncvaultctl <args...>
  bridgectl heartbeat <cmd>
  bridgectl systemstatus

Env:
  AOS_BRIDGE_ENV_FILE (default: ~/.env/bridge.env)
EOF
}

cmd="${1:-menu}"
shift || true

case "$cmd" in
  -h|--help|help) usage ;;
  menu) menu ;;
  doctor) doctor ;;

  status|enable|start|stop|restart|logs|env|install-deps|link-service|diagnose|fix)
    servicectl "$cmd" "$@"
    ;;

  health|debug|test-rpc|flush|sync-status|sync-pull|sync-push|sync-abort)
    apictl "$cmd" "$@"
    ;;
  doctor-api|api-doctor) apictl doctor ;;

  tailscale) tsctl status ;;
  serve) tsctl serve ;;
  funnel) tsctl funnel ;;

  syncvaultctl) run_syncvaultctl "$@" ;;
  heartbeat) run_heartbeat "${1:-status}" "${@:2}" ;;
  systemstatus) run_systemstatus "$@" ;;

  *)
    usage
    exit 1
    ;;
esac
