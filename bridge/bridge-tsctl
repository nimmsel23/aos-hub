#!/usr/bin/env bash
set -euo pipefail

APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck disable=SC1090
source "$APP_DIR/bridge-lib.sh"

ENV_FILE="${AOS_BRIDGE_ENV_FILE:-$HOME/.env/bridge.env}"
load_env_file_if_present "$ENV_FILE"
bridge_recompute_config

tailscale_status() {
  if ! has_cmd tailscale; then
    warn "tailscale not installed"
    return 1
  fi
  msg "Tailscale status:"
  tailscale status || true
  msg ""
  msg "Tailscale IPs:"
  tailscale ip -4 || true
  tailscale ip -6 || true
  msg ""
  msg "Tailscale serve status:"
  tailscale serve status || true
  msg ""
  msg "Tailscale funnel status:"
  tailscale funnel status || true
  if has_cmd systemctl; then
    systemctl status tailscaled --no-pager || true
  fi
}

tailscale_serve_bridge() {
  if ! has_cmd tailscale; then
    warn "tailscale not installed"
    return 1
  fi
  msg "Tailscale serve (tailnet-only):"
  msg "  path:   $TS_PATH"
  msg "  target: $TS_TARGET"
  tailscale serve --bg --set-path "$TS_PATH" "$TS_TARGET"
  msg ""
  tailscale serve status || true
}

tailscale_funnel_bridge() {
  if ! has_cmd tailscale; then
    warn "tailscale not installed"
    return 1
  fi
  msg "Tailscale funnel (public):"
  msg "  path:   $TS_PATH"
  msg "  target: $TS_TARGET"
  tailscale funnel --bg --set-path "$TS_PATH" "$TS_TARGET"
  msg ""
  tailscale funnel status || true
}

usage() {
  cat <<EOF
bridge-tsctl

Usage: bridge-tsctl <command>

Commands:
  status
  serve
  funnel
EOF
}

cmd="${1:-status}"
shift || true

case "$cmd" in
  -h|--help|help) usage ;;
  status) tailscale_status ;;
  serve) tailscale_serve_bridge ;;
  funnel) tailscale_funnel_bridge ;;
  *) usage; exit 1 ;;
esac

