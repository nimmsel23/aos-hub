<script>
  const state = { data: null, answers: {} };
  const USER_KEY = "<?= userKey ?>";

  function fruitsGetUserKey_() {
    try {
      if (USER_KEY && String(USER_KEY).trim()) return String(USER_KEY).trim();
    } catch (_) {}
    try {
      return String(localStorage.getItem("aos_fruits_user_key") || "").trim();
    } catch (_) {
      return "";
    }
  }

  function fruitsRedirectToKey_(key) {
    const k = String(key || "").trim();
    if (!k) return false;
    try { localStorage.setItem("aos_fruits_user_key", k); } catch (_) {}
    try {
      const url = new URL(window.location.href);
      url.searchParams.set("k", k);
      window.location.replace(url.toString());
      return true;
    } catch (_) {
      return false;
    }
  }

  function fruitsEnsureUserKey_(onReady) {
    const current = fruitsGetUserKey_();
    if (current && String(USER_KEY || "").trim()) {
      try { localStorage.setItem("aos_fruits_user_key", current); } catch (_) {}
      if (typeof onReady === "function") onReady();
      return;
    }
    if (current && !String(USER_KEY || "").trim()) {
      if (fruitsRedirectToKey_(current)) return;
    }

    if (!(window.google && google.script && google.script.run)) {
      if (typeof onReady === "function") onReady();
      return;
    }

    google.script.run
      .withSuccessHandler((res) => {
        const key = res && res.userKey ? String(res.userKey || "").trim() : "";
        if (!key) {
          if (typeof onReady === "function") onReady();
          return;
        }
        fruitsRedirectToKey_(key);
      })
      .withFailureHandler(() => {
        if (typeof onReady === "function") onReady();
      })
      .fruits_registerAnonUser();
  }

  function showOverlay(on, title = '') {
    const overlay = document.getElementById('loading-overlay');
    if (!overlay) return;
    if (title) {
      const t = overlay.querySelector('.loading-title');
      if (t) t.textContent = title;
    }
    overlay.classList.toggle('active', !!on);
  }

	  function randEmoji() {
	    const e = (state.data && state.data.emojis) || [];
	    return e.length ? e[Math.floor(Math.random() * e.length)] : 'üçé';
	  }

	  function escapeHtml(text) {
	    return String(text || "")
	      .replace(/&/g, "&amp;")
	      .replace(/</g, "&lt;")
	      .replace(/>/g, "&gt;")
	      .replace(/\"/g, "&quot;")
	      .replace(/'/g, "&#039;");
	  }

	  function boot() {
	    showOverlay(true, 'Loading Facts...');
      const userKey = fruitsGetUserKey_();
	    google.script.run
      .withSuccessHandler(p => {
        state.data = p;
        state.answers = p.answers || {};
        render();
        setTimeout(() => showOverlay(false), 900);
      })
      .withFailureHandler(err => {
        console.error(err);
        alert('Fehler beim Laden der Facts');
        showOverlay(false);
      })
      .fruits_getAllData(userKey);
  }

  function render() {
    const data = state.data;
    if (!data) return;
    const allAnswers = state.answers || {};
    const pendingSkip = data.skipped && data.skipped.question;
    const container = document.getElementById('content');
    container.innerHTML = '';

    const sections = (Array.isArray(data.sectionOrder) && data.sectionOrder.length)
      ? data.sectionOrder
      : Object.keys(data.questions || {});

    let currentFound = false;
    let allDone = true;
    let qIndex = 0;

	    for (const section of sections) {
	      const secDiv = document.createElement('div');
	      secDiv.className = 'section';

	      const header = document.createElement('div');
	      header.className = 'section-header';
	      header.innerHTML = `${randEmoji()} <strong>${escapeHtml(section)}</strong> ${randEmoji()}`;
	      secDiv.appendChild(header);

	      for (const q of (data.questions[section] || [])) {
	        const qDiv = document.createElement('div');
	        qDiv.className = 'question';
	        const safeQ = escapeHtml(q);
          qIndex += 1;
          const label = `${qIndex}. ${safeQ}`;

	        if (allAnswers[q]) {
	          if (allAnswers[q] === '_geskippt_') {
	            allDone = false;
	            qDiv.classList.add('skipped');
	            qDiv.innerHTML = `<strong>${label}</strong><br><br><em>Geskippt ‚Äì bitte sp√§ter beantworten.</em>`;

            const textarea = document.createElement('textarea');
            textarea.placeholder = 'Antwort nachholen...';
            textarea.rows = 6;
            qDiv.appendChild(textarea);

            const saveSkippedBtn = document.createElement('button');
            saveSkippedBtn.textContent = 'Geskippte Frage beantworten';
            saveSkippedBtn.onclick = () => {
              const ans = textarea.value.trim();
              if (!ans) {
                alert('Bitte Antwort eingeben, um den Skip zu schlie√üen.');
                return;
              }
              google.script.run
                .withSuccessHandler(res => {
                  if (res && res.ok === false) {
                    alert(res.error || 'Speichern fehlgeschlagen.');
                    return;
                  }
                  boot();
                })
                .fruits_saveAnswer(section, q, ans, fruitsGetUserKey_());
            };
            qDiv.appendChild(saveSkippedBtn);
	          } else {
	            qDiv.classList.add('answered');
	            qDiv.innerHTML = `<strong>${label}</strong><br><br>${escapeHtml(allAnswers[q]).replace(/\n/g, '<br>')}`;
	          }
	        } else {
	          allDone = false;

	            if (!currentFound) {
	              currentFound = true;
	              qDiv.innerHTML = `<strong class="active-question">${randEmoji()} ${label} ${randEmoji()}</strong>`;

            const textarea = document.createElement('textarea');
            textarea.placeholder = "Raw & Honest Facts ‚Äì no illusions...";
            textarea.rows = 10;
            qDiv.appendChild(textarea);

            const saveBtn = document.createElement('button');
            saveBtn.textContent = "FACT ‚Äì Save";
            saveBtn.onclick = () => {
              const ans = textarea.value.trim();
              if (!ans) {
                alert("Keine Antwort ‚Äì du kannst skippen oder ehrlich sein.");
                return;
              }
              google.script.run
                .withSuccessHandler(res => {
                  if (res && res.ok === false) {
                    alert(res.error || 'Speichern fehlgeschlagen.');
                    return;
                  }
                  boot();
                })
                .fruits_saveAnswer(section, q, ans, fruitsGetUserKey_());
            };
            qDiv.appendChild(saveBtn);

            const skipBtn = document.createElement('button');
            skipBtn.textContent = "Skip (sp√§ter nachholen)";
            skipBtn.style.background = "#666";
            skipBtn.style.marginLeft = "10px";
            if (pendingSkip) {
              skipBtn.disabled = true;
              skipBtn.title = 'Ein Skip ist noch offen ‚Äì bitte zuerst beantworten.';
              skipBtn.style.opacity = '0.6';
              skipBtn.style.cursor = 'not-allowed';
            }
            skipBtn.onclick = () => {
              if (pendingSkip) {
                alert('Du hast bereits eine Frage geskipped. Bitte beantworte sie zuerst.');
                return;
              }
              if (confirm("Diese Frage √ºberspringen? Du kannst sp√§ter zur√ºck.")) {
                google.script.run
                .withSuccessHandler(res => {
                  if (res && res.ok === false) {
                    alert(res.error || 'Skip fehlgeschlagen.');
                    return;
                  }
                  boot();
                })
                  .fruits_saveAnswer(section, q, '_geskippt_', fruitsGetUserKey_());
              }
            };
            qDiv.appendChild(skipBtn);
	          } else {
	            qDiv.innerHTML = `<em>${label}<br><small>(wird freigeschaltet, wenn alle vorherigen beantwortet sind)</small></em>`;
	          }
	        }

        secDiv.appendChild(qDiv);
      }
      container.appendChild(secDiv);
    }

    if (allDone || Object.keys(allAnswers).length > 0) {
      const exportBtn = document.getElementById('exportBtn');
      exportBtn.style.display = 'block';
      exportBtn.onclick = exportAll;
    }
  }

  function exportAll() {
    showOverlay(true, 'Exportiere Map...');
    const userKey = fruitsGetUserKey_();
    google.script.run
      .withSuccessHandler(res => {
        showOverlay(false);
        alert(`Export gespeichert:\n${res.name}\n${res.url}`);
      })
      .withFailureHandler(err => {
        showOverlay(false);
        console.error(err);
        alert('Export fehlgeschlagen.');
      })
      .fruits_exportCompleteMap(userKey);
  }

  window.addEventListener('load', () => {
    setTimeout(() => showOverlay(false), 1200);
    fruitsEnsureUserKey_(boot);
  });
</script>
