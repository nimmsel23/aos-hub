#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# tentctl — GAS Tent Centre Manager
# ============================================================
# Manages standalone GAS Tent Centre deployment
#
# Commands:
#   deploy      Push code to GAS via clasp
#   status      Check GAS deployment status
#   webhook     Manage Telegram webhook
#   test        Run smoke tests
#   logs        Show GAS execution logs (via clasp)
#   open        Open GAS editor in browser
#   url         Show deployment URL
#   props       Show/set Script Properties
#
# ============================================================

TENTCTL_VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"

# Paths
CLASP_JSON="$SCRIPT_DIR/.clasp.json"
GAS_SCRIPT_ID=""

# Read script ID from .clasp.json if exists
if [[ -f "$CLASP_JSON" ]]; then
  GAS_SCRIPT_ID=$(jq -r '.scriptId // empty' "$CLASP_JSON" 2>/dev/null || true)
fi

# Colors
has_gum() { command -v gum >/dev/null 2>&1; }
ui_title() { has_gum && gum style --bold --border normal --padding "1 2" "tentctl" || echo "=== tentctl ==="; }
ui_info()  { has_gum && gum style --faint "$*" || echo "$*"; }
ui_ok()    { has_gum && gum style --foreground 10 "✔ $*" || echo "✔ $*"; }
ui_err()   { has_gum && gum style --foreground 9  "✘ $*" || echo "✘ $*"; }
ui_warn()  { has_gum && gum style --foreground 11 "⚠ $*" || echo "⚠ $*"; }

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    ui_err "Missing: $1"
    [[ "$1" == "clasp" ]] && ui_info "Install: npm install -g @google/clasp"
    [[ "$1" == "jq" ]] && ui_info "Install: sudo pacman -S jq"
    exit 1
  }
}

show_help() {
  cat << 'EOF'
tentctl - GAS Tent Centre Manager
==================================

USAGE:
  tentctl <command> [args...]

COMMANDS:
  deploy       Push code to GAS via clasp
  status       Check deployment status
  webhook      Manage Telegram webhook
    set        Set webhook
    info       Show webhook info
    delete     Delete webhook
  test         Run smoke tests
    backend    Test backend only
    ticktick   Test TickTick connection
    digest     Test digest builder
    full       Full smoke test
  logs         Show GAS execution logs
  open         Open GAS editor in browser
  edit         Open GAS editor (alias for open)
  url          Show deployment URL
  props        Manage Script Properties
    show       Show all properties
    set        Set a property
  doctor       Health check
  version      Show version

EXAMPLES:
  tentctl deploy
  tentctl status
  tentctl webhook set
  tentctl test full
  tentctl logs
  tentctl open

EOF
}

check_clasp() {
  need_cmd clasp
  if [[ ! -f "$CLASP_JSON" ]]; then
    ui_err ".clasp.json not found"
    ui_info "Expected: $CLASP_JSON"
    exit 1
  fi
  if [[ -z "$GAS_SCRIPT_ID" ]]; then
    ui_err "No scriptId in .clasp.json"
    exit 1
  fi
}

cmd_deploy() {
  ui_title
  ui_info "Deploying to GAS..."

  check_clasp

  cd "$SCRIPT_DIR"
  clasp push --force

  ui_ok "Code pushed to GAS"
  ui_info "Script ID: $GAS_SCRIPT_ID"
  ui_info ""
  ui_info "Next steps:"
  ui_info "1. tentctl props set   # Set Script Properties"
  ui_info "2. Deploy Web App in GAS editor"
  ui_info "3. tentctl webhook set"
}

cmd_status() {
  ui_title

  check_clasp

  ui_info "Script ID: $GAS_SCRIPT_ID"
  ui_info ""

  # Check files
  cd "$SCRIPT_DIR"
  ui_info "Tracked files:"
  clasp status | grep "└─" | sed 's/^/  /'

  ui_ok "Status check complete"
}

cmd_webhook() {
  local action="${1:-info}"

  check_clasp

  case "$action" in
    set)
      ui_info "Setting Telegram webhook..."
      ui_warn "This requires:"
      ui_info "1. TELEGRAM_BOT_TOKEN in Script Properties"
      ui_info "2. TENT_WEBAPP_URL in Script Properties"
      ui_info ""
      ui_info "Run this in GAS editor:"
      ui_info "  setTentWebhook()"
      ;;
    info)
      ui_info "Getting webhook info..."
      ui_info "Run this in GAS editor:"
      ui_info "  getTentWebhookInfo()"
      ;;
    delete)
      ui_warn "Deleting webhook..."
      ui_info "Run this in GAS editor:"
      ui_info "  deleteTentWebhook()"
      ;;
    *)
      ui_err "Unknown webhook action: $action"
      ui_info "Usage: tentctl webhook {set|info|delete}"
      exit 1
      ;;
  esac
}

cmd_test() {
  local test_type="${1:-full}"

  check_clasp

  ui_title
  ui_info "Test type: $test_type"
  ui_info ""

  case "$test_type" in
    backend)
      ui_info "Run in GAS editor:"
      ui_info "  statusTent()"
      ;;
    ticktick)
      ui_info "Run in GAS editor:"
      ui_info "  ticktickSmokeTest()"
      ;;
    digest)
      ui_info "Run in GAS editor:"
      ui_info "  testBuildDigest()"
      ;;
    full)
      ui_info "Run in GAS editor:"
      ui_info "  tentSetupSmokeTest()"
      ui_info ""
      ui_info "Or run individually:"
      ui_info "  statusTent()"
      ui_info "  ticktickSmokeTest()"
      ui_info "  testBuildDigest()"
      ;;
    *)
      ui_err "Unknown test: $test_type"
      ui_info "Usage: tentctl test {backend|ticktick|digest|full}"
      exit 1
      ;;
  esac
}

cmd_logs() {
  check_clasp

  ui_info "Opening GAS logs..."
  ui_info "Logs are in browser, opening project..."

  local url="https://script.google.com/d/$GAS_SCRIPT_ID/edit"
  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$url"
  elif command -v open >/dev/null 2>&1; then
    open "$url"
  else
    ui_info "Open manually: $url"
    ui_info "Then: Executions → View executions"
  fi
}

cmd_open() {
  check_clasp

  local url="https://script.google.com/d/$GAS_SCRIPT_ID/edit"
  ui_info "Opening GAS editor: $url"

  if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$url"
  elif command -v open >/dev/null 2>&1; then
    open "$url"
  else
    echo "$url"
  fi
}

cmd_url() {
  check_clasp

  ui_info "GAS Project URLs:"
  ui_info ""
  ui_info "Editor:"
  echo "  https://script.google.com/d/$GAS_SCRIPT_ID/edit"
  ui_info ""
  ui_info "Deployment URL:"
  ui_warn "  (Get from: Deploy → Manage deployments → Web app URL)"
  ui_info ""
  ui_info "Script ID:"
  echo "  $GAS_SCRIPT_ID"
}

cmd_props() {
  local action="${1:-show}"

  check_clasp

  case "$action" in
    show)
      ui_info "Script Properties (configured in GAS):"
      ui_info ""
      ui_info "Run in GAS editor to view:"
      ui_info "  checkTentProperties()"
      ui_info ""
      ui_info "Or manually:"
      ui_info "Project Settings → Script properties"
      ;;
    set)
      ui_info "Setting Script Properties..."
      ui_info ""
      ui_info "1. Open GAS editor:"
      ui_info "   tentctl open"
      ui_info ""
      ui_info "2. Run this function:"
      ui_info "   setupTentProperties()"
      ui_info ""
      ui_info "3. Edit the tokens/URLs in the function"
      ui_info "4. Run it"
      ui_info ""
      ui_info "See: SETUP_PROPERTIES.js for details"
      ;;
    *)
      ui_err "Unknown props action: $action"
      ui_info "Usage: tentctl props {show|set}"
      exit 1
      ;;
  esac
}

cmd_doctor() {
  ui_title
  ui_info "Running health checks..."
  ui_info ""

  # 1. Check .clasp.json
  if [[ -f "$CLASP_JSON" ]]; then
    ui_ok ".clasp.json found"
  else
    ui_err ".clasp.json missing"
  fi

  # 2. Check script ID
  if [[ -n "$GAS_SCRIPT_ID" ]]; then
    ui_ok "Script ID: $GAS_SCRIPT_ID"
  else
    ui_err "No script ID"
  fi

  # 3. Check clasp
  if command -v clasp >/dev/null 2>&1; then
    ui_ok "clasp installed: $(clasp --version 2>&1 | head -1 || echo 'unknown')"
  else
    ui_err "clasp not installed"
    ui_info "Install: npm install -g @google/clasp"
  fi

  # 4. Check files
  local required_files=(
    "backend.gs"
    "config.gs"
    "webapp.gs"
    "ticktick_functions.gs"
    "ticktick_fetch.gs"
    "tent_digest.gs"
    "telegram_bot.gs"
    "Index.html"
    "appsscript.json"
  )

  local missing=0
  for f in "${required_files[@]}"; do
    if [[ -f "$SCRIPT_DIR/$f" ]]; then
      ui_ok "$f"
    else
      ui_err "$f missing"
      ((missing++))
    fi
  done

  ui_info ""
  if [[ $missing -eq 0 ]]; then
    ui_ok "All files present"
  else
    ui_err "$missing files missing"
  fi

  ui_info ""
  ui_info "For full test, run in GAS editor:"
  ui_info "  tentSetupSmokeTest()"
}

cmd_version() {
  echo "tentctl version $TENTCTL_VERSION"
  if command -v clasp >/dev/null 2>&1; then
    clasp --version 2>&1 | head -1 || true
  fi
}

# Main
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  deploy)    cmd_deploy "$@" ;;
  status)    cmd_status "$@" ;;
  webhook)   cmd_webhook "$@" ;;
  test)      cmd_test "$@" ;;
  logs)      cmd_logs "$@" ;;
  open|edit) cmd_open "$@" ;;
  url)       cmd_url "$@" ;;
  props)     cmd_props "$@" ;;
  doctor)    cmd_doctor "$@" ;;
  version)   cmd_version "$@" ;;
  help|--help|-h) show_help ;;
  *)
    ui_err "Unknown command: $COMMAND"
    show_help
    exit 1
    ;;
esac
